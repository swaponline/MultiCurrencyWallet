name: Deploy Multi Currency Wallet

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Generate version
        id: version
        run: |
          VERSION="2.$(date -u +%y.%m%d)"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Update version in plugin files
        run: |
          # Update plugin header version
          sed -i "s/^ \* Version: .*/ * Version: ${{ env.VERSION }}/" wordpress/multi-currency-wallet-pro.php

          # Update MCWALLET_VER constant
          sed -i "s/define( 'MCWALLET_VER', '.*' );/define( 'MCWALLET_VER', '${{ env.VERSION }}' );/" wordpress/multi-currency-wallet-pro.php

          echo "Updated wordpress/multi-currency-wallet-pro.php:"
          grep -E "Version:|MCWALLET_VER" wordpress/multi-currency-wallet-pro.php

      - name: Install dependencies
        run: npm install

      - name: Build mainnet widget
        run: |
          npm run build:mainnet-widget
          if [ ! -d "build-mainnet-widget" ]; then
            echo "Error: build-mainnet-widget directory not found"
            exit 1
          fi
          echo "✓ Mainnet widget build completed"
          ls -la build-mainnet-widget/ | head -10

      - name: Build testnet widget
        run: |
          npm run build:testnet-widget
          if [ ! -d "build-testnet-widget" ]; then
            echo "Error: build-testnet-widget directory not found"
            exit 1
          fi
          echo "✓ Testnet widget build completed"
          ls -la build-testnet-widget/ | head -10

      - name: Copy builds to wordpress/vendors/swap
        run: |
          # Copy mainnet build
          mkdir -p wordpress/vendors/swap
          cp -r build-mainnet-widget/* wordpress/vendors/swap/

          # Copy testnet build
          mkdir -p wordpress/vendors/swap/testnet
          cp -r build-testnet-widget/* wordpress/vendors/swap/testnet/

          echo "✓ Builds copied to wordpress/vendors/swap"
          ls -la wordpress/vendors/swap/ | head -10

      - name: Create info.json
        run: |
          cat > info.json << 'ENDJSON'
          {
            "name": "Multi Currency Wallet Pro",
            "version": "${{ env.VERSION }}",
            "tested": "6.7",
            "requires": "5.0",
            "requires_php": "7.4",
            "download_url": "https://farm.wpmix.net/updates/mcw-v${{ env.VERSION }}.zip",
            "last_updated": "$(date -u +"%Y-%m-%d %H:%M:%S")",
            "sections": {
              "description": "Simplest Multi-currency wallet for WordPress - supports Bitcoin, Ethereum, and ERC20/BEP20 tokens with exchange",
              "installation": "Upload the plugin files to /wp-content/plugins/multi-currency-wallet-pro/, then activate the plugin through the Plugins menu in WordPress",
              "changelog": "<h4>${{ env.VERSION }}</h4><ul><li>$(echo '${{ github.event.head_commit.message }}' | head -1)</li></ul>"
            }
          }
          ENDJSON

          # Fix shell variable expansion in JSON
          sed -i "s/\$(date -u +\"%Y-%m-%d %H:%M:%S\")/$(date -u +"%Y-%m-%d %H:%M:%S")/" info.json

          echo "Generated info.json:"
          cat info.json | python3 -m json.tool || cat info.json

      - name: Create WordPress plugin package
        run: |
          echo "Creating WordPress plugin package..."

          # Create package directory with plugin subdirectory (WordPress standard)
          mkdir -p mcw-package/multi-currency-wallet-pro

          # Copy all WordPress plugin files from wordpress/ directory
          echo "Copying WordPress plugin files..."
          cp -r wordpress/* mcw-package/multi-currency-wallet-pro/

          # Copy additional files if they exist
          if [ -f "README.md" ]; then
            cp README.md mcw-package/multi-currency-wallet-pro/
          fi
          if [ -f "LICENSE" ]; then
            cp LICENSE mcw-package/multi-currency-wallet-pro/
          fi

          # Verify structure
          echo "Package structure:"
          ls -la mcw-package/multi-currency-wallet-pro/ | head -20

          # Create ZIP (from package directory, so multi-currency-wallet-pro/ is the root in ZIP)
          cd mcw-package
          zip -r ../mcw-v${{ env.VERSION }}.zip multi-currency-wallet-pro
          cd ..

          # Verify ZIP
          if [ ! -f "mcw-v${{ env.VERSION }}.zip" ]; then
            echo "Error: ZIP file not created"
            exit 1
          fi

          echo "Package created: mcw-v${{ env.VERSION }}.zip"
          ls -lh mcw-v${{ env.VERSION }}.zip
          echo "ZIP contents:"
          unzip -l mcw-v${{ env.VERSION }}.zip | head -30

      - name: Upload to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "mcw-v${{ env.VERSION }}.zip,info.json"
          target: "/home/walletwpmixnet/incoming/"

      - name: Deploy info.json to updates directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            UPDATES_DIR="/home/farmFactory/web/farm.wpmix.net/public_html/updates"
            mkdir -p "$UPDATES_DIR"

            cp /home/walletwpmixnet/incoming/info.json "$UPDATES_DIR/mcw-info.json"
            chmod 644 "$UPDATES_DIR/mcw-info.json"

            echo "mcw-info.json updated:"
            cat "$UPDATES_DIR/mcw-info.json"

      - name: Deploy WordPress plugin ZIP to updates directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            UPDATES_DIR="/home/farmFactory/web/farm.wpmix.net/public_html/updates"
            mkdir -p "$UPDATES_DIR"

            # Move ZIP file from incoming to shared updates directory
            mv /home/walletwpmixnet/incoming/mcw-v${{ env.VERSION }}.zip \
               "$UPDATES_DIR/"

            chmod 644 "$UPDATES_DIR/mcw-v${{ env.VERSION }}.zip"

            echo "WordPress plugin package deployed:"
            ls -lh "$UPDATES_DIR/mcw-v${{ env.VERSION }}.zip"

      - name: Health check
        run: |
          echo "Waiting 10 seconds for deployment to settle..."
          sleep 10

          # Check if info.json is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://farm.wpmix.net/updates/mcw-info.json || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "✓ Health check passed (HTTP $HTTP_CODE)"
          else
            echo "⚠ Warning: Health check returned HTTP $HTTP_CODE (non-blocking)"
          fi

      - name: Notify completion
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✓ Multi Currency Wallet deployment complete"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Version: ${{ env.VERSION }}"
          echo "Package: mcw-v${{ env.VERSION }}.zip"
          echo "Info: https://farm.wpmix.net/updates/mcw-info.json"
          echo "Download: https://farm.wpmix.net/updates/mcw-v${{ env.VERSION }}.zip"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Notify failure
        if: failure()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✗ Multi Currency Wallet deployment failed"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Version: ${{ env.VERSION }}"
          echo "Check workflow logs for details"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
