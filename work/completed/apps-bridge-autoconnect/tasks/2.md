---
status: done
depends_on: []
wave: 1
skills: [code-writing]
verify: bash
reviewers: [code-reviewer, test-reviewer]
teammate_name:
---

# Task 2: Create unifactory bridge utils module

## Required Skills

Перед выполнением задачи загрузи:
- `/skill:code-writing` — [skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

**CRITICAL WARNING:** This task creates files in the **unifactory repository** (`noxonsu/unifactory`), NOT in the MultiCurrencyWallet repository. The unifactory codebase is a separate external repo. You'll need to create these files based on the spec, referencing the tech-spec for the expected API and behavior.

Create a new utility module `src/utils/walletBridge.ts` in the unifactory repository that provides reusable functions for bridge detection, bridge client loading, and bridge ready state polling. This module will be used by hooks and components to implement auto-connect functionality when the dApp is loaded inside MCW's Apps iframe.

The module solves three key problems:
1. **Bridge detection** - Determine if the dApp is running in bridge mode (iframe with URL parameter)
2. **Dynamic script loading** - Load the bridge client from the wallet host dynamically
3. **Ready state polling** - Wait for the bridge to complete its handshake before attempting auto-connect

This is a foundational task that other tasks depend on. It provides the building blocks for the auto-connect flow without modifying existing hooks or components yet.

## What to do

1. Create `src/utils/walletBridge.ts` with three exported functions: `detectBridgeMode()`, `loadBridgeClient(referrer)`, and `waitForBridgeReady(timeout)`

2. Implement `detectBridgeMode()` to check both URL parameter (`?walletBridge=swaponline`) and iframe context (`window.parent !== window`)

3. Implement `loadBridgeClient(referrer)` to dynamically create a script tag, extract wallet host from referrer, and provide fallback to mainnet URL

4. Implement `waitForBridgeReady(timeout)` to poll `window.ethereum.isConnected()` until ready or timeout

5. Create `src/utils/walletBridge.test.ts` with comprehensive unit tests covering all three functions and their edge cases

6. Ensure TypeScript types are properly defined for all function signatures and return values

## TDD Anchor

Write tests BEFORE implementation. Tests should fail initially, then pass after code is written.

- `src/utils/walletBridge.test.ts::detectBridgeMode with both conditions true` - Returns `{ isBridgeMode: true }` when URL has `?walletBridge=swaponline` AND `window.parent !== window`
- `src/utils/walletBridge.test.ts::detectBridgeMode with URL param only` - Returns `{ isBridgeMode: false }` when URL has param but NOT in iframe
- `src/utils/walletBridge.test.ts::detectBridgeMode with iframe only` - Returns `{ isBridgeMode: false }` when in iframe but URL has no param
- `src/utils/walletBridge.test.ts::loadBridgeClient extracts referrer host` - Script src constructed from `document.referrer` origin
- `src/utils/walletBridge.test.ts::loadBridgeClient fallback URL` - Uses `https://swaponline.github.io` when referrer is empty
- `src/utils/walletBridge.test.ts::waitForBridgeReady resolves when connected` - Promise resolves when `window.ethereum.isConnected()` returns true
- `src/utils/walletBridge.test.ts::waitForBridgeReady timeout` - Promise rejects after timeout if bridge never ready

## Acceptance Criteria

- [ ] File src/utils/walletBridge.ts exists and exports three functions: detectBridgeMode, loadBridgeClient, waitForBridgeReady
- [ ] `detectBridgeMode()` returns correct boolean based on URL param + iframe context check
- [ ] `loadBridgeClient()` creates script tag with correct src (from referrer or fallback)
- [ ] `waitForBridgeReady()` polls `window.ethereum.isConnected()` and resolves/rejects appropriately
- [ ] All functions have proper TypeScript type signatures
- [ ] Test file `src/utils/walletBridge.test.ts` exists with at least 7 test cases covering happy path and edge cases
- [ ] All tests pass when running `npm run test:unit`
- [ ] No TypeScript compilation errors
- [ ] Code follows unifactory conventions (ESLint passes if configured)

## Context Files

**Feature context:**
- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)

**Project knowledge:**
- [project.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/architecture.md)
- [patterns.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/patterns.md) - See Testing section for test patterns

**Note:** This task creates new files in the unifactory repo. The unifactory codebase is NOT in this repository - it's a separate repo (noxonsu/unifactory). You'll need to create these files based on the spec, referencing the tech-spec for the expected API and behavior.

## Verification Steps

1. Run `npm run test:unit` in the unifactory repository
2. Verify all tests in `src/utils/walletBridge.test.ts` pass
3. Check that TypeScript compilation succeeds (`npm run build` or `tsc --noEmit`)
4. Verify no linting errors if ESLint is configured
5. Check that the module exports three functions with correct type signatures

## Details

### Files to create

**`src/utils/walletBridge.ts` (new file)**
- Export `detectBridgeMode(): { isBridgeMode: boolean }` - Check `window.location.search.includes('walletBridge=swaponline')` AND `window.parent !== window`
- Export `loadBridgeClient(referrer: string): Promise<void>` - Create `<script>` element, extract origin from referrer, set `src` to `${origin}/wallet-apps-bridge-client.js`, fallback to `https://swaponline.github.io/wallet-apps-bridge-client.js` if referrer empty
- Export `waitForBridgeReady(timeout: number): Promise<boolean>` - Poll `window.ethereum?.isConnected()` every 100ms, resolve true when connected, reject on timeout

**`src/utils/walletBridge.test.ts` (new file)**
- Mock `window.location.search`, `window.parent`, `document.referrer`, `window.ethereum`
- Test all three functions with happy path and edge cases
- Use Jest (unifactory's existing test framework)

### Dependencies

**Existing packages (no new installs needed):**
- Jest (already in unifactory for testing)
- TypeScript (already in unifactory)
- @web3-react dependencies (already in unifactory, used for connector reference)

**Task dependencies:**
- Wave 1 (independent) - This task has no dependencies on other tasks
- Other tasks (Task 4, 5, 6) will consume these utilities after this task completes

### Edge cases

**Bridge detection:**
- Standalone mode (no iframe, no URL param) - Must return false
- URL param present but not in iframe - Must return false (security: prevent accidental activation)
- In iframe but no URL param - Must return false
- Both conditions true - Return true

**Script loading:**
- Empty referrer - Use fallback URL `https://swaponline.github.io`
- Referrer from non-HTTPS host - Extract origin anyway (handle testnet/localhost)
- Script already loaded - Should be idempotent (check if script tag exists first)
- CORS/CSP errors - Let script fail naturally, timeout will catch it in `waitForBridgeReady`

**Bridge ready polling:**
- Bridge never becomes ready - Timeout after specified milliseconds, reject promise
- Bridge ready immediately - Resolve on first poll
- `window.ethereum` doesn't exist - Should handle gracefully, return false on each poll
- Multiple concurrent calls - Should not interfere with each other

### Implementation hints

**Type safety:**
- Define return types explicitly for all functions
- Use TypeScript's DOM types (`Window`, `Location`, `HTMLScriptElement`)
- Consider defining an interface for `window.ethereum` with `isConnected()` method

**Testing strategy:**
- Use Jest's `jest.fn()` to mock browser APIs
- Reset mocks between tests with `beforeEach()`
- For async tests (`waitForBridgeReady`), use `jest.useFakeTimers()` to control polling
- Test both success and failure paths for all functions

**Code organization:**
- Keep functions pure and side-effect free where possible
- `detectBridgeMode` - pure function, reads from `window` but doesn't modify
- `loadBridgeClient` - side effect (DOM manipulation), return Promise for async script load
- `waitForBridgeReady` - async function, use polling pattern with timeout

**Referrer extraction:**
- Use `new URL(referrer).origin` to safely extract origin
- Handle invalid URL gracefully (try/catch, fall back to default)
- Example: `https://swaponline.github.io/index.html?foo=bar` → `https://swaponline.github.io`

**Polling pattern:**
- Use `setInterval` or recursive `setTimeout` with Promise wrapper
- Clear interval/timeout on resolve or reject
- Typical timeout: 5000ms (5 seconds) as per tech-spec
- Polling interval: 100ms (balance between responsiveness and CPU usage)

## Reviewers

- **code-reviewer** → `logs/working/task-2/code-reviewer-{round}.json`
- **test-reviewer** → `logs/working/task-2/test-reviewer-{round}.json`

## Post-completion

- [ ] Записать краткий отчёт в decisions.md по шаблону (Summary: 1-3 предложения, ревью со ссылками на JSON, без таблиц файндингов и дампов)
- [ ] Если отклонились от спека — описать отклонение и причину
- [ ] Обновить user-spec/tech-spec если что-то изменилось
