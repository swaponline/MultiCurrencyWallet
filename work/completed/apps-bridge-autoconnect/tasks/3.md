---
status: done
depends_on: []
wave: 1
skills: [code-writing]
verify: user
reviewers: [code-reviewer]
teammate_name:
---

# Task 3: Add inline bridge loading script to unifactory index.html

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Add inline `<script>` tag to unifactory's `public/index.html` that runs before React app mounts. This script detects bridge mode (URL parameter `?walletBridge=swaponline` + iframe context) and dynamically loads the wallet bridge client from the parent wallet host. This enables the bridge provider to be available when React's `useEagerConnect()` runs, allowing seamless auto-connection without wallet modal.

The script extracts the wallet host URL from `document.referrer`, constructs the bridge client script URL, and injects it. If referrer is blocked (privacy extensions), falls back to mainnet default URL (`https://swaponline.github.io/wallet-apps-bridge-client.js`).

This is a critical early-loading step that must execute before the React bundle, ensuring the bridge provider is injected into `window.ethereum` before any React hooks attempt to use it.

## What to do

1. Add inline `<script>` tag in `public/index.html` positioned before React bundle `<script>` tags
2. Script checks two conditions: URL search contains `walletBridge=swaponline` AND page is in iframe (`window.parent !== window`)
3. If both conditions true, extract wallet host from `document.referrer` (e.g., `https://swaponline.github.io`)
4. Dynamically create `<script>` tag with `src="{referrer-host}/wallet-apps-bridge-client.js"`
5. If referrer empty or blocked, fallback to hardcoded `https://swaponline.github.io/wallet-apps-bridge-client.js`
6. Append script to document head so bridge client loads immediately

## Acceptance Criteria

- [ ] Inline `<script>` tag added to `public/index.html` before React bundle scripts
- [ ] Script checks `window.location.search.includes('walletBridge=swaponline')`
- [ ] Script checks `window.parent !== window` (iframe context)
- [ ] Script extracts wallet host from `document.referrer`
- [ ] Script creates `<script src="{referrer}/wallet-apps-bridge-client.js">` dynamically
- [ ] Fallback to `https://swaponline.github.io/wallet-apps-bridge-client.js` if referrer empty
- [ ] Script only runs when BOTH conditions are true (URL param + iframe)
- [ ] Script does nothing in standalone mode (no URL param or no iframe)
- [ ] Build succeeds: `npm run build` in unifactory repo completes without errors

## Context Files

**Feature context:**
- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)

**Project knowledge (MCW):**
- [project.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/architecture.md)
- [patterns.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/patterns.md)

**Code files to modify:**
- **unifactory repo** `public/index.html` — HTML template file (NOT in MCW repo)

**⚠️ CRITICAL WARNING:** `public/index.html` is located in the **unifactory** repository (external repo), NOT in MultiCurrencyWallet. Agent must:
1. Clone/access unifactory repo separately
2. Make changes in unifactory's `public/index.html`
3. Create PR in unifactory repo (separate from MCW PRs)

Do NOT attempt to modify any file in MCW repo for this task.

## Verification Steps

**User verification (manual):**

1. Open PR preview URL for unifactory deploy
2. Right-click page → View Page Source (or `view-source:` URL)
3. Locate inline `<script>` tag in `<head>` before React bundle scripts
4. Verify script contains bridge detection logic:
   - Checks `window.location.search.includes('walletBridge=swaponline')`
   - Checks `window.parent !== window`
   - Extracts `document.referrer`
   - Creates dynamic script tag with referrer-based URL
   - Has fallback to `https://swaponline.github.io/wallet-apps-bridge-client.js`
5. Test in standalone mode: open dApp directly (no iframe, no URL param) → script should do nothing, no errors in console
6. Test in iframe mode: open via MCW `#/apps` → browser DevTools → check Network tab → verify `wallet-apps-bridge-client.js` loaded from referrer host

**Build verification:**

```bash
cd unifactory
npm run build
```

Expected: Build completes successfully, no HTML syntax errors, bundle includes inline script.

## Details

**File to modify:**

`public/index.html` (unifactory repo)
- Current state: Standard HTML template with React root div and bundle script tags
- What to add: Inline `<script>` tag positioned in `<head>` or early in `<body>`, BEFORE React bundle scripts
- Script placement: Must execute before React app initializes so bridge provider is available when `useEagerConnect()` runs

**Script logic (high-level):**

1. Check URL parameter: `window.location.search.includes('walletBridge=swaponline')`
2. Check iframe context: `window.parent !== window`
3. If BOTH true:
   - Extract referrer: `const referrer = document.referrer`
   - Parse referrer to get origin: `new URL(referrer).origin` (wrap in try-catch)
   - Build script URL: `{origin}/wallet-apps-bridge-client.js`
   - If referrer empty/invalid, use fallback: `https://swaponline.github.io/wallet-apps-bridge-client.js`
   - Create script element: `const script = document.createElement('script')`
   - Set `script.src`, `script.async = false` (important: must load before React)
   - Append to head: `document.head.appendChild(script)`
4. If conditions NOT met: do nothing (standalone mode)

**Edge cases:**

- **Referrer blocked by privacy extension:** Fallback to mainnet URL works for 95% users. Testnet users would need to manually connect (acceptable degradation).
- **Referrer from different origin:** Script will attempt to load from that origin. If CORS blocks it, fallback won't trigger (script.onerror needed for that). For MVP, document this as known limitation.
- **Multiple iframes:** Each iframe gets separate window context, separate script execution. No collision.
- **Script loading failure:** Network error, CORS, CSP. Current design: no retry logic, just fails silently. React app will show wallet modal as fallback (acceptable).

**Dependencies:**

- No npm packages needed (vanilla JavaScript)
- No task dependencies (Wave 1, independent task)

**Implementation hints:**

- Dynamically inserted scripts are always async — no need to set `script.async` explicitly
- Wrap referrer parsing in try-catch to handle malformed URLs gracefully
- Keep script minimal, no console logs in production (or gate behind dev mode check)
- Test both scenarios: (1) referrer present, (2) referrer empty

**Security notes:**

From tech-spec Decision 5: Host-side allowlist already restricts which domains can be iframed. dApp-side just loads script from parent origin — no additional security risk beyond what iframe already implies. Private keys never leave wallet host.

## Reviewers

- **code-reviewer** → `logs/working/task-3/code-reviewer-{round}.json`

## Post-completion

- [ ] Write report to decisions.md (include all review rounds with links to JSON files)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
