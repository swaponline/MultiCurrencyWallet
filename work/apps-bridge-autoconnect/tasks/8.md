---
status: done
depends_on: [1, 4, 5, 6]
wave: 3
skills: [code-writing]
verify: bash
reviewers: [test-reviewer]
teammate_name:
---

# Task 8: Extend MCW E2E smoke test for auto-connect

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Create a comprehensive E2E smoke test for the wallet apps bridge auto-connect feature. This task creates a NEW test file (does not extend existing file) that verifies when a dApp (Onout DEX) is opened via MCW's Apps page, the bridge provider is injected, the handshake completes successfully, and the dApp auto-connects to the wallet without showing a wallet selection modal.

This E2E test is critical because it verifies the full integration flow: MCW creates bridge → iframe loads dApp → bridge client script loads → handshake completes → dApp detects bridge and auto-connects → UI shows connected address. This cannot be tested via unit or integration tests due to cross-origin iframe and postMessage requirements.

The test will cover both the happy path (wallet connected, auto-connect succeeds) and the fallback scenario (no wallet connected, modal appears). This task IS the E2E test — we're writing tests that verify the auto-connect implementation from Tasks 1, 4, 5, 6. The tests will initially fail (expected) until those tasks are complete, then pass once the feature is fully implemented.

## What to do

1. Create new test file `tests/e2e/walletAppsBridge.smoke.js` using Puppeteer and Jest structure similar to existing E2E tests
2. Implement test case "Apps Bridge Auto-Connect - Happy Path" that verifies successful auto-connect flow
3. Implement test case "Apps Bridge Auto-Connect - No Wallet Fallback" that verifies modal appears when no wallet connected
4. Add helper functions for iframe content inspection and bridge ready detection
5. Configure test to use test wallet from `testWallets.json` for auto-connect verification


## Acceptance Criteria

- [ ] Test file `tests/e2e/walletAppsBridge.smoke.js` exists and follows project E2E test structure
- [ ] Happy path test opens MCW Apps page, clicks DEX app, waits for iframe load
- [ ] Test waits for bridge ready by polling `window.ethereum.isConnected()` up to 10 seconds
- [ ] Test checks iframe DOM to verify wallet modal (`.wallet-modal` or `[data-testid="wallet-modal"]`) is NOT visible
- [ ] Test extracts address from iframe body text using regex `/0x[a-fA-F0-9]{40}/`
- [ ] Test compares extracted address to MCW test wallet address (from `testWallets.json`)
- [ ] Fallback test case verifies modal IS visible when no wallet connected
- [ ] Test runs successfully with `jest tests/e2e/walletAppsBridge.smoke.js --detectOpenHandles` (no dedicated npm script exists)
- [ ] Test takes screenshot on success and error for debugging

## Context Files

**Feature-specific:**
- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)

**Project context (always):**
- [project.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/architecture.md)

**By task relevance:**
- [patterns.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/patterns.md) — Testing & Verification section

**Code files:**
- [tests/e2e/utils.ts](/root/MultiCurrencyWallet/tests/e2e/utils.ts) — E2E test utilities (createBrowser, importWallet, etc.)
- [tests/e2e/history.test.ts](/root/MultiCurrencyWallet/tests/e2e/history.test.ts) — Example E2E test structure
- [tests/testWallets.json](/root/MultiCurrencyWallet/tests/testWallets.json) — Test wallet addresses and seeds

## Verification Steps

1. Run E2E smoke test: `jest tests/e2e/walletAppsBridge.smoke.js --detectOpenHandles` in MCW repo (no dedicated npm script)
2. Expected: Test suite "Apps Bridge Auto-Connect" passes both test cases
3. Expected: Console output shows "Happy Path" test passed with address verification
4. Expected: Console output shows "No Wallet Fallback" test passed with modal detection
5. Expected: Screenshots saved in `tests/e2e/screenshots/` for both scenarios
6. Check screenshots visually to confirm iframe loaded and auto-connect state captured

## Details

**File to create:**
- `tests/e2e/walletAppsBridge.smoke.js` — NEW E2E smoke test file (does not exist yet, will be created in this task)

**Current E2E test structure (from reading existing tests):**
- Uses Puppeteer for browser automation
- Jest as test runner with 360 second timeout
- `createBrowser()` helper opens localhost:9001 or file:// path in CI
- `importWallet()` helper restores wallet from seed phrase
- `takeScreenshot()` helper saves JPG to `tests/e2e/screenshots/`
- Test wallets from `testWallets.json` (e.g., `testWallets.eth.address = "0xa5c881C6942edAc164aFFD5194420c1CceDC77E9"`)

**Test flow details:**

*Happy Path test:*
1. Import test wallet using `importWallet()` with eth seed phrase
2. Navigate to `#/apps` page (wait for page load)
3. Find and click Onout DEX app button (selector to be determined from Apps page DOM)
4. Wait for iframe to appear (selector: `iframe[src*="dex.onout.org"]` or similar)
5. Get iframe contentWindow/contentDocument handle
6. Poll iframe's `window.ethereum.isConnected()` every 500ms up to 10 seconds
7. Once connected, query iframe DOM for wallet modal selectors (`.wallet-modal`, `[data-testid="wallet-modal"]`, or common WalletModal class names)
8. Assert modal NOT visible (display: none, or element doesn't exist)
9. Extract text from iframe body, search for Ethereum address pattern `/0x[a-fA-F0-9]{40}/`
10. Compare extracted address to `testWallets.eth.address`
11. Take success screenshot

*No Wallet Fallback test:*
1. DO NOT import wallet (skip importWallet step)
2. Navigate to `#/apps` page
3. Click Onout DEX app
4. Wait for iframe load
5. Wait 5 seconds (bridge ready timeout)
6. Check iframe DOM for wallet modal
7. Assert modal IS visible
8. Take screenshot

**Dependencies:**
- Tasks 1, 4, 5, 6 must be complete for tests to pass (tests will fail until then — expected behavior)
- Puppeteer already installed in MCW
- No new npm packages needed

**Edge cases:**
- **Iframe cross-origin access:** Puppeteer can access iframe content via `page.frames()` API even with different origin
- **Bridge timing:** 10 second timeout for bridge ready is generous (tech-spec says 5 sec in dApp, but test should allow more time)
- **Modal selector variations:** Check multiple possible selectors, dApp may use different class names
- **Address not found:** Test should fail gracefully if address pattern not detected (clear error message)

**Implementation hints:**
- Use `page.frames()` to get iframe handle after load
- Access iframe content: `const iframeHandle = page.frames().find(f => f.url().includes('dex.onout.org'))`
- Evaluate JS in iframe context: `await iframeHandle.evaluate(() => window.ethereum.isConnected())`
- Query iframe DOM: `await iframeHandle.$('.wallet-modal')` or `await iframeHandle.evaluate(() => document.querySelector('.wallet-modal'))`
- Use regex on iframe body text: `await iframeHandle.evaluate(() => document.body.innerText.match(/0x[a-fA-F0-9]{40}/))`
- Check element visibility: `await iframeHandle.evaluate(sel => { const el = document.querySelector(sel); return el && getComputedStyle(el).display !== 'none'; }, '.wallet-modal')`

## Reviewers

- **test-reviewer** → `logs/working/task-8/test-reviewer-{round}.json`

## Post-completion

- [ ] Write brief report to decisions.md following template (Summary: 1-3 sentences, reviews with links to JSON, no finding tables or dumps)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
