---
status: planned                    # planned -> in_progress -> done
depends_on: [7, 8]                 # номера задач-зависимостей
wave: final                        # волна параллельного выполнения
skills: [pre-deploy-qa]            # МАССИВ скиллов для загрузки
verify:                            # инструмент верификации (опционально) — N/A for QA
reviewers: []                      # явно указать. Пусто = fallback на дефолтные три — no reviewers for QA
teammate_name: qa-runner           # косметическое имя тиммейта для agent teams (например: coder-inbox, qa-runner, deployer)
---

# Task 9: Pre-deploy QA

## Required Skills

Перед выполнением задачи загрузи:
- `/skill:pre-deploy-qa` — [skills/pre-deploy-qa/SKILL.md](~/.claude/skills/pre-deploy-qa/SKILL.md)

## Description

Acceptance testing on PR preview URLs for both MCW and unifactory deploys. This is the final pre-deploy verification to ensure the apps-bridge-autoconnect feature works end-to-end before merging to production.

We run all automated tests (unit tests in both repos, E2E smoke test), then perform manual browser testing to verify the core user experience: opening DEX via Apps page results in automatic wallet connection without modal interruption. We also verify fallback scenarios (standalone mode, no-wallet mode) work correctly.

This task is the gate before deployment — if QA passes, the feature is ready to merge and deploy to production.

## What to do

1. Run MCW unit tests on PR branch to verify bridge protocol tests pass
2. Run unifactory unit tests on PR branch to verify bridge utils and hook tests pass
3. Run E2E smoke test on MCW PR preview URL to verify iframe auto-connect flow
4. Manual browser test: open MCW PR preview at `#/apps`, click Onout DEX, verify address visible and no wallet modal
5. Standalone test: open `dex.onout.org` directly in browser, verify standard wallet selection modal shows
6. No-wallet test: disconnect MetaMask in MCW, open DEX via Apps page, verify wallet modal appears (fallback behavior)
7. Verify all acceptance criteria from user-spec and tech-spec are met
8. Document any failures or issues discovered during testing


## Acceptance Criteria

From user-spec:
- [ ] AC1: Open `#/apps` → Onout DEX → DEX shows connected wallet address without modals and connect buttons
- [ ] AC2: Balance in DEX matches ETH wallet balance in MCW
- [ ] AC3: `dex.onout.org` in standalone mode (without iframe) works as before — standard wallet selection flow
- [ ] AC4: When MetaMask not connected in MCW, DEX shows standard wallet selection modal
- [ ] AC5: Network switch in MCW (chainChanged) reflects in DEX iframe
- [ ] AC6: E2E smoke test passes — iframe opens, bridge detected, address displayed

From tech-spec:
- [ ] AC-T1: `wallet-apps-bridge-client.js` has `isMetaMask: true`
- [ ] AC-T6: All unit tests pass in both repos (`npm run test:unit`)
- [ ] AC-T8: E2E smoke test passes on PR preview URL before merge
- [ ] AC-T9: No regressions in existing unit tests (both repos)
- [ ] AC-T10: Standalone mode E2E test passes (dApp behavior unchanged without iframe)
- [ ] AC-T11: TypeScript builds succeed in both repos (no type errors)
- [ ] AC-T12: Code passes ESLint/Prettier checks (unifactory has linting)

## Context Files

**Feature-specific:**
- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)

**Project context:**
- [project.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/architecture.md)
- [patterns.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/patterns.md) — Testing section

**PR preview URLs:**
- MCW PR branch: `issue-5268-apps-layout`
- unifactory PR branch: (to be determined during development)

## Verification Steps

1. All automated tests pass (unit tests in both repos + E2E smoke test)
2. Manual browser test confirms auto-connect behavior (address visible, no modal)
3. Standalone mode unchanged (wallet modal shows when opening DEX directly)
4. No-wallet fallback works (modal shows when MetaMask disconnected)
5. Network switch event propagates correctly from MCW to DEX iframe
6. All acceptance criteria from user-spec and tech-spec checked and documented
7. QA report created in `logs/working/task-9/` with findings and recommendations

## Details

### Test Execution Order

1. **MCW unit tests** — Verify bridge protocol implementation (postMessage handshake, provider properties, event forwarding)
2. **unifactory unit tests** — Verify bridge utils module, hook logic, and modal suppression
3. **E2E smoke test** — Verify full integration on PR preview URL
4. **Manual browser tests** — Verify UX, visual behavior, edge cases

### Manual Test Scenarios

**Scenario 1: Happy path auto-connect**
- Open MCW PR preview at `#/apps`
- Ensure MetaMask is connected in MCW
- Click "Onout DEX" app card
- Wait for iframe to load
- Expected: Address displayed in DEX header, no wallet modal, balance matches MCW ETH balance

**Scenario 2: Standalone mode unchanged**
- Open `dex.onout.org` directly in new browser tab
- Expected: Standard wallet selection modal appears, no automatic connection

**Scenario 3: No wallet fallback**
- Open MCW PR preview at `#/apps`
- Disconnect MetaMask in MCW (or use browser without MetaMask)
- Click "Onout DEX" app card
- Expected: DEX shows wallet selection modal (same as standalone mode)

**Scenario 4: Network switch propagation**
- Open DEX via MCW Apps page (auto-connected)
- Switch network in MCW (ETH → BSC)
- Expected: DEX updates to BSC network, address remains visible

**Scenario 5: Disconnect propagation**
- Open DEX via MCW Apps page (auto-connected)
- Disconnect MetaMask in MCW
- Expected: DEX shows Connect button, address disappears

### PR Preview Access

**MCW:** GitHub Pages automatically deploys PR previews for branch `issue-5268-apps-layout`. URL format: `https://swaponline.github.io/` (same as mainnet, but from PR branch build)

**unifactory:** Check GitHub Actions for PR preview URL, or deploy manually to test server if needed.

### E2E Test Command

From MCW repo root:
```bash
npm run test:e2e
```

Expected output: E2E test passes with `success: true`, screenshots saved to `/tmp/mcw_apps_onout_iframe.png`

### Unit Test Commands

**MCW:**
```bash
npm run test:unit
```

Expected: All tests pass including new `tests/unit/walletBridge.test.ts`

**unifactory:**
```bash
npm run test:unit  # or npm test
```

Expected: All tests pass including `src/utils/walletBridge.test.ts` and extended `src/hooks/index.test.ts`

### Build Verification

**MCW:**
```bash
npm run build:mainnet
```

Expected: Build succeeds, no TypeScript errors

**unifactory:**
```bash
npm run build
```

Expected: Build succeeds, no TypeScript or ESLint errors

### Dependencies

- Depends on Task 7 (MCW bridge unit tests) — tests must exist and pass
- Depends on Task 8 (MCW E2E smoke test extension) — E2E test must include auto-connect checks

### Edge Cases to Verify

1. **Timing race:** Bridge handshake slow network → verify 5-second timeout works
2. **Referrer blocked:** Privacy extension blocks `document.referrer` → verify fallback URL used
3. **Multiple DEX tabs:** Open two DEX iframes simultaneously → verify no collision
4. **Browser compatibility:** Test on Chrome, Firefox, Brave (if time permits)

### QA Report Format

Create file: `logs/working/task-9/qa-report.md`

Template:
```markdown
# Pre-deploy QA Report: apps-bridge-autoconnect

**Date:** YYYY-MM-DD
**PR branches:** MCW `issue-5268-apps-layout`, unifactory `[branch-name]`

## Test Results Summary

| Category | Status | Notes |
|----------|--------|-------|
| MCW unit tests | PASS/FAIL | [details] |
| unifactory unit tests | PASS/FAIL | [details] |
| E2E smoke test | PASS/FAIL | [details] |
| Manual browser test (happy path) | PASS/FAIL | [details] |
| Standalone mode test | PASS/FAIL | [details] |
| No-wallet fallback test | PASS/FAIL | [details] |
| Network switch test | PASS/FAIL | [details] |

## Acceptance Criteria Status

- [ ] AC1: Auto-connect in Apps page
- [ ] AC2: Balance matches
- [ ] AC3: Standalone mode unchanged
- [ ] AC4: No-wallet fallback
- [ ] AC5: Network switch propagation
- [ ] AC6: E2E smoke test passes
- [ ] AC-T1: isMetaMask flag set
- [ ] AC-T6: All unit tests pass
- [ ] AC-T8: E2E on PR preview
- [ ] AC-T9: No regressions
- [ ] AC-T10: Standalone E2E pass
- [ ] AC-T11: TypeScript builds
- [ ] AC-T12: Linting passes

## Issues Found

[List any bugs, regressions, or concerns discovered]

## Recommendations

[Go/No-go for deployment, or required fixes before merge]
```

## Reviewers

No reviewers for QA tasks — QA is its own verification step.

## Post-completion

- [ ] Create QA report in `logs/working/task-9/qa-report.md` with test results and acceptance criteria status
- [ ] Record summary in decisions.md: QA status (pass/fail), any critical issues found, go/no-go recommendation
- [ ] If critical issues found, create GitHub issues with reproduction steps and priority labels
- [ ] If all tests pass, approve PR for deployment (or flag for human review if borderline)
