---
status: planned
depends_on: [2]
wave: 2
skills: [code-writing]
verify: user
reviewers: [code-reviewer]
---

# Task 5: Suppress WalletModal in bridge mode

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Modify the WalletModal component in unifactory dApp to suppress the wallet selection modal when the app is running in bridge mode with an active connection. This ensures a seamless user experience — when a user opens the DEX through MCW's Apps page, they shouldn't see the wallet connection modal since the wallet is already connected via the bridge.

The modal should only be suppressed when BOTH conditions are true:
1. Bridge mode is active (`window.ethereum?.isSwapWalletAppsBridge === true`)
2. Wallet is connected (`active` state from web3-react context)

If the bridge is active but no wallet is connected (e.g., user hasn't connected MetaMask in MCW), the modal SHOULD still show to allow fallback wallet connection methods.

## What to do

1. Add bridge detection check at the beginning of WalletModal component render
2. Return `null` (don't render modal) if bridge is active AND wallet is connected
3. Allow normal modal rendering if bridge is NOT active OR wallet is NOT connected
4. Ensure the check doesn't break standalone mode (when dApp runs outside iframe)

## TDD Anchor

Unit tests to write BEFORE implementation:

- `src/components/WalletModal/index.test.tsx::test_modal_suppressed_in_bridge_mode` — WalletModal returns null when `window.ethereum.isSwapWalletAppsBridge === true` AND `active === true`
- `src/components/WalletModal/index.test.tsx::test_modal_shown_bridge_not_connected` — WalletModal renders normally when bridge active but `active === false` (fallback scenario)
- `src/components/WalletModal/index.test.tsx::test_modal_shown_standalone_mode` — WalletModal renders normally when `window.ethereum.isSwapWalletAppsBridge` is undefined or false

## Acceptance Criteria

- [ ] WalletModal component checks for bridge mode at render start
- [ ] Modal returns `null` when `window.ethereum?.isSwapWalletAppsBridge === true` AND `active === true`
- [ ] Modal renders normally when bridge active but wallet not connected (fallback)
- [ ] Modal renders normally in standalone mode (no bridge)
- [ ] Unit tests pass for all three scenarios (bridge connected, bridge not connected, standalone)
- [ ] No TypeScript errors in modified component
- [ ] Builds successfully in unifactory repo (`npm run build`)

## Context Files

**Feature context:**
- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)

**Project context:**
- [project.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/architecture.md)
- [patterns.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/patterns.md) — Testing section

**Code files (unifactory repo - read for understanding):**
- Note: This task modifies unifactory repo files, NOT MCW repo files
- `src/components/WalletModal/index.tsx` — Modal component to modify
- `src/hooks/index.ts` — Web3-react hooks (understand `active` state from `useWeb3React()`)

## Verification Steps

**User verification (primary):**
1. User opens PR preview of unifactory dApp through MCW Apps page (iframe with `?walletBridge=swaponline`)
2. After auto-connect completes (from Task 4), verify WalletModal is NOT visible
3. User opens same dApp URL directly in browser (standalone mode) → verify WalletModal IS visible

**Automated verification:**
1. Run `npm run test:unit` in unifactory repo → all WalletModal tests pass
2. Run `npm run build` in unifactory repo → build succeeds without TypeScript errors

## Details

**Repository:** This task modifies `noxonsu/unifactory` repository, NOT `swaponline/MultiCurrencyWallet`.

**File to modify:** `src/components/WalletModal/index.tsx`

**Current state (expected):**
- WalletModal is a React component that displays wallet connection options
- It uses `useWeb3React()` hook to access wallet connection state
- The `active` boolean from web3-react indicates if wallet is connected
- Modal is controlled by props/state, likely renders wallet connector buttons

**What to change:**
- Add early return at component start (before normal render logic)
- Check two conditions: bridge flag AND active state
- Condition: `if (window.ethereum?.isSwapWalletAppsBridge && active) return null`
- This suppresses modal ONLY when bridge auto-connected the wallet
- If bridge exists but wallet NOT connected, modal shows (fallback for no MetaMask in MCW)

**Dependencies:**
- Task 2 (bridge utils module) — provides `window.ethereum.isSwapWalletAppsBridge` flag
- Task 4 (useEagerConnect) — sets `active` state when auto-connect succeeds
- `@web3-react/core` — provides `useWeb3React()` hook for accessing `active` state

**Edge cases:**
1. **Bridge active, wallet disconnected:** Modal SHOULD show (user can connect via WalletConnect/other methods)
2. **Standalone mode (no bridge):** Modal SHOULD show normally
3. **Bridge script loading failed:** `window.ethereum.isSwapWalletAppsBridge` will be undefined → modal shows (correct fallback)
4. **User disconnects during session:** `active` becomes false → modal can show again if triggered

**Implementation hints:**
- Access `active` via `const { active } = useWeb3React()`
- Optional chaining is critical: `window.ethereum?.isSwapWalletAppsBridge` (don't crash if window.ethereum undefined)
- Place check AFTER hooks (can't return before hooks due to React rules)
- If component uses props to control visibility, ensure early return respects that contract
- Consider: does modal have local state that needs cleanup? (probably not, but check)

**Testing approach:**
- Mock `window.ethereum` with `isSwapWalletAppsBridge: true`
- Mock `useWeb3React()` to return `{ active: true }` or `{ active: false }`
- Use React Testing Library to render WalletModal
- Assert modal container is null or visible based on conditions

## Reviewers

- **code-reviewer** → `logs/working/task-5/code-reviewer-{round}.json`

## Post-completion

- [ ] Записать краткий отчёт в decisions.md по шаблону (Summary: 1-3 предложения, ревью со ссылками на JSON, без таблиц файндингов и дампов)
- [ ] Если отклонились от спека — описать отклонение и причину
- [ ] Обновить user-spec/tech-spec если что-то изменилось
