---
status: planned
depends_on: [2]
wave: 2
skills: [code-writing]
verify: bash
reviewers: [code-reviewer, test-reviewer]
teammate_name:
---

# Task 4: Extend useEagerConnect with bridge auto-connect

## Required Skills

Перед выполнением задачи загрузи:
- `/skill:code-writing` — [skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Modify the `useEagerConnect()` hook in unifactory dApp to enable automatic wallet connection when running inside MCW's Apps iframe. This is the core auto-connect logic that eliminates the wallet selection modal for users who already have a wallet connected in MCW.

The hook needs to detect when the dApp is running in bridge mode (via `window.ethereum?.isSwapWalletAppsBridge` flag), wait for the bridge to complete its handshake with the host (up to 5 seconds), and then immediately call `activate(injected)` to connect the wallet — bypassing the normal `isAuthorized()` check that would require user interaction. If the bridge times out or isn't ready, the hook falls back to the standard eager connect flow (checking localStorage for previous authorization).

This task depends on Task 2 (bridge utils module) which provides the `waitForBridgeReady()` function needed for detecting bridge readiness.

**CRITICAL:** This task modifies the `noxonsu/unifactory` repository, NOT the `swaponline/MultiCurrencyWallet` repository. Unifactory is an external repo that needs to be cloned separately before starting work on this task.

## What to do

1. Add bridge mode detection to `useEagerConnect()` — check if `window.ethereum?.isSwapWalletAppsBridge` is true
2. Import `waitForBridgeReady()` from `src/utils/walletBridge.ts` (created in Task 2)
3. When bridge mode detected, call `waitForBridgeReady(5000)` to wait up to 5 seconds for bridge handshake completion
4. If bridge ready within timeout, immediately call `activate(injected)` without checking `isAuthorized()` first
5. If bridge timeout (5 sec exceeded), fall back to standard eager connect logic (check `isAuthorized()`, connect if previously authorized)
6. Extend test file `src/hooks/index.test.ts` with three new test scenarios:
   - Bridge mode with ready provider → activates immediately
   - Bridge mode with timeout → falls back to standard flow
   - Standalone mode (no bridge) → standard behavior unchanged

## TDD Anchor

Write these tests BEFORE implementing the hook changes:

- `src/hooks/index.test.ts::test useEagerConnect bridge mode ready` — Mock `window.ethereum.isSwapWalletAppsBridge = true` and `isConnected() = true`, verify `activate(injected)` called immediately without `isAuthorized()` check
- `src/hooks/index.test.ts::test useEagerConnect bridge mode timeout` — Mock bridge provider with `isConnected() = false` (never ready), verify after 5 seconds falls back to `isAuthorized()` check and standard flow
- `src/hooks/index.test.ts::test useEagerConnect standalone mode` — Mock no bridge provider (`window.ethereum.isSwapWalletAppsBridge = undefined`), verify standard behavior unchanged (calls `isAuthorized()` first)

## Acceptance Criteria

- [ ] `useEagerConnect()` hook detects bridge mode via `window.ethereum?.isSwapWalletAppsBridge` check
- [ ] Hook waits for bridge ready up to 5 seconds using `waitForBridgeReady(5000)` from utils module
- [ ] When bridge ready, hook calls `activate(injected)` immediately — bypassing the `isAuthorized()` check entirely (this is the key difference from standard flow)
- [ ] In bridge mode, the hook does NOT call `isAuthorized()` before activation — it trusts the bridge handshake and activates immediately
- [ ] When bridge timeout (5 sec), hook falls back to standard flow (check `isAuthorized()`, connect if previously authorized)
- [ ] Standalone mode (no bridge) behavior unchanged — standard eager connect flow works as before
- [ ] All three new test scenarios pass in `src/hooks/index.test.ts`
- [ ] No TypeScript errors in hook file or test file
- [ ] `npm run test:unit` passes in unifactory repo

## Context Files

**CRITICAL WARNING:** All code files listed below are in the `noxonsu/unifactory` repository, NOT in MultiCurrencyWallet. You MUST clone unifactory repo separately before working on this task.

**Feature context:**
- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)

**Project knowledge:**
- [project.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/architecture.md)
- [patterns.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/patterns.md) — Testing section for test patterns

**Code files to modify:**
- `src/hooks/index.ts` — Current `useEagerConnect()` implementation (unifactory repo)
- `src/hooks/index.test.ts` — Existing hook tests to extend (unifactory repo)

**Code files to read:**
- `src/utils/walletBridge.ts` — Bridge utils from Task 2, provides `waitForBridgeReady()` function (unifactory repo)
- `src/connectors/index.ts` — Injected connector instance used in `activate()` call (unifactory repo)

## Verification Steps

1. Run unit tests: `npm run test:unit` in unifactory repo
   - Expected: All tests pass, including 3 new `useEagerConnect` test scenarios

2. Check TypeScript compilation: `npm run build` in unifactory repo
   - Expected: No TypeScript errors in `src/hooks/index.ts`

3. Inspect test coverage for new code paths
   - Expected: Bridge mode path and timeout fallback covered by tests

## Details

### Files

**src/hooks/index.ts:**
- Current state: Contains `useEagerConnect()` hook that checks `isAuthorized()` and connects if user previously authorized
- What to change: Add bridge mode detection at the start of the hook. If bridge mode detected, wait for `waitForBridgeReady(5000)`. If ready, call `activate(injected)` immediately. If timeout, continue with existing logic (check `isAuthorized()`).
- Key function: `export function useEagerConnect()` — React hook using `useWeb3React()` and `useEffect()`

**src/hooks/index.test.ts:**
- Current state: Existing test file with hook tests (structure TBD when reading file)
- What to add: Three new test scenarios for `useEagerConnect()` bridge behavior. Mock `window.ethereum`, `isConnected()`, and `activate()` function. Verify correct code paths executed.

### Dependencies

- **Task 2:** Must be completed first — provides `src/utils/walletBridge.ts` with `waitForBridgeReady()` function
- **Packages:** All required packages already in unifactory (`@web3-react/core`, `@web3-react/injected-connector`)

### Edge Cases

1. **Bridge provider exists but never becomes ready** — Timeout after 5 seconds, fall back to standard flow. User sees standard wallet modal (acceptable degradation).
2. **Bridge provider becomes ready after timeout started but before activation** — Hook will activate via fallback logic if `isAuthorized()` returns true. If false, modal shows. Timing race acceptable — worst case is modal shows even though bridge ready.
3. **Multiple hook calls during bridge wait** — React `useEffect` dependency array should prevent re-triggering. Verify test doesn't cause infinite loops.
4. **Bridge provider disappears mid-check** — `window.ethereum?.isSwapWalletAppsBridge` becomes undefined during wait. Handle with optional chaining, timeout will trigger fallback.

### Implementation Hints

- Use `async/await` pattern in hook for cleaner bridge wait logic
- Import `waitForBridgeReady` from `'../utils/walletBridge'` (relative path from hooks/)
- Preserve existing hook behavior when bridge mode not detected — no changes to standard flow
- Bridge detection logic: `if (window.ethereum?.isSwapWalletAppsBridge) { ... }`
- Timeout handling: wrap `waitForBridgeReady()` in try/catch or use Promise rejection
- Test mocking: use Jest `jest.fn()` to mock `activate`, `window.ethereum`, and bridge utils

### Error Handling

- If `waitForBridgeReady()` throws/rejects (timeout or error), catch the error and fall back to standard flow
- Log errors to console for debugging but don't break the app
- Ensure `activate()` errors are also caught and handled (web3-react context will handle errors internally)
- Don't block indefinitely — always have a timeout/fallback path

### Technical Context

**web3-react library:** Uses context provider pattern. `useWeb3React()` returns `{ activate, active, account, ... }`. `activate(connector)` triggers wallet connection. `injected` connector wraps `window.ethereum`.

**Current useEagerConnect flow (standard mode):**
1. Hook runs on component mount (useEffect)
2. Checks `injected.isAuthorized()` — returns true if user previously connected wallet (stored in localStorage by MetaMask/injected provider)
3. If authorized, calls `activate(injected)`
4. If not authorized, does nothing (user must click Connect button)

**New bridge mode flow:**
1. Hook runs on mount
2. Detects bridge mode via flag
3. Waits for bridge ready (5 sec max)
4. If ready: `activate(injected)` immediately (skip `isAuthorized()`)
5. If timeout: fall back to standard flow (step 2-4 above)

## Reviewers

- **code-reviewer** → `logs/working/task-4/code-reviewer-{round}.json`
- **test-reviewer** → `logs/working/task-4/test-reviewer-{round}.json`

## Post-completion

- [ ] Записать краткий отчёт в decisions.md по шаблону (Summary: 1-3 предложения, ревью со ссылками на JSON, без таблиц файндингов и дампов)
- [ ] Если отклонились от спека — описать отклонение и причину
- [ ] Обновить user-spec/tech-spec если что-то изменилось
