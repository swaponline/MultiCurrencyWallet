---
status: planned
depends_on: [2]
wave: 2
skills: [code-writing]
verify: bash
reviewers: [code-reviewer]
teammate_name:
---

# Task 6: Add bridge ready handler in Web3ReactManager

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Add a `bridgeReady` event listener to the Web3ReactManager component to handle cases where the bridge handshake completes after the initial eager connect attempt. This ensures reliable auto-connection even when timing between React app mount and bridge READY message varies.

When the bridge client completes its handshake with the wallet host, it emits a custom `bridgeReady` event on `window.ethereum`. If the dApp's eager connect logic runs before this event fires, the initial connection attempt may fail or return empty accounts. By listening for this event, Web3ReactManager can retry the connection once the bridge is confirmed ready.

This complements Task 4's `waitForBridgeReady()` polling approach by providing an event-driven fallback that handles edge cases where timing varies across different devices or network conditions.

## What to do

1. Add a `useEffect` hook in Web3ReactManager that sets up a `bridgeReady` event listener on `window.ethereum` when the component mounts
2. In the event handler, check if the wallet is not already active (using web3-react's `active` state)
3. If not active and bridge is ready, trigger the eager connect logic to retry connection
4. Clean up the event listener when the component unmounts to prevent memory leaks
5. Ensure the handler only activates in bridge mode by checking the `isSwapWalletAppsBridge` flag on the provider

## TDD Anchor

Tests to write BEFORE implementation:

- `src/components/Web3ReactManager/index.test.tsx::test_bridge_ready_event_listener` — Verify component sets up bridgeReady event listener on mount and cleans up on unmount
- `src/components/Web3ReactManager/index.test.tsx::test_bridge_ready_triggers_connect` — Mock bridgeReady event, verify eager connect is called when wallet not active
- `src/components/Web3ReactManager/index.test.tsx::test_bridge_ready_skips_when_active` — Mock bridgeReady event when wallet already active, verify no reconnection attempt
- `src/components/Web3ReactManager/index.test.tsx::test_bridge_ready_only_in_bridge_mode` — Verify handler only activates when `window.ethereum.isSwapWalletAppsBridge === true`

## Acceptance Criteria

- [ ] Web3ReactManager component has a useEffect hook that registers a `bridgeReady` event listener
- [ ] Event listener checks `window.ethereum?.isSwapWalletAppsBridge` before taking action
- [ ] Event handler only attempts connection if `active === false` (wallet not already connected)
- [ ] Event listener is properly cleaned up on component unmount
- [ ] All unit tests pass with `npm test`
- [ ] No regressions in existing Web3ReactManager behavior (standard mode still works)

## Context Files

**Always (feature-specific):**
- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)

**Always (project context):**
- [project.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/architecture.md)

**By task relevance:**
- [patterns.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/patterns.md) — Testing section for React Testing Library patterns

**Code files:**
- `src/components/Web3ReactManager/index.tsx` — Component to modify (note: this is in unifactory repo, not MCW)
- `src/hooks/index.ts` — Contains useEagerConnect hook that will be called from event handler

## Verification Steps

1. Run `npm test` in the unifactory repo — verify all unit tests pass, including new Web3ReactManager tests
2. Check test coverage for the new event listener code — should be covered by the TDD anchor tests
3. Build the project with `npm run build` — verify TypeScript compilation succeeds with no type errors
4. Manual verification (if possible): Open dApp in bridge mode, check browser console for event listener registration and cleanup messages (if debug logging added)

## Details

**Files to modify:**

- `src/components/Web3ReactManager/index.tsx`:
  - Current state: Component manages web3-react initialization and eager connect on mount
  - What to add: New useEffect hook that listens for `bridgeReady` event on `window.ethereum`
  - Event handler logic: Check `active` state from web3-react context, verify `isSwapWalletAppsBridge` flag, call eager connect if conditions met
  - Cleanup: Return cleanup function from useEffect to remove event listener

**Dependencies:**

- Task 2 must be complete (walletBridge utils module) — provides bridge detection utilities that may be useful
- Task 4 must be complete (useEagerConnect extension) — the hook being called by this event handler
- Uses existing web3-react hooks: `useWeb3React()` for accessing `active` state
- Uses existing `useEagerConnect()` hook from `src/hooks/index.ts`

**Edge cases:**

1. **Multiple bridgeReady events:** Bridge client may emit event multiple times. Handler should be idempotent — check `active` state before each attempt.
2. **Event fires before component mounts:** Not a concern — listener only active after mount. Initial eager connect (Task 4) handles early bridge ready.
3. **Event fires after component unmounts:** Cleanup function removes listener, prevents memory leak and errors.
4. **Non-bridge mode:** Handler should not activate in standalone mode. Check `window.ethereum?.isSwapWalletAppsBridge` before acting.
5. **Already connected:** If `active === true`, skip reconnection to avoid redundant RPC calls.

**Implementation hints:**

- Use React's `useEffect` with empty dependency array `[]` to run once on mount
- Access web3-react state via `const { active } = useWeb3React()`
- Call the existing `useEagerConnect()` hook to get the eager connect function
- Event listener pattern: `window.ethereum?.addEventListener('bridgeReady', handler)`
- Cleanup pattern: `return () => window.ethereum?.removeEventListener('bridgeReady', handler)`
- Optional: Add console.log for debugging during development (remove before commit)
- TypeScript: `window.ethereum` may need type assertion or optional chaining

**Testing approach:**

- Mock `window.ethereum` with Jest
- Mock the `useWeb3React` hook to control `active` state
- Mock the `useEagerConnect` hook to verify it gets called
- Use `@testing-library/react` to render component and trigger lifecycle
- Dispatch custom `bridgeReady` event to simulate bridge client behavior
- Verify event listener cleanup with `renderHook` unmount

## Reviewers

- **code-reviewer** → `logs/working/task-6/code-reviewer-{round}.json`

## Post-completion

- [ ] Write report to decisions.md following the template (Summary: 1-3 sentences, reviews with links to JSON files, no findings tables or dumps)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
