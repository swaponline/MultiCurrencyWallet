---
status: planned                    # planned -> in_progress -> done
depends_on: [9]                    # номера задач-зависимостей
wave: Final                        # волна параллельного выполнения
skills: [infrastructure]           # МАССИВ скиллов для загрузки
verify: bash                       # инструмент верификации (опционально)
reviewers: []                      # явно указать. Пусто = fallback на дефолтные три
teammate_name:                     # косметическое имя тиммейта для agent teams (например: coder-inbox, qa-runner, deployer)
---

# Task 11: Deploy unifactory (dex.onout.org)

## Required Skills

Перед выполнением задачи загрузи:
- `/skill:infrastructure` — [skills/infrastructure/SKILL.md](~/.claude/skills/infrastructure/SKILL.md)

## Description

Deploy unifactory dApp to production at dex.onout.org. This task finalizes the Apps Bridge Auto-Connect feature by deploying the dApp-side changes that enable automatic wallet connection when opened via MCW's Apps page.

The deployment includes all bridge-aware changes from Tasks 2-6: dynamic bridge client loading, auto-connect logic in useEagerConnect(), WalletModal suppression, and bridge ready event handling. After this deployment, users opening Onout DEX through MCW's `#/apps` page will see their wallet address and balance immediately, without any wallet selection modal.

This task depends on Task 9 (Pre-deploy QA) completing successfully. Both MCW (Task 10) and unifactory (this task) can be deployed in any order — the feature works gracefully at all stages, with full functionality only after both are live.

## What to do

1. Merge PR to master branch (or configured deploy branch for dex.onout.org) in noxonsu/unifactory repository
2. Deploy to production using the configured deployment method
3. Verify dex.onout.org loads without errors in standalone mode
4. Verify wallet modal shows in standalone mode (standard behavior preserved)
5. Verify auto-connect works when opened via MCW `#/apps` page
6. Check browser console for errors in both modes (standalone and iframe)

## Acceptance Criteria

- [ ] AC1: dex.onout.org loads without errors (HTTP 200, no console errors)
- [ ] AC2: Standalone mode: wallet modal visible when opening dex.onout.org directly
- [ ] AC3: Bridge mode: opening via MCW `#/apps` → Onout DEX shows connected address
- [ ] AC4: Bridge mode: no wallet selection modal visible
- [ ] AC5: Bridge mode: address matches MCW wallet address
- [ ] AC6: curl dex.onout.org returns HTTP 200
- [ ] AC7: Page title and favicon load correctly

## Context Files

**Feature-specific:**
- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)

**Project context:**
- [project.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/architecture.md)
- [deployment.md](/root/MultiCurrencyWallet/.claude/skills/project-knowledge/references/deployment.md)

**Deployment config (if exists in unifactory repo):**
- Check for: `.github/workflows/`, `netlify.toml`, `vercel.json`, deployment scripts

## Verification Steps

**Automated verification (verify: bash):**
```bash
# Check HTTP 200
curl -I https://dex.onout.org | grep "HTTP/2 200"

# Check HTML loads
curl -s https://dex.onout.org | grep "<title>"

# Expected: HTTP 200 status and page title present
```

**Manual verification:**

1. **Standalone mode check:**
   - Open https://dex.onout.org in browser
   - Expected: wallet modal visible (standard behavior)
   - Check console: no errors

2. **Bridge mode check (requires MCW deployed):**
   - Open https://swaponline.github.io/#/apps
   - Click Onout DEX
   - Expected: DEX shows connected address, no wallet modal
   - Verify address matches MCW wallet
   - Check console: no errors

3. **Fallback check:**
   - Open https://swaponline.github.io/#/apps without MetaMask connected in MCW
   - Click Onout DEX
   - Expected: wallet modal visible (fallback behavior)

## Details

### Deployment target

**Domain:** dex.onout.org
**Repository:** noxonsu/unifactory
**Deploy branch:** master (or configured deploy branch)

### Deployment method

The exact deployment method depends on unifactory's configuration. Common options:
- **GitHub Actions:** Auto-deploy on push to master (check `.github/workflows/`)
- **Netlify:** Auto-deploy via GitHub integration (check `netlify.toml`)
- **Vercel:** Auto-deploy via GitHub integration (check `vercel.json`)
- **Manual:** SSH to server + git pull + build + restart

Check the unifactory repository for:
1. Deployment workflow files (`.github/workflows/deploy.yml`)
2. Hosting config (`netlify.toml`, `vercel.json`)
3. Build commands in `package.json` (e.g., `npm run build`)
4. README deployment instructions

### Pre-deploy checklist

Before merging PR:
- [ ] Task 9 (Pre-deploy QA) completed successfully
- [ ] All tests pass in PR branch
- [ ] PR reviewed and approved (if project requires human review)

### Dependencies

**Depends on:** Task 9 (Pre-deploy QA)

**Can deploy before or after:** Task 10 (Deploy MCW). Feature works gracefully:
- If only unifactory deployed: Bridge script loading code present but MCW hasn't updated `isMetaMask` flag yet → modal still shows (slight UX degradation, no breakage)
- If only MCW deployed: unifactory still shows wallet modal (no bridge script loaded) → no breakage
- After both deployed: Full auto-connect works

### Edge cases

**Case 1: Deployment fails**
- Rollback to previous version
- Check deployment logs for errors
- Common issues: build failures, environment variables missing, DNS not updated

**Case 2: Bridge script loading fails (CORS, 404)**
- Fallback to standard wallet modal works automatically (5 sec timeout in dApp code)
- User can still connect via WalletConnect or other methods

**Case 3: Referrer blocked by privacy extensions**
- Fallback to hardcoded mainnet URL (https://swaponline.github.io) works for 95% of users
- If user on testnet/custom deploy, script loading fails → fallback to wallet modal (acceptable degradation)

### Implementation hints

1. **Check deployment status:** After merge, monitor deployment pipeline (GitHub Actions, Netlify, etc.)
2. **DNS propagation:** Changes to dex.onout.org may take 5-15 minutes to propagate globally
3. **Cache busting:** If testing immediately after deploy, use hard refresh (Ctrl+Shift+R) to avoid cached old version
4. **Smoke test priority:** Test standalone mode FIRST to verify no regressions, then test bridge mode

### Rollback procedure

If deployment causes issues:
1. Revert merge commit in unifactory repo
2. Push to deploy branch
3. Wait for auto-deploy or trigger manual deploy
4. Verify dex.onout.org reverted to previous version

### Post-deploy verification

After deployment succeeds:
1. Run automated curl check (verify: bash)
2. Perform manual standalone mode check
3. If MCW also deployed (Task 10), perform manual bridge mode check
4. Document any issues in GitHub issue or decisions.md

## Reviewers

No reviewers for deployment task (manual verification only).

## Post-completion

- [ ] Записать краткий отчёт в decisions.md: deployment status, merge commit hash, verification results
- [ ] Если были проблемы при деплое — описать проблему и решение
- [ ] Если конфигурация отличается от ожидаемой — обновить tech-spec с актуальной информацией о deployment
- [ ] Убедиться что оба режима работают: standalone (wallet modal visible) и bridge (auto-connect if MCW deployed)
