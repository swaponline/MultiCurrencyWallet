---
created: 2026-02-26
status: draft
type: feature
size: M
---

# User Spec: Apps Bridge Auto-Connect

## Что делаем
Когда пользователь открывает dApp (Onout DEX) через страницу Apps кошелька (#/apps), dApp должен автоматически подключиться к кошельку через EIP-1193 bridge provider — без модалки выбора кошелька. Сейчас bridge инжектит `window.ethereum` в iframe, но dApp его не использует и показывает стандартную модалку wallet selection. Нужны изменения на обеих сторонах: MCW bridge-client (эмуляция MetaMask) и dApp unifactory (динамическая загрузка bridge-клиента и auto-connect логика).

## Зачем
Пользователь уже подключил кошелёк в MCW. Когда он открывает dApp внутри кошелька, повторный запрос подключения — бессмысленное трение. Auto-connect создаёт seamless опыт: открыл dApp → сразу видишь свой адрес и баланс → можно торговать. Это критично для UX встроенных dApps в странице Apps.

## Как должно работать

### Сценарий 1: Happy path (MetaMask подключён в MCW)
1. Пользователь открывает `#/apps` в кошельке
2. Кликает на Onout DEX
3. Открывается iframe с dApp и параметром `?walletBridge=swaponline`
4. dApp обнаруживает параметр bridge + контекст iframe
5. dApp динамически загружает bridge-клиент с wallet-хоста (или fallback URL если referrer пустой)
6. Bridge-клиент создаёт provider и выполняет handshake с хостом
7. dApp вызывает auto-connect → получает адрес от MCW хоста
8. DEX показывает подключённый адрес и баланс — без модалок

### Сценарий 2: MetaMask не подключён в MCW
1. Пользователь открывает DEX через `#/apps`
2. Bridge handshake выполняется, но `eth_accounts` возвращает пустой массив (нет подключённого провайдера на хосте)
3. dApp fallback на стандартный flow — показывает wallet selection modal как обычно

### Сценарий 3: Standalone режим (без iframe)
1. Пользователь открывает `dex.onout.org` напрямую в браузере
2. URL не содержит `?walletBridge` и страница не в iframe
3. Bridge-код не активируется, dApp работает как обычно

### Сценарий 4: Disconnect во время работы
1. Пользователь использует DEX через `#/apps` (подключён)
2. Отключает MetaMask в MCW
3. Bridge хост прокидывает `accountsChanged([])` в iframe
4. DEX обновляет UI — убирает адрес, показывает кнопку Connect

### Сценарий 5: Смена сети
1. Пользователь переключает сеть в MCW (ETH → BSC)
2. Bridge хост прокидывает `chainChanged` event в iframe
3. DEX обновляет контекст сети

## Критерии приёмки
- [ ] AC1: Открыть `#/apps` → Onout DEX → DEX показывает подключённый адрес кошелька без модалок и кнопок подключения
- [ ] AC2: Баланс в DEX соответствует балансу ETH кошелька в MCW
- [ ] AC3: `dex.onout.org` в standalone режиме (без iframe) работает как раньше — стандартный wallet selection flow
- [ ] AC4: Когда MetaMask не подключён в MCW, DEX показывает стандартную модалку выбора кошелька
- [ ] AC5: Смена сети в MCW (chainChanged) отражается в DEX iframe
- [ ] AC6: E2E smoke тест проходит: iframe открывается, bridge detected, адрес отображается

## Ограничения
- **Cross-origin iframe:** postMessage — единственный способ коммуникации между хостом и dApp.
- **Standalone совместимость:** Все изменения в dApp не должны ломать работу без iframe. Bridge-код активируется только при наличии параметра `?walletBridge` И контекста iframe.
- **Свободная модификация dApp:** Код unifactory можно менять свободно. Другие dApp репо (definance, appsource) обновлять не нужно.
- **Безопасность:** Host-side allowlist ограничивает допустимые URL для iframe. На dApp стороне — проверка iframe контекста + URL параметра. Приватные ключи всегда на стороне wallet хоста, bridge только проксирует запросы подписи.
- **Загрузка скрипта:** dApp загружает bridge-клиент динамически с wallet-хоста или использует fallback URL (swaponline.github.io) если referrer пустой или недоступен.

## Риски
- **Timing race:** dApp может попытаться auto-connect до завершения bridge handshake, что вернёт пустой массив адресов. **Митигация:** dApp ждёт готовность bridge до 5 секунд перед вызовом auto-connect. Если таймаут — fallback на стандартный flow.
- **Поломка standalone режима:** Bridge-код может случайно активироваться вне iframe. **Митигация:** Строгая проверка bridge-параметра в URL И iframe контекста — оба условия обязательны.
- **Вредоносный iframe:** Вредоносный iframe может получить доступ к кошельку. **Митигация:** Host-side allowlist разрешает только конкретные домены. Bridge активируется только с явным URL-параметром. Приватные ключи остаются на wallet стороне — bridge только проксирует запросы подписи.
- **Ошибка загрузки скрипта:** Сетевые ошибки, CORS, CSP могут помешать загрузке bridge-клиента. **Митигация:** Fallback на стандартную модалку если скрипт не загрузился за 5 секунд.

## Технические решения
- Мы решили **загружать bridge-клиент динамически с wallet-хоста**, потому что это не требует копирования кода в dApp репо и всегда использует актуальную версию. Fallback на дефолтный URL если referrer недоступен.
- Мы решили **эмулировать MetaMask в bridge provider**, потому что dApp использует этот флаг для определения типа провайдера и отображения UI.
- Мы решили **ждать bridge handshake до 5 секунд перед auto-connect**, потому что коммуникация через postMessage асинхронна. 5 секунд — баланс между UX и надёжностью.
- Мы решили **менять код в обоих репозиториях** (MCW + unifactory), потому что bridge provider нуждается в улучшениях на MCW стороне, а dApp нуждается в логике загрузки и auto-connect.
- Мы решили **не обновлять другие dApp репозитории**, потому что достаточно unifactory — основного источника кода.
- Мы решили **при отсутствии подключённого кошелька показывать стандартную модалку**, потому что bridge не может дать адреса без провайдера на хосте.

## Тестирование

**Unit-тесты:** делаются всегда, не обсуждаются. Покрывают bridge protocol: postMessage handshake, запросы к провайдеру, форматы ответов.

**Интеграционные тесты:** не делаем — cross-origin iframe невозможно протестировать через integration tests, только через E2E.

**E2E тесты:** делаем — расширяем существующий Puppeteer smoke тест. Проверяем: после открытия Apps page внутри iframe нет wallet-модалки и есть подключённый адрес.

## Как проверить

### Агент проверяет

| Шаг | Инструмент | Ожидаемый результат |
|-----|-----------|-------------------|
| Запустить E2E smoke тест на PR preview | puppeteer | iframe открывается, bridge provider обнаружен, wallet автоподключён |
| Проверить флаги bridge provider | puppeteer | Provider эмулирует MetaMask и имеет bridge-флаги |
| Запустить unit тесты bridge protocol | jest | Все тесты проходят |

### Пользователь проверяет
- Открыть Apps page → кликнуть на dApp → убедиться что кошелёк подключён автоматически (адрес виден, баланс отображается)
- Открыть dApp напрямую (без iframe) → убедиться что работает как раньше (стандартная модалка)
- Переключить сеть в wallet → убедиться что dApp в iframe обновил сеть
