---
status: planned
depends_on: [5]
wave: 6
skills: ["code-writing"]
verify: bash
reviewers: ["code-reviewer", "security-auditor", "test-reviewer"]
---

# Task 11: WalletConnect v2 Integration

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Implement WalletConnect v2 wallet-side SDK integration in :feature:walletconnect with QR scanner, session management (24h max lifetime), transaction signing, and relay error handling.

## What to do

1. Create WalletConnectManager in :feature:walletconnect
2. Integrate WalletConnect Sign SDK (wallet role)
3. Implement QR scanner using ML Kit: scan URI, parse wc:// scheme
4. Implement pair(uri) → session proposal dialog
5. Create SessionProposalDialog: show dApp name/url/icon, chains, methods
6. Implement approveSession() — store in EncryptedSharedPreferences with createdAt timestamp
7. Implement rejectSession()
8. Implement onSessionRequest() — parse sign request, show confirmation dialog, sign, return result
9. Implement session cleanup: on app launch, delete sessions with createdAt > 24h ago
10. Handle relay errors: connection failure → show "Failed to connect to WalletConnect relay" with retry
11. Validate relay server: only relay.walletconnect.com or relay.walletconnect.org
12. Write unit tests for session lifecycle, expiry, relay validation

## TDD Anchor

tests/11_test.kt:
- testSessionProposal — pair URI → proposal parsed correctly
- testSessionExpiry — session created 25h ago → removed on app launch
- testSessionPersistence — approve session → stored, restart → restored
- testRelayValidation — relay.walletconnect.com → allowed, custom.relay.com → rejected
- testInvalidQrUri — invalid URI → error 'Invalid QR code'

## Acceptance Criteria

- [ ] All unit tests pass
- [ ] Implementation matches tech-spec requirements
- [ ] No security vulnerabilities introduced
- [ ] Code follows Android best practices

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [src/common/web3connect/providers/WalletConnectProviderV2.ts](../../src/common/web3connect/providers/WalletConnectProviderV2.ts)

## Verification Steps

1. Run: `cd android && ./gradlew test`
2. Expected: All tests pass
3. Verify implementation matches requirements from tech-spec

## Details

See tech-spec for complete implementation details for this task.

## Reviewers

- **code-reviewer** → `logs/working/task-11/code-reviewer-{round}.json`
- **security-auditor** → `logs/working/task-11/security-auditor-{round}.json`
- **test-reviewer** → `logs/working/task-11/test-reviewer-{round}.json`

## Post-completion

- [ ] Write report to decisions.md (include all review rounds with links)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
