---
status: planned
depends_on: [2, 3]
wave: 4
skills: ["code-writing"]
verify: bash
reviewers: ["code-reviewer", "security-auditor", "test-reviewer"]
---

# Task 6: BTC Operations (Balance + Transactions)

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Implement BTC balance fetching (Bitpay), UTXO selection, fee estimation (Blockcypher), transaction construction (bitcoinj), signing, and broadcast. Port algorithm patterns from web's btc.ts per Decision 11.

## What to do

1. Create BtcManager class in :core:btc
2. Implement fetchBalance(address) — call Bitpay API, parse satoshis, convert to BTC
3. Implement fetchUnspentOutputs(address) — returns List<UTXO>
4. Implement selectUtxos(amount, feeRate) — UTXO selection algorithm
5. Implement estimateFees() — call Blockcypher API, return BtcFeeRates (fast/normal/slow sat/KB)
6. Implement buildTransaction(recipient, amount, feeRate, utxos, changeAddress) — use bitcoinj Transaction builder
7. Implement signTransaction(tx, privateKeyWIF) — sign all inputs
8. Implement broadcastTransaction(signedTx) — POST to Bitpay /tx/send
9. Handle change outputs: if change < 546 sat (DUST), add to fee instead
10. Write unit tests for UTXO selection, fee calculation, tx construction

## TDD Anchor

tests/6_test.kt:
- testFetchBalance — parse Bitpay response, verify satoshis → BTC conversion
- testUtxoSelectionSingleInput — 1 UTXO covers amount+fee → selected
- testUtxoSelectionMultipleInputs — combine multiple UTXOs to reach amount
- testUtxoSelectionInsufficientFunds — total < amount+fee → error
- testChangeHandlingDust — change < 546 sat → added to fee, no change output
- testFeeCalculation — verify max(546, feeRate * txSize / 1024) formula
- testTransactionConstruction — verify correct inputs/outputs structure

## Acceptance Criteria

- [ ] All unit tests pass
- [ ] Implementation matches tech-spec requirements
- [ ] No security vulnerabilities introduced
- [ ] Code follows Android best practices

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [src/common/utils/coin/btc.ts](../../src/common/utils/coin/btc.ts)
- [src/common/helpers/constants/TRANSACTION.ts](../../src/common/helpers/constants/TRANSACTION.ts)

## Verification Steps

1. Run: `cd android && ./gradlew test`
2. Expected: All tests pass
3. Verify implementation matches requirements from tech-spec

## Details

See tech-spec for complete implementation details for this task.

## Reviewers

- **code-reviewer** → `logs/working/task-6/code-reviewer-{round}.json`
- **security-auditor** → `logs/working/task-6/security-auditor-{round}.json`
- **test-reviewer** → `logs/working/task-6/test-reviewer-{round}.json`

## Post-completion

- [ ] Write report to decisions.md (include all review rounds with links)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
