---
status: planned
depends_on: [5]
wave: 6
skills: ["code-writing"]
verify: bash
reviewers: ["code-reviewer", "security-auditor", "test-reviewer"]
---

# Task 10: dApp Browser + window.ethereum Provider

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Implement WebView-based dApp browser in :feature:dapp-browser with injected window.ethereum EIP-1193 provider, JS-to-Native bridge with origin validation and rate limiting, domain whitelisting, transaction confirmation with function signature decoding, and WebView security hardening per Decision 9.

## What to do

1. Create DAppBrowserScreen with WebView
2. Configure WebView security settings per Decision 9: allowFileAccess=false, mixedContentMode=MIXED_CONTENT_NEVER_ALLOW, geolocationEnabled=false
3. Implement window.ethereum injection via shouldInterceptRequest() — inject as first <script> in <head> with Object.freeze(window.ethereum)
4. Create EthereumProvider class with @JavascriptInterface exposing single request(method, params) method
5. Implement EIP-1193 methods: eth_requestAccounts, eth_accounts, eth_chainId, eth_sendTransaction, personal_sign, eth_signTypedData_v4, wallet_switchEthereumChain, wallet_addEthereumChain
6. Reject eth_sign (deprecated, unsafe)
7. Validate origin on every bridge call: check WebView.url matches approved origin
8. Implement rate limiting: 10 calls/sec, queue excess
9. Implement gas thresholds: gasLimit > 1M → warning, > 15M → reject
10. Domain policy: unknown domains blocked, show warning
11. Transaction confirmation dialog: decode function signatures (transfer, approve, swap), show human-readable details
12. Write unit tests for RPC parsing, origin validation, rate limiting, gas thresholds

## TDD Anchor

tests/10_test.kt:
- testWindowEthereumInjection — load HTML, verify window.ethereum exists
- testOriginValidation — call from different origin → rejected
- testRateLimiting — 15 rapid calls → 5 queued
- testGasWarning — gasLimit=1,000,001 → warning shown
- testGasReject — gasLimit=15,000,001 → rejected with error
- testEthSignRejection — eth_sign call → error 'Unsupported method'
- testWalletAddEthereumChainAllowlist — chainId 1/56/137 → allowed, 999 → rejected

## Acceptance Criteria

- [ ] All unit tests pass
- [ ] Implementation matches tech-spec requirements
- [ ] No security vulnerabilities introduced
- [ ] Code follows Android best practices

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [src/common/web3connect/providers/InjectedProvider.ts](../../src/common/web3connect/providers/InjectedProvider.ts)
- [src/common/web3connect/index.ts](../../src/common/web3connect/index.ts)

## Verification Steps

1. Run: `cd android && ./gradlew test`
2. Expected: All tests pass
3. Verify implementation matches requirements from tech-spec

## Details

See tech-spec for complete implementation details for this task.

## Reviewers

- **code-reviewer** → `logs/working/task-10/code-reviewer-{round}.json`
- **security-auditor** → `logs/working/task-10/security-auditor-{round}.json`
- **test-reviewer** → `logs/working/task-10/test-reviewer-{round}.json`

## Post-completion

- [ ] Write report to decisions.md (include all review rounds with links)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
