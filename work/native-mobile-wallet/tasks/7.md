---
status: planned
depends_on: [2, 3]
wave: 4
skills: ["code-writing"]
verify: bash
reviewers: ["code-reviewer", "security-auditor", "test-reviewer"]
---

# Task 7: EVM Operations (Balance + Transactions + Fiat)

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Implement EVM balance fetching (web3j eth_getBalance), ERC20 token balances (contract balanceOf), CoinGecko fiat prices, gas estimation, transaction signing, and broadcast. No persistent caching.

## What to do

1. Create EvmManager class in :core:evm
2. Implement fetchBalance(address, chain) — eth_getBalance via web3j, wei → ETH conversion
3. Implement fetchTokenBalance(address, tokenContract, chain) — contract.balanceOf(), apply decimals
4. Implement fetchFiatPrices(symbols) — CoinGecko API, returns Map<symbol, price>
5. Implement estimateGas(tx, chain) — eth_gasPrice + eth_estimateGas, 1.05x buffer for token transfers
6. Implement buildTransaction(to, amount, gasPrice, gasLimit, chainId) — create RawTransaction
7. Implement signTransaction(tx, privateKeyHex) — web3j Credentials.signTransaction()
8. Implement broadcastTransaction(signedTx, chain) — eth_sendRawTransaction
9. Handle offline mode: API errors return null for balances, display "N/A" in UI
10. Write unit tests for balance parsing, CoinGecko parsing, gas estimation

## TDD Anchor

tests/7_test.kt:
- testFetchBalance — parse eth_getBalance response, wei → ETH
- testFetchTokenBalance — parse balanceOf response with decimals (6, 8, 18)
- testCoinGeckoParsing — parse API response, extract BTC/ETH/BNB/MATIC prices
- testGasEstimationNative — native transfer → gasLimit = estimate (no buffer)
- testGasEstimationToken — token transfer → gasLimit = estimate * 1.05
- testOfflineMode — API error → balance = null, no crash
- testFiatCalculation — 1.5 BTC * $50000 = $75000.00

## Acceptance Criteria

- [ ] All unit tests pass
- [ ] Implementation matches tech-spec requirements
- [ ] No security vulnerabilities introduced
- [ ] Code follows Android best practices

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [src/front/shared/redux/actions/ethLikeAction.ts](../../src/front/shared/redux/actions/ethLikeAction.ts)
- [src/front/shared/redux/actions/erc20LikeAction.ts](../../src/front/shared/redux/actions/erc20LikeAction.ts)
- [src/common/helpers/constants/DEFAULT_CURRENCY_PARAMETERS.ts](../../src/common/helpers/constants/DEFAULT_CURRENCY_PARAMETERS.ts)

## Verification Steps

1. Run: `cd android && ./gradlew test`
2. Expected: All tests pass
3. Verify implementation matches requirements from tech-spec

## Details

See tech-spec for complete implementation details for this task.

## Reviewers

- **code-reviewer** → `logs/working/task-7/code-reviewer-{round}.json`
- **security-auditor** → `logs/working/task-7/security-auditor-{round}.json`
- **test-reviewer** → `logs/working/task-7/test-reviewer-{round}.json`

## Post-completion

- [ ] Write report to decisions.md (include all review rounds with links)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
