---
status: done
depends_on: [1]
wave: 2
skills: ["code-writing"]
verify: bash
reviewers: ["code-reviewer", "security-auditor", "test-reviewer"]
---

# Task 2: Crypto Core — BIP39/BIP44 Key Derivation

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)


## Description

Implement BIP39 mnemonic generation/validation and BIP44 key derivation for BTC and ETH in :core:crypto module using bitcoinj and web3j. This module must produce identical BTC P2PKH addresses and ETH addresses as the web wallet for the same mnemonic (cross-platform compatibility constraint per Decision 11).

BTC uses path m/44'/0'/0'/0/0 (P2PKH format, addresses start with '1' on mainnet). ETH uses path m/44'/60'/0'/0/0. The single ETH private key is reused across all EVM chains (ETH, BSC, Polygon).

## What to do

1. Create CryptoManager class in :core:crypto module
2. Implement generateMnemonic() using bitcoinj MnemonicCode — returns 12 BIP39 words
3. Implement validateMnemonic(mnemonic: String) — validates word count, wordlist, and checksum
4. Implement deriveBtcKey(mnemonic: String) — derives BTC key at m/44'/0'/0'/0/0 using bitcoinj, returns WIF private key and P2PKH address
5. Implement deriveEthKey(mnemonic: String) — derives ETH key at m/44'/60'/0'/0/0 using web3j Bip32ECKeyPair, returns hex private key and checksummed address
6. Implement deriveKeys(mnemonic: String) returning WalletKeys data class with all keys
7. Create WalletKeys data class (mnemonic, btcPrivateKeyWIF, btcAddress, ethPrivateKeyHex, ethAddress)
8. Write unit tests comparing output against known web wallet addresses for reference mnemonics

## TDD Anchor

tests/core/crypto/CryptoManagerTest.kt:
- testGenerateMnemonic — verify 12 words, all in BIP39 wordlist, different each time
- testValidateMnemonic — valid mnemonic passes, wrong word count fails, non-wordlist word fails
- testDeriveBtcKeyFromKnownMnemonic — "abandon abandon abandon..." → verify matches web wallet BTC address (cross-platform test)
- testDeriveEthKeyFromKnownMnemonic — same mnemonic → verify matches web wallet ETH address (checksummed)
- testSingleEthKeyAcrossChains — verify same ETH private key produces same address
- testBtcPathParameter — verify m/44'/0'/0'/0/1 produces different address than m/44'/0'/0'/0/0
- testInvalidMnemonicBadChecksum — bad checksum fails with checksum error message
- testInvalidMnemonicWrongWordCount — 11 words fails, 13 words fails

## Acceptance Criteria

- [ ] generateMnemonic() returns 12 valid BIP39 words
- [ ] validateMnemonic() correctly validates word count, wordlist, and checksum
- [ ] deriveBtcKey() produces P2PKH address (starting with '1' on mainnet) matching web wallet output for known mnemonic
- [ ] deriveEthKey() produces checksummed address matching web wallet output
- [ ] All unit tests pass including cross-platform validation tests
- [ ] WalletKeys data class contains all required fields


## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)

## Verification Steps

1. Run: cd android && ./gradlew :core:crypto:test
2. Expected: All tests pass, specifically cross-platform validation tests show addresses match web wallet
3. Verify test output includes known mnemonic → known BTC address comparison
4. Verify test output includes known mnemonic → known ETH address comparison

## Details

**Reference implementation (web wallet):**
- src/common/utils/mnemonic.ts — getBtcWallet(), getEthLikeWallet()
- BTC: uses bitcoinjs-lib bitcoin.payments.p2pkh() at m/44'/0'/0'/0/0
- ETH: uses ethereumjs-wallet hdkey at m/44'/60'/0'/0/0

**Kotlin implementation:**
- Use bitcoinj MnemonicCode.INSTANCE.generateMnemonic() for 12-word generation
- BTC: bitcoinj BIP32.derivePath("m/44'/0'/0'/0/0"), then LegacyAddress.fromKey()
- ETH: web3j Bip32ECKeyPair.derivePath(List.of(...path indices...)), then Keys.toChecksumAddress()

**Known test mnemonic (from BIP39 spec):**
"abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about"
Expected BTC address (mainnet): check against web wallet output
Expected ETH address: check against web wallet output

**Edge cases:**
- Mnemonic with leading/trailing whitespace — should be trimmed
- Mnemonic with multiple spaces between words — should be normalized
- Mixed case mnemonic — should be lowercased
- 11 words — reject with "Invalid word count: expected 12, got 11"
- 13 words — reject
- Invalid word — reject with "Word 'xyz' not in BIP39 wordlist"
- Bad checksum — reject with "Invalid mnemonic checksum"

**WalletKeys data class:**
```kotlin
data class WalletKeys(
    val mnemonic: List<String>,
    val btcPrivateKeyWIF: String,
    val btcAddress: String,
    val ethPrivateKeyHex: String,  // 0x-prefixed
    val ethAddress: String         // 0x-prefixed checksummed
)
```

**bitcoinj network:**
Use MainNetParams for mainnet, TestNet3Params for testnet

**Cross-platform constraint (P0):**
This is the most critical test. If addresses don't match, users importing web wallet mnemonics will see empty wallets. Test with multiple known mnemonics, not just "abandon".

## Reviewers

- **code-reviewer** → `logs/working/task-2/code-reviewer-{round}.json`
- **security-auditor** → `logs/working/task-2/security-auditor-{round}.json`
- **test-reviewer** → `logs/working/task-2/test-reviewer-{round}.json`


## Post-completion

- [ ] Write report to decisions.md (include all review rounds with links)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
