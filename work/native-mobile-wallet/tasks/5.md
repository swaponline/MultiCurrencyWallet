---
status: planned
depends_on: [2]
wave: 3
skills: ["code-writing"]
verify: bash
reviewers: ["code-reviewer", "security-auditor", "test-reviewer"]
---

# Task 5: Network Layer + API Failover

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Implement OkHttp-based network layer in :core:network with round-robin failover interceptor ported from web's apiLooper. Configure Retrofit interfaces for Bitpay, Etherscan, Blockcypher, CoinGecko APIs. Add custom RPC URL validation: HTTPS only, block private IPs, warn user.

## What to do

1. Create ApiFailoverInterceptor implementing OkHttp Interceptor
2. Port round-robin endpoint switching from web's apiLooper.ts
3. Implement 500ms request queuing between failed requests
4. Implement endpoint health tracking (in-memory, resets on app restart)
5. Create Retrofit interfaces: BitpayApi, EtherscanApi, BlockcypherApi, CoinGeckoApi
6. Implement RPC URL validation: HTTPS only, reject http://, file://, block private IPs (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 127.0.0.0/8)
7. Create ApiConfig data classes for endpoints
8. Write unit tests for failover logic and URL validation

## TDD Anchor

tests/5_test.kt:
- testFailoverSwitchesEndpoint — first endpoint fails → switches to second
- testRequestQueuing — verify ≥500ms delay between retry requests
- testEndpointHealthTracking — failed endpoint skipped on next request
- testUrlValidationHttps — https://example.com → allowed
- testUrlValidationHttp — http://example.com → rejected
- testUrlValidationPrivateIP — https://192.168.1.1 → rejected
- testUrlValidationLocalhost — https://127.0.0.1 → rejected

## Acceptance Criteria

- [ ] All unit tests pass
- [ ] Implementation matches tech-spec requirements
- [ ] No security vulnerabilities introduced
- [ ] Code follows Android best practices

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [src/common/utils/apiLooper.ts](../../src/common/utils/apiLooper.ts)
- [src/front/config/mainnet/api.js](../../src/front/config/mainnet/api.js)
- [src/front/config/mainnet/web3.js](../../src/front/config/mainnet/web3.js)

## Verification Steps

1. Run: `cd android && ./gradlew test`
2. Expected: All tests pass
3. Verify implementation matches requirements from tech-spec

## Details

See tech-spec for complete implementation details for this task.

## Reviewers

- **code-reviewer** → `logs/working/task-5/code-reviewer-{round}.json`
- **security-auditor** → `logs/working/task-5/security-auditor-{round}.json`
- **test-reviewer** → `logs/working/task-5/test-reviewer-{round}.json`

## Post-completion

- [ ] Write report to decisions.md (include all review rounds with links)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
