---
status: done
depends_on: [1]
wave: 2
skills: [code-writing]
verify: bash
reviewers: [code-reviewer, security-auditor, test-reviewer]
---

# Task 3: Secure Storage + App Password

## Required Skills

Before starting, load:
- `/skill:code-writing` — [~/.claude/skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Implement EncryptedSharedPreferences wrapper in `:core:storage` module for wallet keys and app password using bcrypt with cost factor 12 (minimum 8 characters). Handle Android KeyStore corruption gracefully by showing "reimport seed" message and clearing corrupted storage.

This module provides secure persistent storage for sensitive data: mnemonic, BTC/ETH private keys, bcrypt password hash, WalletConnect sessions, and user preferences.

## What to do

1. Create SecureStorage class in `:core:storage` wrapping EncryptedSharedPreferences
2. Implement saveMnemonic(words: List<String>) — stores space-separated 12 words
3. Implement getMnemonic() — returns List<String> or null
4. Implement savePrivateKeys(btcWIF: String, ethHex: String)
5. Implement getPrivateKeys() — returns Pair<String, String> or null
6. Implement savePasswordHash(hash: String) — stores bcrypt hash
7. Implement getPasswordHash() — returns String or null
8. Implement saveWalletConnectSessions(json: String)
9. Implement getWalletConnectSessions() — returns String or null
10. Handle EncryptedSharedPreferences decryption failures (KeyStore corruption) — catch exception, show error dialog with "Wallet data corrupted, please reimport your seed phrase", clear all encrypted storage
11. Implement clearAll() — wipes all encrypted data
12. Write unit tests for read/write cycles and corruption handling

## TDD Anchor

tests/core/storage/SecureStorageTest.kt:
- testSaveAndRetrieveMnemonic — save 12 words, retrieve, verify match
- testSaveAndRetrievePrivateKeys — save BTC/ETH keys, retrieve, verify match
- testPasswordHashStorage — save bcrypt hash (verify $2a$12$ prefix), retrieve, verify match
- testClearAllRemovesData — save data, clear, verify all getters return null
- testKeystoreCorruptionHandling — mock decryption failure, verify error thrown with specific message, verify clearAll() called
- testMultipleReadWriteCycles — save, read, overwrite, read again — verify latest data returned

## Acceptance Criteria

- [ ] SecureStorage class uses EncryptedSharedPreferences backed by Android KeyStore
- [ ] saveMnemonic() and getMnemonic() work correctly
- [ ] savePrivateKeys() and getPrivateKeys() work correctly
- [ ] savePasswordHash() stores bcrypt hash with cost 12 ($2a$12$ prefix)
- [ ] Decryption failure shows "Wallet data corrupted, please reimport your seed phrase" and clears storage
- [ ] clearAll() removes all encrypted data
- [ ] All unit tests pass

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)

## Verification Steps

1. Run: `cd android && ./gradlew :core:storage:test`
2. Expected: All tests pass
3. Verify test output shows KeyStore corruption test passes with error message displayed
4. Verify password hash test shows $2a$12$ prefix in hash

## Details

**AndroidX Security library:**
- Use `androidx.security:security-crypto:1.1.0-alpha06`
- EncryptedSharedPreferences with AES256-GCM encryption
- MasterKey backed by Android KeyStore

**EncryptedSharedPreferences setup:**
```kotlin
val masterKey = MasterKey.Builder(context)
    .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)
    .build()

val sharedPreferences = EncryptedSharedPreferences.create(
    context,
    "wallet_secure_storage",
    masterKey,
    EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
    EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
)
```

**Storage keys:**
| Key | Type | Content |
|-----|------|---------|
| `wallet_mnemonic` | String | Space-separated 12 words |
| `wallet_btc_wif` | String | BTC private key (WIF format) |
| `wallet_eth_hex` | String | ETH private key (0x hex) |
| `app_password_hash` | String | bcrypt hash of app password |
| `wc_sessions` | String | JSON array of WalletConnect sessions |
| `active_chain_id` | Long | Currently selected EVM chain ID |

**KeyStore corruption handling:**
- Catch `GeneralSecurityException` during get operations
- Show AlertDialog: "Wallet data corrupted, please reimport your seed phrase"
- Call `clearAll()` to wipe corrupted encrypted storage
- Return null from getter that failed

**bcrypt password hash:**
- Use jbcrypt library: `org.mindrot:jbcrypt:0.4`
- Cost factor 12: `BCrypt.hashpw(password, BCrypt.gensalt(12))`
- Verification: `BCrypt.checkpw(password, storedHash)`
- Hash format: `$2a$12$...` (60 characters)

**Edge cases:**
- getMnemonic() when no mnemonic saved → return null
- getPrivateKeys() when only one key saved → return null (both must exist)
- KeyStore unavailable on device → fallback error message
- Empty string saved → treated as valid (caller validates)

**Implementation hints:**
- Use `sharedPreferences.getString(key, null)` for retrieval
- Mnemonic: join List<String> with space, split by space on retrieval
- Private keys: store separately with different keys (wallet_btc_wif, wallet_eth_hex)
- Use Hilt @Singleton for SecureStorage injection
- Context required for EncryptedSharedPreferences — inject ApplicationContext

## Reviewers

- **code-reviewer** → `logs/working/task-3/code-reviewer-{round}.json`
- **security-auditor** → `logs/working/task-3/security-auditor-{round}.json`
- **test-reviewer** → `logs/working/task-3/test-reviewer-{round}.json`

## Post-completion

- [ ] Write report to decisions.md (include all review rounds with links)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
