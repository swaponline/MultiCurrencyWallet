{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swaps\\UTXOBlockchain.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swaps\\UTXOBlockchain.ts","mtime":1614842913771},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF90eXBlb2YgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy90eXBlb2YiOwppbXBvcnQgX2FzeW5jVG9HZW5lcmF0b3IgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9hc3luY1RvR2VuZXJhdG9yIjsKaW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NsYXNzQ2FsbENoZWNrIjsKaW1wb3J0IF9jcmVhdGVDbGFzcyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NyZWF0ZUNsYXNzIjsKaW1wb3J0IF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQiOwppbXBvcnQgX2dldCBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldCI7CmltcG9ydCBfaW5oZXJpdHMgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9pbmhlcml0cyI7CmltcG9ydCBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4iOwppbXBvcnQgX2dldFByb3RvdHlwZU9mIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0UHJvdG90eXBlT2YiOwppbXBvcnQgX2RlZmluZVByb3BlcnR5IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZGVmaW5lUHJvcGVydHkiOwoKZnVuY3Rpb24gb3duS2V5cyhvYmplY3QsIGVudW1lcmFibGVPbmx5KSB7IHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqZWN0KTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIHN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKG9iamVjdCk7IGlmIChlbnVtZXJhYmxlT25seSkgc3ltYm9scyA9IHN5bWJvbHMuZmlsdGVyKGZ1bmN0aW9uIChzeW0pIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBzeW0pLmVudW1lcmFibGU7IH0pOyBrZXlzLnB1c2guYXBwbHkoa2V5cywgc3ltYm9scyk7IH0gcmV0dXJuIGtleXM7IH0KCmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQodGFyZ2V0KSB7IGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7IHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV0gIT0gbnVsbCA/IGFyZ3VtZW50c1tpXSA6IHt9OyBpZiAoaSAlIDIpIHsgb3duS2V5cyhPYmplY3Qoc291cmNlKSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7IF9kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc291cmNlW2tleV0pOyB9KTsgfSBlbHNlIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycykgeyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHNvdXJjZSkpOyB9IGVsc2UgeyBvd25LZXlzKE9iamVjdChzb3VyY2UpKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHNvdXJjZSwga2V5KSk7IH0pOyB9IH0gcmV0dXJuIHRhcmdldDsgfQoKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgeyBTd2FwSW50ZXJmYWNlLCBjb25zdGFudHMsIHV0aWwgfSBmcm9tICdzd2FwLmFwcCc7CmltcG9ydCBCaWdOdW1iZXIgZnJvbSAnYmlnbnVtYmVyLmpzJzsKCnZhciBVVFhPQmxvY2tjaGFpbiA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoX1N3YXBJbnRlcmZhY2UpIHsKICBfaW5oZXJpdHMoVVRYT0Jsb2NrY2hhaW4sIF9Td2FwSW50ZXJmYWNlKTsKCiAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihVVFhPQmxvY2tjaGFpbik7CgogIC8qKg0KICAgKg0KICAgKiBAcGFyYW0gb3B0aW9ucw0KICAgKiBAcGFyYW0gb3B0aW9ucy5mZXRjaEJhbGFuY2UNCiAgICogQHBhcmFtIG9wdGlvbnMuZmV0Y2hVbnNwZW50cw0KICAgKiBAcGFyYW0gb3B0aW9ucy5icm9hZGNhc3RUeA0KICAgKiBAcGFyYW0gb3B0aW9ucy5mZXRjaFR4SW5mbyB7KHR4X2hhc2gpID0+IFByb21pc2UoeyBjb25maWRlbmNlLCBmZWVzIH0pfQ0KICAgKiBAcGFyYW0gb3B0aW9ucy5lc3RpbWF0ZUZlZVZhbHVlIHsgKHsgaW5TYXRvc2hpcywgc3BlZWQsIGFkZHJlc3MsIHR4U2l6ZSB9KSA9PiBQcm9taXNlKGZlZV92YWx1ZSkgfQ0KICAgKi8KICBmdW5jdGlvbiBVVFhPQmxvY2tjaGFpbihvcHRpb25zKSB7CiAgICB2YXIgX3RoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIFVUWE9CbG9ja2NoYWluKTsKCiAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIl9zd2FwTmFtZSIsIG51bGwpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImZldGNoQmFsYW5jZSIsIHVuZGVmaW5lZCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZmV0Y2hVbnNwZW50cyIsIHVuZGVmaW5lZCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiYnJvYWRjYXN0VHgiLCB1bmRlZmluZWQpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImNoZWNrV2l0aGRyYXciLCB1bmRlZmluZWQpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImZlZVZhbHVlIiwgNTQ2KTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJmZXRjaFR4SW5mbyIsIHVuZGVmaW5lZCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZXN0aW1hdGVGZWVWYWx1ZSIsIHVuZGVmaW5lZCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiYWNjb3VudCIsIHVuZGVmaW5lZCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAibmV0d29ya3MiLCB1bmRlZmluZWQpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIm5ldHdvcmsiLCB1bmRlZmluZWQpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInNraXBGZXRjaENvbmZpZGVuY2UiLCBmYWxzZSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAic2tpcENoZWNrQ2FuQmVSZXBsYWNlcyIsIGZhbHNlKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJza2lwTG9ja1RpbWUiLCBmYWxzZSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAic2tpcFJlY2lwaWVudFB1YmxpY2tLZXkiLCBmYWxzZSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAicHJvY2Vzc1Vuc3BlbnQiLCB1bmRlZmluZWQpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInNlbmRUcmFuc2FjdGlvbiIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiYXBwIiwgdW5kZWZpbmVkKTsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZmV0Y2hCYWxhbmNlICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQnRjU3dhcDogImZldGNoQmFsYW5jZSIgcmVxdWlyZWQnKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZmV0Y2hVbnNwZW50cyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J0Y1N3YXA6ICJmZXRjaFVuc3BlbnRzIiByZXF1aXJlZCcpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5icm9hZGNhc3RUeCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0J0Y1N3YXA6ICJicm9hZGNhc3RUeCIgcmVxdWlyZWQnKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZmV0Y2hUeEluZm8gIT09ICdmdW5jdGlvbicpIHsKICAgICAgLy8gdHhfaGFzaCA9PiB7IGNvbmZpZGVuY2UsIGZlZXMgfQogICAgICBjb25zb2xlLndhcm4oIkJ0Y1N3YXA6IFwiZmV0Y2hUeEluZm9cIiBpcyBub3QgYSBmdW5jdGlvbi4gWW91IHdpbGwgbm90IGJlIGFibGUgdG8gdXNlIHR4LWNvbmZpZGVuY2UgZmVhdHVyZSIpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5lc3RpbWF0ZUZlZVZhbHVlICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIC8vICh7IHNwZWVkIH0gPSB7fSkgPT4gZmVlUmF0ZQogICAgICBjb25zb2xlLndhcm4oIkJ0Y1N3YXA6IFwiZXN0aW1hdGVGZWVWYWx1ZVwiIGlzIG5vdCBhIGZ1bmN0aW9uLiBZb3Ugd2lsbCBub3QgYmUgYWJsZSB1c2UgYXV0b21hdGljIG1lbXBvb2wtYmFzZWQgZmVlIik7CiAgICB9CgogICAgX3RoaXMuX3N3YXBOYW1lID0gb3B0aW9ucy5zd2FwTmFtZSB8fCBjb25zdGFudHMuQ09JTlMuYnRjOwogICAgX3RoaXMuZmV0Y2hCYWxhbmNlID0gb3B0aW9ucy5mZXRjaEJhbGFuY2U7CiAgICBfdGhpcy5mZXRjaFVuc3BlbnRzID0gb3B0aW9ucy5mZXRjaFVuc3BlbnRzOwogICAgX3RoaXMuYnJvYWRjYXN0VHggPSBvcHRpb25zLmJyb2FkY2FzdFR4OwogICAgX3RoaXMuY2hlY2tXaXRoZHJhdyA9IG9wdGlvbnMuY2hlY2tXaXRoZHJhdzsKICAgIF90aGlzLmZlZVZhbHVlID0gb3B0aW9ucy5mZWVWYWx1ZSB8fCA1NDY7CgogICAgX3RoaXMuZmV0Y2hUeEluZm8gPSBvcHRpb25zLmZldGNoVHhJbmZvIHx8IGZ1bmN0aW9uICgpIHt9OwoKICAgIF90aGlzLmVzdGltYXRlRmVlVmFsdWUgPSBvcHRpb25zLmVzdGltYXRlRmVlVmFsdWUgfHwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gMDsKICAgIH07CgogICAgX3RoaXMuYWNjb3VudCA9IG9wdGlvbnMuYWNjb3VudCB8fCAiYnRjIjsKICAgIF90aGlzLm5ldHdvcmtzID0gb3B0aW9ucy5uZXR3b3JrczsKICAgIF90aGlzLnNraXBGZXRjaENvbmZpZGVuY2UgPSBvcHRpb25zLnNraXBGZXRjaENvbmZpZGVuY2UgfHwgZmFsc2U7CiAgICBfdGhpcy5za2lwQ2hlY2tDYW5CZVJlcGxhY2VzID0gb3B0aW9ucy5za2lwQ2hlY2tDYW5CZVJlcGxhY2VzIHx8IGZhbHNlOwogICAgX3RoaXMuc2tpcExvY2tUaW1lID0gb3B0aW9ucy5za2lwTG9ja1RpbWUgfHwgZmFsc2U7CiAgICBfdGhpcy5za2lwUmVjaXBpZW50UHVibGlja0tleSA9IG9wdGlvbnMuc2tpcFJlY2lwaWVudFB1YmxpY2tLZXkgfHwgZmFsc2U7CgogICAgX3RoaXMucHJvY2Vzc1Vuc3BlbnQgPSBvcHRpb25zLnByb2Nlc3NVbnNwZW50IHx8IGZ1bmN0aW9uICh1bnNwZW50KSB7CiAgICAgIHZhciB0eGlkID0gdW5zcGVudC50eGlkLAogICAgICAgICAgdm91dCA9IHVuc3BlbnQudm91dDsKICAgICAgcmV0dXJuIHsKICAgICAgICB0eGlkOiB0eGlkLAogICAgICAgIHZvdXQ6IHZvdXQKICAgICAgfTsKICAgIH07CgogICAgX3RoaXMuc2VuZFRyYW5zYWN0aW9uID0gb3B0aW9ucy5zZW5kVHJhbnNhY3Rpb247CiAgICByZXR1cm4gX3RoaXM7CiAgfQoKICBfY3JlYXRlQ2xhc3MoVVRYT0Jsb2NrY2hhaW4sIFt7CiAgICBrZXk6ICJfaW5pdFN3YXAiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9pbml0U3dhcChhcHApIHsKICAgICAgX2dldChfZ2V0UHJvdG90eXBlT2YoVVRYT0Jsb2NrY2hhaW4ucHJvdG90eXBlKSwgIl9pbml0U3dhcCIsIHRoaXMpLmNhbGwodGhpcywgYXBwKTsKCiAgICAgIHRoaXMuYXBwID0gYXBwOwogICAgICAvKiBpbml0IG5ldHdvcmtzIGlmIG5lZWQgKi8KCiAgICAgIHZhciBfdGhpcyRuZXR3b3JrcyA9IHRoaXMubmV0d29ya3MsCiAgICAgICAgICBfdGhpcyRuZXR3b3JrcyRtYWluID0gX3RoaXMkbmV0d29ya3MubWFpbiwKICAgICAgICAgIG1haW5OYW1lID0gX3RoaXMkbmV0d29ya3MkbWFpbi5uYW1lLAogICAgICAgICAgbWFpblBhcmFtcyA9IF90aGlzJG5ldHdvcmtzJG1haW4ucGFyYW1zLAogICAgICAgICAgX3RoaXMkbmV0d29ya3MkdGVzdCA9IF90aGlzJG5ldHdvcmtzLnRlc3QsCiAgICAgICAgICB0ZXN0TmFtZSA9IF90aGlzJG5ldHdvcmtzJHRlc3QubmFtZSwKICAgICAgICAgIHRlc3RQYXJhbXMgPSBfdGhpcyRuZXR3b3JrcyR0ZXN0LnBhcmFtczsKICAgICAgaWYgKG1haW5OYW1lICYmIG1haW5QYXJhbXMpIHRoaXMuYXBwLmVudi5iaXRjb2luLm5ldHdvcmtzW21haW5OYW1lXSA9IG1haW5QYXJhbXM7CiAgICAgIGlmICh0ZXN0TmFtZSAmJiB0ZXN0UGFyYW1zKSB0aGlzLmFwcC5lbnYuYml0Y29pbi5uZXR3b3Jrc1t0ZXN0TmFtZV0gPSB0ZXN0UGFyYW1zOwogICAgICB0aGlzLm5ldHdvcmsgPSB0aGlzLmFwcC5pc01haW5OZXQoKSA/IHRoaXMuYXBwLmVudi5iaXRjb2luLm5ldHdvcmtzW21haW5OYW1lXSA6IHRoaXMuYXBwLmVudi5iaXRjb2luLm5ldHdvcmtzW3Rlc3ROYW1lXTsKICAgIH0KICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMNCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9wdGlvbnMuaW5TYXRvc2hpcw0KICAgICAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLnNpemUNCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5zcGVlZA0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLmFkZHJlc3MNCiAgICAgKiBAcmV0dXJucyB7QmlnTnVtYmVyfQ0KICAgICAqIEBwdWJsaWMNCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0VHhGZWUiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9nZXRUeEZlZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUoX3JlZikgewogICAgICAgIHZhciBpblNhdG9zaGlzLCBzaXplLCBfcmVmJHNwZWVkLCBzcGVlZCwgYWRkcmVzcywgZXN0aW1hdGVkRmVlUmF3LCBlc3RpbWF0ZWRGZWU7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBpblNhdG9zaGlzID0gX3JlZi5pblNhdG9zaGlzLCBzaXplID0gX3JlZi5zaXplLCBfcmVmJHNwZWVkID0gX3JlZi5zcGVlZCwgc3BlZWQgPSBfcmVmJHNwZWVkID09PSB2b2lkIDAgPyAnZmFzdCcgOiBfcmVmJHNwZWVkLCBhZGRyZXNzID0gX3JlZi5hZGRyZXNzOwogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDM7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lc3RpbWF0ZUZlZVZhbHVlKHsKICAgICAgICAgICAgICAgICAgaW5TYXRvc2hpczogdHJ1ZSwKICAgICAgICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcywKICAgICAgICAgICAgICAgICAgc3BlZWQ6IHNwZWVkLAogICAgICAgICAgICAgICAgICBtZXRob2Q6ICdzd2FwJywKICAgICAgICAgICAgICAgICAgdHhTaXplOiBzaXplCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgZXN0aW1hdGVkRmVlUmF3ID0gX2NvbnRleHQuc2VudDsKICAgICAgICAgICAgICAgIGVzdGltYXRlZEZlZSA9IG5ldyBCaWdOdW1iZXIoZXN0aW1hdGVkRmVlUmF3KTsKICAgICAgICAgICAgICAgIHRoaXMuZmVlVmFsdWUgPSBlc3RpbWF0ZWRGZWUudG9OdW1iZXIoKTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIGluU2F0b3NoaXMgPyBlc3RpbWF0ZWRGZWUgOiBlc3RpbWF0ZWRGZWUuZGl2aWRlZEJ5KDFlOCkuZHAoMCwgQmlnTnVtYmVyLlJPVU5EX1VQKSk7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBnZXRUeEZlZShfeCkgewogICAgICAgIHJldHVybiBfZ2V0VHhGZWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGdldFR4RmVlOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7YXJyYXl9IHVuc3BlbnRzDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGV4cGVjdGVkQ29uZmlkZW5jZUxldmVsDQogICAgICogQHJldHVybnMge2FycmF5fQ0KICAgICAqIEBwcml2YXRlDQogICAgICovCgogIH0sIHsKICAgIGtleTogImZpbHRlckNvbmZpZGVudFVuc3BlbnRzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfZmlsdGVyQ29uZmlkZW50VW5zcGVudHMgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNCh1bnNwZW50cykgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB2YXIgZXhwZWN0ZWRDb25maWRlbmNlTGV2ZWwsCiAgICAgICAgICAgIGZlZXNUb0NvbmZpZGVuY2UsCiAgICAgICAgICAgIGZldGNoQ29uZmlkZW5jZSwKICAgICAgICAgICAgY29uZmlkZW5jZXMsCiAgICAgICAgICAgIF9hcmdzNCA9IGFyZ3VtZW50czsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU0JChfY29udGV4dDQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ0LnByZXYgPSBfY29udGV4dDQubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGV4cGVjdGVkQ29uZmlkZW5jZUxldmVsID0gX2FyZ3M0Lmxlbmd0aCA+IDEgJiYgX2FyZ3M0WzFdICE9PSB1bmRlZmluZWQgPyBfYXJnczRbMV0gOiAwLjk1OwoKICAgICAgICAgICAgICAgIGZlZXNUb0NvbmZpZGVuY2UgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgX3JlZjIgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMihmZWVzLCBzaXplLCBhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRGYXN0ZXN0RmVlOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVlcyA9IG5ldyBCaWdOdW1iZXIoZmVlcykubXVsdGlwbGllZEJ5KDFlOCkudG9OdW1iZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczIuZ2V0VHhGZWUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpblNhdG9zaGlzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplOiBzaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVlZDogJ2Zhc3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEZhc3Rlc3RGZWUgPSBfY29udGV4dDIuc2VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuYWJydXB0KCJyZXR1cm4iLCBuZXcgQmlnTnVtYmVyKGZlZXMpLmlzTGVzc1RoYW4oY3VycmVudEZhc3Rlc3RGZWUpID8gbmV3IEJpZ051bWJlcihmZWVzKS5kaXZpZGVkQnkoY3VycmVudEZhc3Rlc3RGZWUpLnRvTnVtYmVyKCkgOiAxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUyKTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGZlZXNUb0NvbmZpZGVuY2UoX3gzLCBfeDQsIF94NSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpOwogICAgICAgICAgICAgICAgLyogQFRvRG8gLSDQsdC+0LvRjNGI0LUg0LPQuNCx0LrQvtGB0YLQuCAqLwoKCiAgICAgICAgICAgICAgICBmZXRjaENvbmZpZGVuY2UgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgX3JlZjMgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMyh1bnNwZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZlZXMsIHNpemUsIHNlbmRlckFkZHJlc3MsIHR4Q29uZmlybXMsIGNvbmZpcm1hdGlvbnNUb0NvbmZpZGVuY2UsIGNvbmZpZGVuY2VGcm9tQ29uZmlybWF0aW9ucywgY29uZkZyb21GZWU7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMyQoX2NvbnRleHQzKSB7CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0My5wcmV2ID0gX2NvbnRleHQzLm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIV90aGlzMi5za2lwRmV0Y2hDb25maWRlbmNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5hYnJ1cHQoInJldHVybiIsIDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZWVzID0gdW5zcGVudC5mZWVzLCBzaXplID0gdW5zcGVudC5zaXplLCBzZW5kZXJBZGRyZXNzID0gdW5zcGVudC5zZW5kZXJBZGRyZXNzLCB0eENvbmZpcm1zID0gdW5zcGVudC5jb25maXJtYXRpb25zOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpcm1hdGlvbnNUb0NvbmZpZGVuY2UgPSBmdW5jdGlvbiBjb25maXJtYXRpb25zVG9Db25maWRlbmNlKGNvbmZzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjb25mcyA+IDAgPyAxIDogMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlkZW5jZUZyb21Db25maXJtYXRpb25zID0gY29uZmlybWF0aW9uc1RvQ29uZmlkZW5jZSh0eENvbmZpcm1zKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5ldyBCaWdOdW1iZXIoY29uZmlkZW5jZUZyb21Db25maXJtYXRpb25zKS5pc0dyZWF0ZXJUaGFuT3JFcXVhbFRvKGV4cGVjdGVkQ29uZmlkZW5jZUxldmVsKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCBjb25maWRlbmNlRnJvbUNvbmZpcm1hdGlvbnMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMucHJldiA9IDc7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodHhDb25maXJtcyA+IDApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMTA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCAxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZmVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDE1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZlZXNUb0NvbmZpZGVuY2UoZmVlcywgc2l6ZSwgc2VuZGVyQWRkcmVzcyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25mRnJvbUZlZSA9IF9jb250ZXh0My5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5hYnJ1cHQoInJldHVybiIsIGNvbmZGcm9tRmVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxNToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidHhpbmZvPXtjb25maXJtYXRpb25zOiAiLmNvbmNhdCh0eENvbmZpcm1zLCAiLCBmZWVzOiAiKS5jb25jYXQoZmVlcywgIiwgc2l6ZTogIikuY29uY2F0KHNpemUsICIsIHNlbmRlckFkZHJlc3M6ICIpLmNvbmNhdChzZW5kZXJBZGRyZXNzLCAiIH0iKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMucHJldiA9IDE4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzLnQwID0gX2NvbnRleHQzWyJjYXRjaCJdKDcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiQnRjU3dhcDogRXJyb3IgZmV0Y2hpbmcgY29uZmlkZW5jZTogdXNpbmcgY29uZmlybWF0aW9ucyA+IDA6IiwgX2NvbnRleHQzLnQwLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5hYnJ1cHQoInJldHVybiIsIGNvbmZpZGVuY2VGcm9tQ29uZmlybWF0aW9ucyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgX2NhbGxlZTMsIG51bGwsIFtbNywgMThdXSk7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBmZXRjaENvbmZpZGVuY2UoX3g2KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWYzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KCk7CgogICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSA1OwogICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHVuc3BlbnRzLm1hcChmZXRjaENvbmZpZGVuY2UpKTsKCiAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgY29uZmlkZW5jZXMgPSBfY29udGV4dDQuc2VudDsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuYWJydXB0KCJyZXR1cm4iLCB1bnNwZW50cy5maWx0ZXIoZnVuY3Rpb24gKHV0eG8sIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6c3dhcHMnKSgiY29uZmlkZW5jZVsiLmNvbmNhdChpbmRleCwgIl06IiksIGNvbmZpZGVuY2VzW2luZGV4XSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQmlnTnVtYmVyKGNvbmZpZGVuY2VzW2luZGV4XSkuaXNHcmVhdGVyVGhhbk9yRXF1YWxUbyhleHBlY3RlZENvbmZpZGVuY2VMZXZlbCk7CiAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNCk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGZpbHRlckNvbmZpZGVudFVuc3BlbnRzKF94MikgewogICAgICAgIHJldHVybiBfZmlsdGVyQ29uZmlkZW50VW5zcGVudHMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZpbHRlckNvbmZpZGVudFVuc3BlbnRzOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7QXJyYXlbb2JqZWN0XX0gdW5zcGVudHMNCiAgICAgKiBAcmV0dXJuIHtBcnJheVtvYmplY3RdfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJmaWx0ZXJDb25maXJtZWRVbnNwZW50cyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2ZpbHRlckNvbmZpcm1lZFVuc3BlbnRzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTYodW5zcGVudHMpIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU2JChfY29udGV4dDYpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ2LnByZXYgPSBfY29udGV4dDYubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuYWJydXB0KCJyZXR1cm4iLCBuZXcgUHJvbWlzZSggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWY0ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTUocmVzb2x2ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBmaWx0ZXJlZDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU1JChfY29udGV4dDUpIHsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ1LnByZXYgPSBfY29udGV4dDUubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkID0gdW5zcGVudHMuZmlsdGVyKGZ1bmN0aW9uICh1bnNwZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb25maXJtYXRpb25zID0gdW5zcGVudC5jb25maXJtYXRpb25zOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpcm1hdGlvbnMgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShmaWx0ZXJlZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlNSk7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3g4KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWY0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KCkpKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU2KTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZmlsdGVyQ29uZmlybWVkVW5zcGVudHMoX3g3KSB7CiAgICAgICAgcmV0dXJuIF9maWx0ZXJDb25maXJtZWRVbnNwZW50cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZmlsdGVyQ29uZmlybWVkVW5zcGVudHM7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YS5zY3JpcHQNCiAgICAgKiBAcGFyYW0geyp9IGRhdGEudHhSYXcNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaW5wdXRJbmRleA0KICAgICAqIEBwcml2YXRlDQogICAgICovCgogIH0sIHsKICAgIGtleTogIl9zaWduVHJhbnNhY3Rpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9zaWduVHJhbnNhY3Rpb24oZGF0YSkgewogICAgICB2YXIgaW5wdXRJbmRleCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogMDsKICAgICAgZGVidWcoJ3N3YXAuY29yZTpzd2FwcycpKCdzaWduaW5nIHNjcmlwdCBpbnB1dCcsIGlucHV0SW5kZXgpOwogICAgICB2YXIgc2NyaXB0ID0gZGF0YS5zY3JpcHQsCiAgICAgICAgICB0eFJhdyA9IGRhdGEudHhSYXcsCiAgICAgICAgICBzZWNyZXQgPSBkYXRhLnNlY3JldDsKICAgICAgdmFyIHNjcmlwdERhdGEgPSB0aGlzLmFwcC5lbnYuYml0Y29pbi5wYXltZW50cy5wMnNoKHsKICAgICAgICByZWRlZW06IHsKICAgICAgICAgIG91dHB1dDogc2NyaXB0LAogICAgICAgICAgbmV0d29yazogdGhpcy5uZXR3b3JrCiAgICAgICAgfSwKICAgICAgICBuZXR3b3JrOiB0aGlzLm5ldHdvcmsKICAgICAgfSk7CiAgICAgIHZhciBoYXNoVHlwZSA9IHRoaXMuYXBwLmVudi5iaXRjb2luLlRyYW5zYWN0aW9uLlNJR0hBU0hfQUxMOwogICAgICB2YXIgcHJpdktleSA9IHRoaXMuYXBwLmVudi5iaXRjb2luLkVDUGFpci5mcm9tV0lGKHRoaXMuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHNbdGhpcy5hY2NvdW50XS5nZXRQcml2YXRlS2V5KCksIHRoaXMubmV0d29yayk7CiAgICAgIHZhciBzaWduYXR1cmVIYXNoID0gdHhSYXcuaGFzaEZvclNpZ25hdHVyZShpbnB1dEluZGV4LCBzY3JpcHREYXRhLnJlZGVlbS5vdXRwdXQsIGhhc2hUeXBlKTsKICAgICAgdmFyIHJlZGVlbVNjcmlwdFNpZyA9IHRoaXMuYXBwLmVudi5iaXRjb2luLnBheW1lbnRzLnAyc2goewogICAgICAgIG5ldHdvcms6IHRoaXMubmV0d29yaywKICAgICAgICByZWRlZW06IHsKICAgICAgICAgIG5ldHdvcms6IHRoaXMubmV0d29yaywKICAgICAgICAgIG91dHB1dDogc2NyaXB0RGF0YS5yZWRlZW0ub3V0cHV0LAogICAgICAgICAgaW5wdXQ6IHRoaXMuYXBwLmVudi5iaXRjb2luLnNjcmlwdC5jb21waWxlKFt0aGlzLmFwcC5lbnYuYml0Y29pbi5zY3JpcHQuc2lnbmF0dXJlLmVuY29kZShwcml2S2V5LnNpZ24oc2lnbmF0dXJlSGFzaCksIGhhc2hUeXBlKSwgdGhpcy5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50c1t0aGlzLmFjY291bnRdLmdldFB1YmxpY0tleUJ1ZmZlcigpLCBCdWZmZXIuZnJvbShzZWNyZXQucmVwbGFjZSgvXjB4LywgJycpLCAnaGV4JyldKQogICAgICAgIH0KICAgICAgfSkuaW5wdXQ7CiAgICAgIHR4UmF3LnNldElucHV0U2NyaXB0KGlucHV0SW5kZXgsIHJlZGVlbVNjcmlwdFNpZyk7CiAgICB9CiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0SGFzaA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLm93bmVyUHVibGljS2V5DQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucmVjaXBpZW50UHVibGljS2V5DQogICAgICogQHBhcmFtIHtudW1iZXJ9IGRhdGEubG9ja1RpbWUNCiAgICAgKiBAcmV0dXJucyB7e3NjcmlwdEFkZHJlc3M6ICosIHNjcmlwdDogKCp8e2lnbm9yZWR9KX19DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNyZWF0ZVNjcmlwdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlU2NyaXB0KGRhdGEpIHsKICAgICAgdmFyIGhhc2hOYW1lID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAncmlwZW1kMTYwJzsKICAgICAgdmFyIGhhc2hPcGNvZGVOYW1lID0gIk9QXyIuY29uY2F0KGhhc2hOYW1lLnRvVXBwZXJDYXNlKCkpOwogICAgICB2YXIgaGFzaE9wY29kZSA9IHRoaXMuYXBwLmVudi5iaXRjb2luLm9wY29kZXNbaGFzaE9wY29kZU5hbWVdOwogICAgICB2YXIgc2VjcmV0SGFzaCA9IGRhdGEuc2VjcmV0SGFzaCwKICAgICAgICAgIG93bmVyUHVibGljS2V5ID0gZGF0YS5vd25lclB1YmxpY0tleSwKICAgICAgICAgIHJlY2lwaWVudFB1YmxpY0tleSA9IGRhdGEucmVjaXBpZW50UHVibGljS2V5LAogICAgICAgICAgbG9ja1RpbWUgPSBkYXRhLmxvY2tUaW1lOwogICAgICB2YXIgc2NyaXB0ID0gdGhpcy5hcHAuZW52LmJpdGNvaW4uc2NyaXB0LmNvbXBpbGUoW3RoaXMuYXBwLmVudi5iaXRjb2luLm9wY29kZXMuT1BfU0laRSwgQnVmZmVyLmZyb20oJzIwJywgJ2hleCcpLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0VRVUFMVkVSSUZZLCBoYXNoT3Bjb2RlLCBCdWZmZXIuZnJvbShzZWNyZXRIYXNoLCAnaGV4JyksIHRoaXMuYXBwLmVudi5iaXRjb2luLm9wY29kZXMuT1BfRVFVQUxWRVJJRlksIEJ1ZmZlci5mcm9tKHJlY2lwaWVudFB1YmxpY0tleSwgJ2hleCcpLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0VRVUFMLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0lGLCBCdWZmZXIuZnJvbShyZWNpcGllbnRQdWJsaWNLZXksICdoZXgnKSwgdGhpcy5hcHAuZW52LmJpdGNvaW4ub3Bjb2Rlcy5PUF9FTFNFLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5zY3JpcHQubnVtYmVyLmVuY29kZShsb2NrVGltZSksIHRoaXMuYXBwLmVudi5iaXRjb2luLm9wY29kZXMuT1BfQ0hFQ0tMT0NLVElNRVZFUklGWSwgdGhpcy5hcHAuZW52LmJpdGNvaW4ub3Bjb2Rlcy5PUF9EUk9QLCBCdWZmZXIuZnJvbShvd25lclB1YmxpY0tleSwgJ2hleCcpLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0VORElGLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0NIRUNLU0lHXSk7CiAgICAgIHZhciBzY3JpcHREYXRhID0gdGhpcy5hcHAuZW52LmJpdGNvaW4ucGF5bWVudHMucDJzaCh7CiAgICAgICAgcmVkZWVtOiB7CiAgICAgICAgICBvdXRwdXQ6IHNjcmlwdCwKICAgICAgICAgIG5ldHdvcms6IHRoaXMubmV0d29yawogICAgICAgIH0sCiAgICAgICAgbmV0d29yazogdGhpcy5uZXR3b3JrCiAgICAgIH0pOwogICAgICB2YXIgc2NyaXB0QWRkcmVzcyA9IHNjcmlwdERhdGEuYWRkcmVzczsKICAgICAgcmV0dXJuIHsKICAgICAgICBzY3JpcHRBZGRyZXNzOiBzY3JpcHRBZGRyZXNzLAogICAgICAgIHNjcmlwdDogc2NyaXB0CiAgICAgIH07CiAgICB9CiAgfSwgewogICAga2V5OiAiZmV0Y2hVbnNwZW50c0Z1bGxJbmZvIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBmZXRjaFVuc3BlbnRzRnVsbEluZm8oc2NyaXB0QWRkcmVzcykgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIGNvbnNvbGUubG9nKCdmZXRjaFVuc3BlbnRzRnVsbEluZm8nLCBzY3JpcHRBZGRyZXNzKTsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfcmVmNSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU4KHJlc29sdmUpIHsKICAgICAgICAgIHZhciB1bnNwZW50cywgZmV0Y2hGdWxsVW5zcGVudEluZm8sIHVuc3BlbnRzRnVsbEluZm87CiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU4JChfY29udGV4dDgpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0OC5wcmV2ID0gX2NvbnRleHQ4Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ4Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLmZldGNoVW5zcGVudHMoc2NyaXB0QWRkcmVzcyk7CgogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICB1bnNwZW50cyA9IF9jb250ZXh0OC5zZW50OwoKICAgICAgICAgICAgICAgICAgZmV0Y2hGdWxsVW5zcGVudEluZm8gPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBfcmVmNiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU3KHVuc3BlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBpbmZvOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNyQoX2NvbnRleHQ3KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDcucHJldiA9IF9jb250ZXh0Ny5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCd1bnNwZW50JywgdW5zcGVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ny5wcmV2ID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSA0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLmZldGNoVHhJbmZvKHVuc3BlbnQudHhpZCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmZvID0gX2NvbnRleHQ3LnNlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDcuYWJydXB0KCJyZXR1cm4iLCBfb2JqZWN0U3ByZWFkKF9vYmplY3RTcHJlYWQoe30sIHVuc3BlbnQpLCBpbmZvKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDcucHJldiA9IDg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ny50MCA9IF9jb250ZXh0N1siY2F0Y2giXSgxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2ZldGNoVHhJbmZvJywgX2NvbnRleHQ3LnQwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlNywgbnVsbCwgW1sxLCA4XV0pOwogICAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGZldGNoRnVsbFVuc3BlbnRJbmZvKF94MTApIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmNi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gNjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHVuc3BlbnRzLm1hcChmZXRjaEZ1bGxVbnNwZW50SW5mbykpOwoKICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgdW5zcGVudHNGdWxsSW5mbyA9IF9jb250ZXh0OC5zZW50OwogICAgICAgICAgICAgICAgICByZXNvbHZlKHVuc3BlbnRzRnVsbEluZm8uZmlsdGVyKGZ1bmN0aW9uICh1bnNwZW50KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuc3BlbnQgIT09IGZhbHNlOwogICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlOCk7CiAgICAgICAgfSkpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKF94OSkgewogICAgICAgICAgcmV0dXJuIF9yZWY1LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgICAgfSgpKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjaGVja0NhbkJlUmVwbGFjZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNoZWNrQ2FuQmVSZXBsYWNlcyh1bnNwZW50cykgewogICAgICBpZiAodGhpcy5za2lwQ2hlY2tDYW5CZVJlcGxhY2VzKSByZXR1cm4gZmFsc2U7CiAgICAgIHZhciBub3RSZXBsYWNlZFVuc3BlbnRzID0gdW5zcGVudHMuZmlsdGVyKGZ1bmN0aW9uICh1bnNwZW50KSB7CiAgICAgICAgdmFyIG5vdFJlcGxhY2VkSW5wdXRzID0gdW5zcGVudC5pbnB1dHMuZmlsdGVyKGZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgICAgcmV0dXJuIGlucHV0LnNlcXVlbmNlTnVtYmVyLnRvU3RyaW5nKDE2KSA9PT0gImZmZmZmZmZmIjsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbm90UmVwbGFjZWRJbnB1dHMubGVuZ3RoID09PSB1bnNwZW50LmlucHV0cy5sZW5ndGg7CiAgICAgIH0pOwogICAgICByZXR1cm4gIShub3RSZXBsYWNlZFVuc3BlbnRzLmxlbmd0aCA9PT0gdW5zcGVudHMubGVuZ3RoKTsKICAgIH0KICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5yZWNpcGllbnRQdWJsaWNLZXkNCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZGF0YS5sb2NrVGltZQ0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBleHBlY3RlZA0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBleHBlY3RlZC52YWx1ZQ0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBleHBlY3RlZC5sb2NrVGltZQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHBlY3RlZC5yZWNpcGllbnRQdWJsaWNLZXkNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48c3RyaW5nPn0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiY2hlY2tTY3JpcHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jaGVja1NjcmlwdCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU5KGRhdGEsIGV4cGVjdGVkLCBoYXNoTmFtZSkgewogICAgICAgIHZhciByZWNpcGllbnRQdWJsaWNLZXksIGxvY2tUaW1lLCBfdGhpcyRjcmVhdGVTY3JpcHQsIHNjcmlwdEFkZHJlc3MsIHNjcmlwdCwgd2FpdENvbmZpcm0sIGlzV2hpdGVMaXN0LCBleHBlY3RlZENvbmZpZGVuY2UsIHVuc3BlbnRzLCBjYW5CZVJlcGxhY2VkLCBjb25maXJtZWRVbnNwZW50cywgZXhwZWN0ZWRWYWx1ZSwgdG90YWxVbnNwZW50LCBjb25maWRlbnRVbnNwZW50cywgdG90YWxDb25maWRlbnRVbnNwZW50OwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU5JChfY29udGV4dDkpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ5LnByZXYgPSBfY29udGV4dDkubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJlY2lwaWVudFB1YmxpY0tleSA9IGRhdGEucmVjaXBpZW50UHVibGljS2V5LCBsb2NrVGltZSA9IGRhdGEubG9ja1RpbWU7CiAgICAgICAgICAgICAgICBfdGhpcyRjcmVhdGVTY3JpcHQgPSB0aGlzLmNyZWF0ZVNjcmlwdChkYXRhLCBoYXNoTmFtZSksIHNjcmlwdEFkZHJlc3MgPSBfdGhpcyRjcmVhdGVTY3JpcHQuc2NyaXB0QWRkcmVzcywgc2NyaXB0ID0gX3RoaXMkY3JlYXRlU2NyaXB0LnNjcmlwdDsKICAgICAgICAgICAgICAgIHdhaXRDb25maXJtID0gZXhwZWN0ZWQud2FpdENvbmZpcm0sIGlzV2hpdGVMaXN0ID0gZXhwZWN0ZWQuaXNXaGl0ZUxpc3Q7CgogICAgICAgICAgICAgICAgaWYgKCFpc1doaXRlTGlzdCkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDkubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpcyB3aGl0ZSBsaXN0ZWQgLSBza2lwIHdhaXQgYnRjIHNjcmlwdCcpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OS5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICBleHBlY3RlZENvbmZpZGVuY2UgPSBleHBlY3RlZC5jb25maWRlbmNlICE9PSB1bmRlZmluZWQgPyBleHBlY3RlZC5jb25maWRlbmNlIDogMC45NTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzY3JpcHQnLCBzY3JpcHRBZGRyZXNzKTsKICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gMTA7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mZXRjaFVuc3BlbnRzRnVsbEluZm8oc2NyaXB0QWRkcmVzcyk7CgogICAgICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgICAgICB1bnNwZW50cyA9IF9jb250ZXh0OS5zZW50OwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3NjcmlwdCcsIHNjcmlwdEFkZHJlc3MpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3Vuc3BlbnRzJywgdW5zcGVudHMpOwoKICAgICAgICAgICAgICAgIGlmICh1bnNwZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAxNTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OS5hYnJ1cHQoInJldHVybiIsICJObyB1bnNwZW50cy4gV2FpdCIpOwoKICAgICAgICAgICAgICBjYXNlIDE1OgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgLSB0cmFuc2FjdGlvbiBjYW4gYmUgcmVwbGFjZWQ/CiAgICAgICAgICAgICAgICBjYW5CZVJlcGxhY2VkID0gdGhpcy5jaGVja0NhbkJlUmVwbGFjZXModW5zcGVudHMpOwoKICAgICAgICAgICAgICAgIGlmIChjYW5CZVJlcGxhY2VkKSB7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiRnVuZCB0byBzY3JpcHQgIi5jb25jYXQoc2NyaXB0QWRkcmVzcywgIiBjYW4gYmUgcmVwbGFjZWQgYmUgZmVlLiBXYWl0IGNvbmZpcm0iKSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCEod2FpdENvbmZpcm0gfHwgY2FuQmVSZXBsYWNlZCkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAzMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHVuc3BlbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDkubmV4dCA9IDIwOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LmFicnVwdCgicmV0dXJuIiwgIk5vIHVuc3BlbnRzIik7CgogICAgICAgICAgICAgIGNhc2UgMjA6CiAgICAgICAgICAgICAgICBfY29udGV4dDkubmV4dCA9IDIyOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyQ29uZmlybWVkVW5zcGVudHModW5zcGVudHMpOwoKICAgICAgICAgICAgICBjYXNlIDIyOgogICAgICAgICAgICAgICAgY29uZmlybWVkVW5zcGVudHMgPSBfY29udGV4dDkuc2VudDsKCiAgICAgICAgICAgICAgICBpZiAoISh1bnNwZW50cy5sZW5ndGggPT09IGNvbmZpcm1lZFVuc3BlbnRzLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAyNTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OS5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgICBjYXNlIDI1OgogICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAyNzsKICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmhlbHBlcnMud2FpdERlbGF5KDMwKTsKCiAgICAgICAgICAgICAgY2FzZSAyNzoKICAgICAgICAgICAgICAgIGlmICghY2FuQmVSZXBsYWNlZCkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDkubmV4dCA9IDI5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LmFicnVwdCgicmV0dXJuIiwgIkNhbiBiZSByZXBsYWNlIGJ5IGZlZS4gV2FpdCBjb25maXJtIik7CgogICAgICAgICAgICAgIGNhc2UgMjk6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LmFicnVwdCgicmV0dXJuIiwgIldhaXQgY29uZmlybSB0eCIpOwoKICAgICAgICAgICAgICBjYXNlIDMwOgogICAgICAgICAgICAgICAgZXhwZWN0ZWRWYWx1ZSA9IGV4cGVjdGVkLnZhbHVlLm11bHRpcGxpZWRCeSgxZTgpLmludGVnZXJWYWx1ZSgpOwogICAgICAgICAgICAgICAgdG90YWxVbnNwZW50ID0gdW5zcGVudHMucmVkdWNlKGZ1bmN0aW9uIChzdW1tLCBfcmVmNykgewogICAgICAgICAgICAgICAgICB2YXIgc2F0b3NoaXMgPSBfcmVmNy5zYXRvc2hpczsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1bW0gKyBzYXRvc2hpczsKICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAzNDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbHRlckNvbmZpZGVudFVuc3BlbnRzKHVuc3BlbnRzLCBleHBlY3RlZENvbmZpZGVuY2UpOwoKICAgICAgICAgICAgICBjYXNlIDM0OgogICAgICAgICAgICAgICAgY29uZmlkZW50VW5zcGVudHMgPSBfY29udGV4dDkuc2VudDsKICAgICAgICAgICAgICAgIHRvdGFsQ29uZmlkZW50VW5zcGVudCA9IGNvbmZpZGVudFVuc3BlbnRzLnJlZHVjZShmdW5jdGlvbiAoc3VtbSwgX3JlZjgpIHsKICAgICAgICAgICAgICAgICAgdmFyIHNhdG9zaGlzID0gX3JlZjguc2F0b3NoaXM7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdW1tICsgc2F0b3NoaXM7CiAgICAgICAgICAgICAgICB9LCAwKTsKCiAgICAgICAgICAgICAgICBpZiAoIWV4cGVjdGVkVmFsdWUuaXNHcmVhdGVyVGhhbih0b3RhbFVuc3BlbnQpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gMzg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDkuYWJydXB0KCJyZXR1cm4iLCAiRXhwZWN0ZWQgc2NyaXB0IHZhbHVlOiAiLmNvbmNhdChleHBlY3RlZFZhbHVlLnRvTnVtYmVyKCksICIsIGdvdDogIikuY29uY2F0KHRvdGFsVW5zcGVudCwgIiwgYWRkcmVzczogIikuY29uY2F0KHNjcmlwdEFkZHJlc3MpKTsKCiAgICAgICAgICAgICAgY2FzZSAzODoKICAgICAgICAgICAgICAgIGlmICghKCF0aGlzLnNraXBMb2NrVGltZSAmJiBleHBlY3RlZC5sb2NrVGltZSA+IGxvY2tUaW1lKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDkubmV4dCA9IDQwOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LmFicnVwdCgicmV0dXJuIiwgIkV4cGVjdGVkIHNjcmlwdCBsb2NrVGltZTogIi5jb25jYXQoZXhwZWN0ZWQubG9ja1RpbWUsICIsIGdvdDogIikuY29uY2F0KGxvY2tUaW1lLCAiLCBhZGRyZXNzOiAiKS5jb25jYXQoc2NyaXB0QWRkcmVzcykpOwoKICAgICAgICAgICAgICBjYXNlIDQwOgogICAgICAgICAgICAgICAgaWYgKCEoIXRoaXMuc2tpcFJlY2lwaWVudFB1YmxpY2tLZXkgJiYgZXhwZWN0ZWQucmVjaXBpZW50UHVibGljS2V5ICE9PSByZWNpcGllbnRQdWJsaWNLZXkpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gNDI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDkuYWJydXB0KCJyZXR1cm4iLCAiRXhwZWN0ZWQgc2NyaXB0IHJlY2lwaWVudCBwdWJsaWNLZXk6ICIuY29uY2F0KGV4cGVjdGVkLnJlY2lwaWVudFB1YmxpY0tleSwgIiwgZ290OiAiKS5jb25jYXQocmVjaXBpZW50UHVibGljS2V5KSk7CgogICAgICAgICAgICAgIGNhc2UgNDI6CiAgICAgICAgICAgICAgICBpZiAoIWV4cGVjdGVkVmFsdWUuaXNHcmVhdGVyVGhhbih0b3RhbENvbmZpZGVudFVuc3BlbnQpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gNDQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDkuYWJydXB0KCJyZXR1cm4iLCAiRXhwZWN0ZWQgc2NyaXB0IHZhbHVlOiAiLmNvbmNhdChleHBlY3RlZFZhbHVlLnRvU3RyaW5nKCksICIgd2l0aCBjb25maWRlbmNlIGFib3ZlICIpLmNvbmNhdChleHBlY3RlZENvbmZpZGVuY2UsICIsIGdvdDogIikuY29uY2F0KHRvdGFsQ29uZmlkZW50VW5zcGVudCwgIiwgYWRkcmVzczogIikuY29uY2F0KHNjcmlwdEFkZHJlc3MpKTsKCiAgICAgICAgICAgICAgY2FzZSA0NDoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlOSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGNoZWNrU2NyaXB0KF94MTEsIF94MTIsIF94MTMpIHsKICAgICAgICByZXR1cm4gX2NoZWNrU2NyaXB0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBjaGVja1NjcmlwdDsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhLnNjcmlwdFZhbHVlcw0KICAgICAqIEBwYXJhbSB7QmlnTnVtYmVyfSBkYXRhLmFtb3VudA0KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGhhbmRsZVRyYW5zYWN0aW9uSGFzaA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoTmFtZQ0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJmdW5kU2NyaXB0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBmdW5kU2NyaXB0KGRhdGEsIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCwgaGFzaE5hbWUpIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB2YXIgc2NyaXB0VmFsdWVzID0gZGF0YS5zY3JpcHRWYWx1ZXMsCiAgICAgICAgICBhbW91bnQgPSBkYXRhLmFtb3VudDsKICAgICAgY29uc29sZS5sb2coJ2Z1bmRTY3JpcHQnLCBkYXRhKTsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfcmVmOSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxMChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIHZhciBfdGhpczQkY3JlYXRlU2NyaXB0LCBzY3JpcHRBZGRyZXNzLCBzY3JpcHRCYWxhbmNlLCBvd25lckFkZHJlc3MsIGZ1bmRWYWx1ZSwgdHgsIHVuc3BlbnRzLCBmZWVWYWx1ZUJOLCBmZWVWYWx1ZSwgdG90YWxVbnNwZW50LCBza2lwVmFsdWUsIHByaXZLZXksIHR4UmF3OwoKICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTEwJChfY29udGV4dDEwKSB7CiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDEwLnByZXYgPSBfY29udGV4dDEwLm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQxMC5wcmV2ID0gMDsKICAgICAgICAgICAgICAgICAgX3RoaXM0JGNyZWF0ZVNjcmlwdCA9IF90aGlzNC5jcmVhdGVTY3JpcHQoc2NyaXB0VmFsdWVzLCBoYXNoTmFtZSksIHNjcmlwdEFkZHJlc3MgPSBfdGhpczQkY3JlYXRlU2NyaXB0LnNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzY3JpcHRBZGRyZXNzJywgc2NyaXB0QWRkcmVzcyk7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTAubmV4dCA9IDU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczQuZmV0Y2hCYWxhbmNlKHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgc2NyaXB0QmFsYW5jZSA9IF9jb250ZXh0MTAuc2VudDsKCiAgICAgICAgICAgICAgICAgIGlmICghbmV3IEJpZ051bWJlcihzY3JpcHRCYWxhbmNlKS5pc0dyZWF0ZXJUaGFuKDApKSB7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxMC5uZXh0ID0gOTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgLy8gU2NyaXB0IGFscmVhZHkgZnVuZGVkIC0gc2tpcCBkb3VibGUgcGF5bWVudHMKICAgICAgICAgICAgICAgICAgcmVqZWN0KCdTY3JpcHQgZnVuZGVkIGFscmVhZHknKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTAuYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzcyA9IF90aGlzNC5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50c1tfdGhpczQuYWNjb3VudF0uZ2V0QWRkcmVzcygpOwogICAgICAgICAgICAgICAgICBmdW5kVmFsdWUgPSBhbW91bnQubXVsdGlwbGllZEJ5KDFlOCkuaW50ZWdlclZhbHVlKCkudG9OdW1iZXIoKTsKICAgICAgICAgICAgICAgICAgdHggPSBuZXcgX3RoaXM0LmFwcC5lbnYuYml0Y29pbi5UcmFuc2FjdGlvbkJ1aWxkZXIoX3RoaXM0Lm5ldHdvcmspOwogICAgICAgICAgICAgICAgICBfY29udGV4dDEwLm5leHQgPSAxNDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzNC5mZXRjaFVuc3BlbnRzKG93bmVyQWRkcmVzcyk7CgogICAgICAgICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgICAgICAgICAgdW5zcGVudHMgPSBfY29udGV4dDEwLnNlbnQ7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTAubmV4dCA9IDE3OwogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXM0LmdldFR4RmVlKHsKICAgICAgICAgICAgICAgICAgICBpblNhdG9zaGlzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IG93bmVyQWRkcmVzcwogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjYXNlIDE3OgogICAgICAgICAgICAgICAgICBmZWVWYWx1ZUJOID0gX2NvbnRleHQxMC5zZW50OwogICAgICAgICAgICAgICAgICBmZWVWYWx1ZSA9IGZlZVZhbHVlQk4uaW50ZWdlclZhbHVlKCkudG9OdW1iZXIoKTsKICAgICAgICAgICAgICAgICAgdG90YWxVbnNwZW50ID0gdW5zcGVudHMucmVkdWNlKGZ1bmN0aW9uIChzdW1tLCBfcmVmMTApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2F0b3NoaXMgPSBfcmVmMTAuc2F0b3NoaXM7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1bW0gKyBzYXRvc2hpczsKICAgICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgICAgICAgIHNraXBWYWx1ZSA9IHRvdGFsVW5zcGVudCAtIGZ1bmRWYWx1ZSAtIGZlZVZhbHVlOwoKICAgICAgICAgICAgICAgICAgaWYgKCEodG90YWxVbnNwZW50IDwgZmVlVmFsdWUgKyBmdW5kVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxMC5uZXh0ID0gMjM7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVG90YWwgbGVzcyB0aGFuIGZlZTogIi5jb25jYXQodG90YWxVbnNwZW50LCAiIDwgIikuY29uY2F0KGZlZVZhbHVlLCAiICsgIikuY29uY2F0KGZ1bmRWYWx1ZSkpOwoKICAgICAgICAgICAgICAgIGNhc2UgMjM6CiAgICAgICAgICAgICAgICAgIHVuc3BlbnRzLmZvckVhY2goZnVuY3Rpb24gKHVuc3BlbnQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXM0JHByb2Nlc3NVbnNwZW50ID0gX3RoaXM0LnByb2Nlc3NVbnNwZW50KHVuc3BlbnQpLAogICAgICAgICAgICAgICAgICAgICAgICB0eGlkID0gX3RoaXM0JHByb2Nlc3NVbnNwZW50LnR4aWQsCiAgICAgICAgICAgICAgICAgICAgICAgIHZvdXQgPSBfdGhpczQkcHJvY2Vzc1Vuc3BlbnQudm91dDsKCiAgICAgICAgICAgICAgICAgICAgdHguYWRkSW5wdXQodHhpZCwgdm91dCwgMHhmZmZmZmZmZik7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB0eC5hZGRPdXRwdXQoc2NyaXB0QWRkcmVzcywgZnVuZFZhbHVlKTsKICAgICAgICAgICAgICAgICAgdHguYWRkT3V0cHV0KF90aGlzNC5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50c1tfdGhpczQuYWNjb3VudF0uZ2V0QWRkcmVzcygpLCBza2lwVmFsdWUpOwogICAgICAgICAgICAgICAgICBwcml2S2V5ID0gX3RoaXM0LmFwcC5lbnYuYml0Y29pbi5FQ1BhaXIuZnJvbVdJRihfdGhpczQuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHNbX3RoaXM0LmFjY291bnRdLmdldFByaXZhdGVLZXkoKSwgX3RoaXM0Lm5ldHdvcmspOwoKICAgICAgICAgICAgICAgICAgdHguX19JTlBVVFMuZm9yRWFjaChmdW5jdGlvbiAoaW5wdXQsIGluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgdHguc2lnbihpbmRleCwgcHJpdktleSk7CiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgdHhSYXcgPSB0eC5idWlsZEluY29tcGxldGUoKTsKCiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaGFuZGxlVHJhbnNhY3Rpb25IYXNoID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKHR4UmF3LmdldElkKCkpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBfdGhpczQuYnJvYWRjYXN0VHgodHhSYXcudG9IZXgoKSkudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpOwogICAgICAgICAgICAgICAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQxMC5uZXh0ID0gMzY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgMzM6CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTAucHJldiA9IDMzOwogICAgICAgICAgICAgICAgICBfY29udGV4dDEwLnQwID0gX2NvbnRleHQxMFsiY2F0Y2giXSgwKTsKICAgICAgICAgICAgICAgICAgcmVqZWN0KF9jb250ZXh0MTAudDApOwoKICAgICAgICAgICAgICAgIGNhc2UgMzY6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMC5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlMTAsIG51bGwsIFtbMCwgMzNdXSk7CiAgICAgICAgfSkpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKF94MTQsIF94MTUpIHsKICAgICAgICAgIHJldHVybiBfcmVmOS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICAgIH0oKSk7CiAgICB9CiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fHN0cmluZ30gZGF0YSAtIHNjcmlwdFZhbHVlcyBvciB3YWxsZXQgYWRkcmVzcw0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjx2b2lkPn0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0QmFsYW5jZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2dldEJhbGFuY2UgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTEoZGF0YSwgaGFzaE5hbWUpIHsKICAgICAgICB2YXIgYWRkcmVzcywgX3RoaXMkY3JlYXRlU2NyaXB0Miwgc2NyaXB0QWRkcmVzcywgdW5zcGVudHMsIHRvdGFsVW5zcGVudDsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTEkKF9jb250ZXh0MTEpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMS5wcmV2ID0gX2NvbnRleHQxMS5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgaWYgKCEodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSA0OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBhZGRyZXNzID0gZGF0YTsKICAgICAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDEwOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIGlmICghKF90eXBlb2YoZGF0YSkgPT09ICdvYmplY3QnKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSA5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGhpcyRjcmVhdGVTY3JpcHQyID0gdGhpcy5jcmVhdGVTY3JpcHQoZGF0YSwgaGFzaE5hbWUpLCBzY3JpcHRBZGRyZXNzID0gX3RoaXMkY3JlYXRlU2NyaXB0Mi5zY3JpcHRBZGRyZXNzOwogICAgICAgICAgICAgICAgYWRkcmVzcyA9IHNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAxMDsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dyb25nIGRhdGEgdHlwZScpOwoKICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gMTI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mZXRjaFVuc3BlbnRzKGFkZHJlc3MpOwoKICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgICAgdW5zcGVudHMgPSBfY29udGV4dDExLnNlbnQ7CiAgICAgICAgICAgICAgICB0b3RhbFVuc3BlbnQgPSB1bnNwZW50cyAmJiB1bnNwZW50cy5sZW5ndGggJiYgdW5zcGVudHMucmVkdWNlKGZ1bmN0aW9uIChzdW1tLCBfcmVmMTEpIHsKICAgICAgICAgICAgICAgICAgdmFyIHNhdG9zaGlzID0gX3JlZjExLnNhdG9zaGlzOwogICAgICAgICAgICAgICAgICByZXR1cm4gc3VtbSArIHNhdG9zaGlzOwogICAgICAgICAgICAgICAgfSwgMCkgfHwgMDsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDExLmFicnVwdCgicmV0dXJuIiwgdG90YWxVbnNwZW50KTsKCiAgICAgICAgICAgICAgY2FzZSAxNToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTExLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZ2V0QmFsYW5jZShfeDE2LCBfeDE3KSB7CiAgICAgICAgcmV0dXJuIF9nZXRCYWxhbmNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBnZXRCYWxhbmNlOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEuc2NyaXB0VmFsdWVzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0DQogICAgICogQHBhcmFtIHtib29sZWFufSBpc1JlZnVuZA0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRXaXRoZHJhd1Jhd1RyYW5zYWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfZ2V0V2l0aGRyYXdSYXdUcmFuc2FjdGlvbiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxMihkYXRhLCBpc1JlZnVuZCwgaGFzaE5hbWUpIHsKICAgICAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICAgICAgdmFyIHNjcmlwdFZhbHVlcywgc2VjcmV0LCBkZXN0aW5hdGlvbkFkZHJlc3MsIGRlc3RBZGRyZXNzLCBfdGhpcyRjcmVhdGVTY3JpcHQzLCBzY3JpcHQsIHNjcmlwdEFkZHJlc3MsIHR4LCB1bnNwZW50cywgZmVlVmFsdWVCTiwgZmVlVmFsdWUsIHRvdGFsVW5zcGVudCwgaGFzV2l0aGRyYXcsIHR4UmF3LCB0eEhleCwgdHhJZDsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTIkKF9jb250ZXh0MTIpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMi5wcmV2ID0gX2NvbnRleHQxMi5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzID0gZGF0YS5zY3JpcHRWYWx1ZXMsIHNlY3JldCA9IGRhdGEuc2VjcmV0LCBkZXN0aW5hdGlvbkFkZHJlc3MgPSBkYXRhLmRlc3RpbmF0aW9uQWRkcmVzczsKICAgICAgICAgICAgICAgIGRlc3RBZGRyZXNzID0gZGVzdGluYXRpb25BZGRyZXNzID8gZGVzdGluYXRpb25BZGRyZXNzIDogdGhpcy5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50c1t0aGlzLmFjY291bnRdLmdldEFkZHJlc3MoKTsKICAgICAgICAgICAgICAgIF90aGlzJGNyZWF0ZVNjcmlwdDMgPSB0aGlzLmNyZWF0ZVNjcmlwdChzY3JpcHRWYWx1ZXMsIGhhc2hOYW1lKSwgc2NyaXB0ID0gX3RoaXMkY3JlYXRlU2NyaXB0My5zY3JpcHQsIHNjcmlwdEFkZHJlc3MgPSBfdGhpcyRjcmVhdGVTY3JpcHQzLnNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICB0eCA9IG5ldyB0aGlzLmFwcC5lbnYuYml0Y29pbi5UcmFuc2FjdGlvbkJ1aWxkZXIodGhpcy5uZXR3b3JrKTsKICAgICAgICAgICAgICAgIF9jb250ZXh0MTIubmV4dCA9IDY7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mZXRjaFVuc3BlbnRzKHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICB1bnNwZW50cyA9IF9jb250ZXh0MTIuc2VudDsKICAgICAgICAgICAgICAgIF9jb250ZXh0MTIubmV4dCA9IDk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUeEZlZSh7CiAgICAgICAgICAgICAgICAgIGluU2F0b3NoaXM6IHRydWUsCiAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IHNjcmlwdEFkZHJlc3MKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgICAgICBmZWVWYWx1ZUJOID0gX2NvbnRleHQxMi5zZW50OwogICAgICAgICAgICAgICAgZmVlVmFsdWUgPSBmZWVWYWx1ZUJOLmludGVnZXJWYWx1ZSgpLnRvTnVtYmVyKCk7CiAgICAgICAgICAgICAgICB0b3RhbFVuc3BlbnQgPSB1bnNwZW50cy5yZWR1Y2UoZnVuY3Rpb24gKHN1bW0sIF9yZWYxMikgewogICAgICAgICAgICAgICAgICB2YXIgc2F0b3NoaXMgPSBfcmVmMTIuc2F0b3NoaXM7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdW1tICsgc2F0b3NoaXM7CiAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgIC8qIENoZWNrIC0gbWF5IGJlIHdpdGhkcmF3ZWQgKi8KCiAgICAgICAgICAgICAgICBpZiAoISh0eXBlb2YgdGhpcy5jaGVja1dpdGhkcmF3ID09PSAnZnVuY3Rpb24nKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDEyLm5leHQgPSAxOTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3RyeSBjaGVjayB3aXRoZHJhdycpOwogICAgICAgICAgICAgICAgX2NvbnRleHQxMi5uZXh0ID0gMTY7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja1dpdGhkcmF3KHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgICAgaGFzV2l0aGRyYXcgPSBfY29udGV4dDEyLnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKCEoaGFzV2l0aGRyYXcgJiYgaGFzV2l0aGRyYXcuYWRkcmVzcy50b0xvd2VyQ2FzZSgpID09IGRlc3RBZGRyZXNzLnRvTG93ZXJDYXNlKCkpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTIubmV4dCA9IDE5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5hYnJ1cHQoInJldHVybiIsIHsKICAgICAgICAgICAgICAgICAgdHhJZDogaGFzV2l0aGRyYXcudHhpZCwKICAgICAgICAgICAgICAgICAgYWxyZWFkeVdpdGhkcmF3ZWQ6IHRydWUKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDE5OgogICAgICAgICAgICAgICAgaWYgKCFuZXcgQmlnTnVtYmVyKHRvdGFsVW5zcGVudCkuaXNMZXNzVGhhbihmZWVWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQxMi5uZXh0ID0gMjE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVG90YWwgbGVzcyB0aGFuIGZlZTogIi5jb25jYXQodG90YWxVbnNwZW50LCAiIDwgIikuY29uY2F0KGZlZVZhbHVlKSk7CgogICAgICAgICAgICAgIGNhc2UgMjE6CiAgICAgICAgICAgICAgICBpZiAoaXNSZWZ1bmQpIHsKICAgICAgICAgICAgICAgICAgdHguc2V0TG9ja1RpbWUoc2NyaXB0VmFsdWVzLmxvY2tUaW1lKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB1bnNwZW50cy5mb3JFYWNoKGZ1bmN0aW9uICh1bnNwZW50KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfdGhpczUkcHJvY2Vzc1Vuc3BlbnQgPSBfdGhpczUucHJvY2Vzc1Vuc3BlbnQodW5zcGVudCksCiAgICAgICAgICAgICAgICAgICAgICB0eGlkID0gX3RoaXM1JHByb2Nlc3NVbnNwZW50LnR4aWQsCiAgICAgICAgICAgICAgICAgICAgICB2b3V0ID0gX3RoaXM1JHByb2Nlc3NVbnNwZW50LnZvdXQ7CgogICAgICAgICAgICAgICAgICB0eC5hZGRJbnB1dCh0eGlkLCB2b3V0LCAweGZmZmZmZmZlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdHguYWRkT3V0cHV0KGRlc3RBZGRyZXNzLCB0b3RhbFVuc3BlbnQgLSBmZWVWYWx1ZSk7CiAgICAgICAgICAgICAgICB0eFJhdyA9IHR4LmJ1aWxkSW5jb21wbGV0ZSgpOwoKICAgICAgICAgICAgICAgIHR4Ll9fSU5QVVRTLm1hcChmdW5jdGlvbiAoXywgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzNS5fc2lnblRyYW5zYWN0aW9uKHsKICAgICAgICAgICAgICAgICAgICBzY3JpcHQ6IHNjcmlwdCwKICAgICAgICAgICAgICAgICAgICBzZWNyZXQ6IHNlY3JldCwKICAgICAgICAgICAgICAgICAgICB0eFJhdzogdHhSYXcKICAgICAgICAgICAgICAgICAgfSwgaW5kZXgpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgdHhIZXggPSB0eFJhdy50b0hleCgpOwogICAgICAgICAgICAgICAgdHhJZCA9IHR4UmF3LmdldElkKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5hYnJ1cHQoInJldHVybiIsIHsKICAgICAgICAgICAgICAgICAgdHhIZXg6IHR4SGV4LAogICAgICAgICAgICAgICAgICB0eElkOiB0eElkCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAzMDoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTIuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTEyLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZ2V0V2l0aGRyYXdSYXdUcmFuc2FjdGlvbihfeDE4LCBfeDE5LCBfeDIwKSB7CiAgICAgICAgcmV0dXJuIF9nZXRXaXRoZHJhd1Jhd1RyYW5zYWN0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBnZXRXaXRoZHJhd1Jhd1RyYW5zYWN0aW9uOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEuc2NyaXB0VmFsdWVzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0DQogICAgICogQHBhcmFtIHtib29sZWFufSBpc1JlZnVuZA0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRXaXRoZHJhd0hleFRyYW5zYWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfZ2V0V2l0aGRyYXdIZXhUcmFuc2FjdGlvbiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxMyhkYXRhLCBpc1JlZnVuZCkgewogICAgICAgIHZhciB0eFJhdzsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxMyQoX2NvbnRleHQxMykgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDEzLnByZXYgPSBfY29udGV4dDEzLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDEzLm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0V2l0aGRyYXdSYXdUcmFuc2FjdGlvbihkYXRhLCBpc1JlZnVuZCk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHR4UmF3ID0gX2NvbnRleHQxMy5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTMuYWJydXB0KCJyZXR1cm4iLCB0eFJhdy50eEhleCk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTMuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTEzLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZ2V0V2l0aGRyYXdIZXhUcmFuc2FjdGlvbihfeDIxLCBfeDIyKSB7CiAgICAgICAgcmV0dXJuIF9nZXRXaXRoZHJhd0hleFRyYW5zYWN0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBnZXRXaXRoZHJhd0hleFRyYW5zYWN0aW9uOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEuc2NyaXB0VmFsdWVzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0DQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldFJlZnVuZFJhd1RyYW5zYWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRSZWZ1bmRSYXdUcmFuc2FjdGlvbihkYXRhKSB7CiAgICAgIHJldHVybiB0aGlzLmdldFdpdGhkcmF3UmF3VHJhbnNhY3Rpb24oZGF0YSwgdHJ1ZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZnVuZFN3YXBTY3JpcHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9mdW5kU3dhcFNjcmlwdCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxOChfcmVmMTMpIHsKICAgICAgICB2YXIgZmxvdywgdXR4b0NsYXNzLCBjb2luLCBvblRyYW5zYWN0aW9uSGFzaCwgc2VsbEFtb3VudCwgX2Zsb3ckc3RhdGUyLCBpc0JhbGFuY2VFbm91Z2gsIHNjcmlwdFZhbHVlcywgZnVuZFNjcmlwdFJlcGVhdCwgY2hlY2tTY3JpcHRCYWxhbmNlLCBpc1N0b3BwZWRTd2FwLCBfZmxvdyRmaW5pc2hTdGVwOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxOCQoX2NvbnRleHQxOCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDE4LnByZXYgPSBfY29udGV4dDE4Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBmbG93ID0gX3JlZjEzLmZsb3c7CiAgICAgICAgICAgICAgICB1dHhvQ2xhc3MgPSB0aGlzOwogICAgICAgICAgICAgICAgY29pbiA9IHRoaXMuX3N3YXBOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgICAgICAgb25UcmFuc2FjdGlvbkhhc2ggPSBmdW5jdGlvbiBvblRyYW5zYWN0aW9uSGFzaCh0eElEKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmxvdyRzdGF0ZSA9IGZsb3cuc3RhdGUsCiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaCA9IF9mbG93JHN0YXRlLnV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaCwKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlcyA9IF9mbG93JHN0YXRlLnV0eG9TY3JpcHRWYWx1ZXM7CgogICAgICAgICAgICAgICAgICBpZiAoc2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2gpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgIHV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaDogdHhJRAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20ub25jZSgicmVxdWVzdCB1dHhvIHNjcmlwdCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICBldmVudDogImNyZWF0ZSB1dHhvIHNjcmlwdCIsCiAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogc2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgICB1dHhvU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2g6IHR4SUQKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICBldmVudDogImNyZWF0ZSB1dHhvIHNjcmlwdCIsCiAgICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzOiBzY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICB1dHhvU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2g6IHR4SUQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBzZWxsQW1vdW50ID0gZmxvdy5zd2FwLnNlbGxBbW91bnQsIF9mbG93JHN0YXRlMiA9IGZsb3cuc3RhdGUsIGlzQmFsYW5jZUVub3VnaCA9IF9mbG93JHN0YXRlMi5pc0JhbGFuY2VFbm91Z2gsIHNjcmlwdFZhbHVlcyA9IF9mbG93JHN0YXRlMi51dHhvU2NyaXB0VmFsdWVzOwoKICAgICAgICAgICAgICAgIGlmICghaXNCYWxhbmNlRW5vdWdoKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTgubmV4dCA9IDk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmRTY3JpcHRSZXBlYXQgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgX3JlZjE0ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTE0KCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE0JChfY29udGV4dDE0KSB7CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTQucHJldiA9IF9jb250ZXh0MTQubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTQucHJldiA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDE0Lm5leHQgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHV0eG9DbGFzcy5mdW5kU2NyaXB0KHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzOiBzY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogc2VsbEFtb3VudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE0LmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTQucHJldiA9IDY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDE0LnQwID0gX2NvbnRleHQxNFsiY2F0Y2giXSgwKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShfY29udGV4dDE0LnQwID09PSAnU2NyaXB0IGZ1bmRlZCBhbHJlYWR5JykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxNC5uZXh0ID0gMTM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignU2NyaXB0IGFscmVhZHkgZnVuZGVkJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNC5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEoX2NvbnRleHQxNC50MCA9PT0gJ0NvbmZsaWN0JykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxNC5uZXh0ID0gMjI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEBUb0RvIC0gaXRzIGNhbiBiZSBub3QgYnRjLCBvdGhlciBVVFhPLCBidXQsIHdpdGggYnRjIGl0cyBmcmVxdWVudCBlcnJvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdVVFhPKEJUQykgbG9ja2VkLiBIYXMgbm90IGNvbmZpcm1lZCB0eCBpbiBtZW1wb29sLiBXYWl0IGNvbmZpcm0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6ICd3YWl0IHV0eG8gdW5sb2NrJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YToge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhaXRVbmxvY2tVVFhPOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTQubmV4dCA9IDE5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy53YWl0RGVsYXkoMzApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTQuYWJydXB0KCJyZXR1cm4iLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRmFpbCBmdW5kIHNjcmlwdCcsIF9jb250ZXh0MTQudDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDIzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTQuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTQuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgX2NhbGxlZTE0LCBudWxsLCBbWzAsIDZdXSk7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBmdW5kU2NyaXB0UmVwZWF0KCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMTQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgICAgICBfY29udGV4dDE4Lm5leHQgPSA5OwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgX3JlZjE1ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTE1KHN0b3BSZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNTdG9wcGVkU3dhcDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxNSQoX2NvbnRleHQxNSkgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDE1LnByZXYgPSBfY29udGV4dDE1Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1N0b3BwZWRTd2FwID0gZmxvdy5zdGF0ZS5pc1N0b3BwZWRTd2FwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1N0b3BwZWRTd2FwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTUubmV4dCA9IDc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTUubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuZFNjcmlwdFJlcGVhdCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNS5hYnJ1cHQoInJldHVybiIsIF9jb250ZXh0MTUuc2VudCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BSZXBlYXQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNS5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMTUpOwogICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKF94MjQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZjE1LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KCkpOwoKICAgICAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgICAgICBjaGVja1NjcmlwdEJhbGFuY2UgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgX3JlZjE2ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTE2KCkgewogICAgICAgICAgICAgICAgICAgIHZhciBfdXR4b0NsYXNzJGNyZWF0ZVNjcmksIHNjcmlwdEFkZHJlc3MsIHVuc3BlbnRzLCB0eElELCBiYWxhbmNlLCBpc0Vub3VnaE1vbmV5OwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxNiQoX2NvbnRleHQxNikgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDE2LnByZXYgPSBfY29udGV4dDE2Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdXR4b0NsYXNzJGNyZWF0ZVNjcmkgPSB1dHhvQ2xhc3MuY3JlYXRlU2NyaXB0KHNjcmlwdFZhbHVlcyksIHNjcmlwdEFkZHJlc3MgPSBfdXR4b0NsYXNzJGNyZWF0ZVNjcmkuc2NyaXB0QWRkcmVzczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTYubmV4dCA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXR4b0NsYXNzLmZldGNoVW5zcGVudHMoc2NyaXB0QWRkcmVzcyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc3BlbnRzID0gX2NvbnRleHQxNi5zZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKHVuc3BlbnRzLmxlbmd0aCA9PT0gMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxNi5uZXh0ID0gNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTYuYWJydXB0KCJyZXR1cm4iLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4SUQgPSB1bnNwZW50c1swXS50eGlkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxNi5uZXh0ID0gOTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1dHhvQ2xhc3MuZ2V0QmFsYW5jZShzY3JpcHRWYWx1ZXMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWxhbmNlID0gX2NvbnRleHQxNi5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNFbm91Z2hNb25leSA9IG5ldyBCaWdOdW1iZXIoYmFsYW5jZSkuaXNHcmVhdGVyVGhhbk9yRXF1YWxUbyhzZWxsQW1vdW50LnRpbWVzKDFlOCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Vub3VnaE1vbmV5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEJhbGFuY2U6IG5ldyBCaWdOdW1iZXIoYmFsYW5jZSkuZGl2KDFlOCkuZHAoOCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uVHJhbnNhY3Rpb25IYXNoKHR4SUQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE2LmFicnVwdCgicmV0dXJuIiwgaXNFbm91Z2hNb25leSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE2LnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUxNik7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBjaGVja1NjcmlwdEJhbGFuY2UoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWYxNi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpOwoKICAgICAgICAgICAgICAgIF9jb250ZXh0MTgubmV4dCA9IDEyOwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgX3JlZjE3ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTE3KHN0b3BSZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNTdG9wcGVkU3dhcDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxNyQoX2NvbnRleHQxNykgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDE3LnByZXYgPSBfY29udGV4dDE3Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc1N0b3BwZWRTd2FwID0gZmxvdy5zdGF0ZS5pc1N0b3BwZWRTd2FwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1N0b3BwZWRTd2FwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTcubmV4dCA9IDc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTcubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hlY2tTY3JpcHRCYWxhbmNlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE3LmFicnVwdCgicmV0dXJuIiwgX2NvbnRleHQxNy5zZW50KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFJlcGVhdCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE3LnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUxNyk7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3gyNSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMTcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKSk7CgogICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgICBpc1N0b3BwZWRTd2FwID0gZmxvdy5zdGF0ZS5pc1N0b3BwZWRTd2FwOwoKICAgICAgICAgICAgICAgIGlmICghaXNTdG9wcGVkU3dhcCkgewogICAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoKF9mbG93JGZpbmlzaFN0ZXAgPSB7fSwgX2RlZmluZVByb3BlcnR5KF9mbG93JGZpbmlzaFN0ZXAsICJpcyIuY29uY2F0KGNvaW4sICJTY3JpcHRGdW5kZWR9IiksIHRydWUpLCBfZGVmaW5lUHJvcGVydHkoX2Zsb3ckZmluaXNoU3RlcCwgImlzVVRYT1NjcmlwdEZ1bmRlZCIsIHRydWUpLCBfZmxvdyRmaW5pc2hTdGVwKSwgewogICAgICAgICAgICAgICAgICAgIHN0ZXA6ICJsb2NrLXV0eG8iCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxOC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTgsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBmdW5kU3dhcFNjcmlwdChfeDIzKSB7CiAgICAgICAgcmV0dXJuIF9mdW5kU3dhcFNjcmlwdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZnVuZFN3YXBTY3JpcHQ7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YS5zY3JpcHRWYWx1ZXMNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0UmVmdW5kSGV4VHJhbnNhY3Rpb24iLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9nZXRSZWZ1bmRIZXhUcmFuc2FjdGlvbiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxOShkYXRhKSB7CiAgICAgICAgdmFyIHR4UmF3OwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE5JChfY29udGV4dDE5KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTkucHJldiA9IF9jb250ZXh0MTkubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0MTkubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRSZWZ1bmRSYXdUcmFuc2FjdGlvbihkYXRhKTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgdHhSYXcgPSBfY29udGV4dDE5LnNlbnQ7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxOS5hYnJ1cHQoInJldHVybiIsIHR4UmF3LnR4SGV4KTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxOS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTksIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBnZXRSZWZ1bmRIZXhUcmFuc2FjdGlvbihfeDI2KSB7CiAgICAgICAgcmV0dXJuIF9nZXRSZWZ1bmRIZXhUcmFuc2FjdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZ2V0UmVmdW5kSGV4VHJhbnNhY3Rpb247CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YS5zY3JpcHRWYWx1ZXMNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBoYW5kbGVUcmFuc2FjdGlvbkhhc2gNCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzUmVmdW5kDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hOYW1lDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogIndpdGhkcmF3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiB3aXRoZHJhdyhkYXRhKSB7CiAgICAgIHZhciBfdGhpczYgPSB0aGlzOwoKICAgICAgdmFyIGlzUmVmdW5kID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBmYWxzZTsKICAgICAgdmFyIGhhc2hOYW1lID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBhcmd1bWVudHNbMl0gOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICB2YXIgX3JlZjE4ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIwKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgdmFyIHR4UmF3LCByZXN1bHQsIHR4U3VjY2VzcywgZXJyb3JNZXNzYWdlOwogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjAkKF9jb250ZXh0MjApIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjAucHJldiA9IF9jb250ZXh0MjAubmV4dCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBfY29udGV4dDIwLnByZXYgPSAwOwogICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnd2l0aGRyYXcnKTsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQyMC5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzNi5nZXRXaXRoZHJhd1Jhd1RyYW5zYWN0aW9uKGRhdGEsIGlzUmVmdW5kLCBoYXNoTmFtZSk7CgogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICB0eFJhdyA9IF9jb250ZXh0MjAuc2VudDsKCiAgICAgICAgICAgICAgICAgIGlmICghdHhSYXcuYWxyZWFkeVdpdGhkcmF3ZWQpIHsKICAgICAgICAgICAgICAgICAgICBfY29udGV4dDIwLm5leHQgPSA4OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICByZXNvbHZlKHR4UmF3LnR4SWQpOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyMC5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpzd2FwcycpKCdyYXcgdHggd2l0aGRyYXcnLCB0eFJhdy50eEhleCk7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdicm9hZGNhc3QnKTsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQyMC5uZXh0ID0gMTI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczYuYnJvYWRjYXN0VHgodHhSYXcudHhIZXgpOwoKICAgICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IF9jb250ZXh0MjAuc2VudDsKICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Jyb2FkY2FzdCByZWFkeScsIHJlc3VsdCk7IC8vIFdhaXQgc29tZSBkZWxheSB1bnRpbCB0cmFuc2FjdGlvbiBjYW4gYmUgcmVqZWN0ZWQgb3IgYnJvYWRjYXN0IGZhaWxlZAoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQyMC5uZXh0ID0gMTY7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmhlbHBlcnMud2FpdERlbGF5KDEwKTsKCiAgICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgICAgICBfY29udGV4dDIwLm5leHQgPSAxODsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzNi5jaGVja1RYKHR4UmF3LnR4SWQpOwoKICAgICAgICAgICAgICAgIGNhc2UgMTg6CiAgICAgICAgICAgICAgICAgIHR4U3VjY2VzcyA9IF9jb250ZXh0MjAuc2VudDsKCiAgICAgICAgICAgICAgICAgIGlmICh0eFN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHR4UmF3LnR4SWQpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignQnRjU3dhcDogY2FudCB3aXRoZHJhdycsICdHZW5lcmF0ZWQgVFggbm90IGZvdW5kJyk7CiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCdUWCBub3QgZm91bmQuIFRyeSBpdCBsYXRlci4gJyArIHR4UmF3LnR4SWQpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBfY29udGV4dDIwLm5leHQgPSAyNzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAyMjoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQyMC5wcmV2ID0gMjI7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjAudDAgPSBfY29udGV4dDIwWyJjYXRjaCJdKDApOwogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ0J0Y1N3YXA6IGNhbnQgd2l0aGRyYXcnLCBfY29udGV4dDIwLnQwLm1lc3NhZ2UpOwoKICAgICAgICAgICAgICAgICAgaWYgKF9jb250ZXh0MjAudDAucmVzICYmIC9ub24tZmluYWwvLnRlc3QoX2NvbnRleHQyMC50MC5yZXMudGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSAnVHJ5IGl0IGxhdGVyJzsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgvVG90YWwgbGVzcyB0aGFuIGZlZS8udGVzdChfY29udGV4dDIwLnQwLm1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKC9Ub3RhbCBsZXNzIHRoYW4gZmVlOiAwLy50ZXN0KF9jb250ZXh0MjAudDAubWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9ICdBZGRyZXNzIGlzIGVtcHR5JzsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gJ0xlc3MgdGhhbiBmZWUnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSBfY29udGV4dDIwLnQwOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3JNZXNzYWdlKTsKCiAgICAgICAgICAgICAgICBjYXNlIDI3OgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjAuc3RvcCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwgX2NhbGxlZTIwLCBudWxsLCBbWzAsIDIyXV0pOwogICAgICAgIH0pKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeDI3LCBfeDI4KSB7CiAgICAgICAgICByZXR1cm4gX3JlZjE4LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgICAgfSgpKTsKICAgIH0KICAgIC8qKg0KICAgICAqIA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eElEDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNoZWNrVFgiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jaGVja1RYID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIxKHR4SUQpIHsKICAgICAgICB2YXIgdHhJbmZvOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIxJChfY29udGV4dDIxKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjEucHJldiA9IF9jb250ZXh0MjEubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjaGVjayB0eCcpOwogICAgICAgICAgICAgICAgX2NvbnRleHQyMS5uZXh0ID0gMzsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZldGNoVHhJbmZvKHR4SUQpOwoKICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICB0eEluZm8gPSBfY29udGV4dDIxLnNlbnQ7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygndHhJbmZvJywgdHhJbmZvKTsKCiAgICAgICAgICAgICAgICBpZiAoISh0eEluZm8gJiYgdHhJbmZvLnNlbmRlckFkZHJlc3MgJiYgdHhJbmZvLnR4aWQgJiYgdHhJbmZvLnR4aWQudG9Mb3dlckNhc2UoKSA9PSB0eElELnRvTG93ZXJDYXNlKCkpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjEubmV4dCA9IDc7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIxLmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIxLmFicnVwdCgicmV0dXJuIiwgZmFsc2UpOwoKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIxLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUyMSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGNoZWNrVFgoX3gyOSkgewogICAgICAgIHJldHVybiBfY2hlY2tUWC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY2hlY2tUWDsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhLnNjcmlwdFZhbHVlcw0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnNlY3JldA0KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGhhbmRsZVRyYW5zYWN0aW9uSGFzaA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoTmFtZQ0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZWZ1bmQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlZnVuZChkYXRhLCBoYXNoTmFtZSkgewogICAgICByZXR1cm4gdGhpcy53aXRoZHJhdyhkYXRhLCB0cnVlLCBoYXNoTmFtZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAid2l0aGRyYXdGcm9tU3dhcCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3dpdGhkcmF3RnJvbVN3YXAgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMjIoX3JlZjE5KSB7CiAgICAgICAgdmFyIGZsb3csIHV0eG9DbGFzcywgY29pbjsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyMiQoX2NvbnRleHQyMikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIyLnByZXYgPSBfY29udGV4dDIyLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBmbG93ID0gX3JlZjE5LmZsb3c7CiAgICAgICAgICAgICAgICB1dHhvQ2xhc3MgPSB0aGlzOwogICAgICAgICAgICAgICAgY29pbiA9IHRoaXMuX3N3YXBOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICBfY29udGV4dDIyLm5leHQgPSA1OwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KGZ1bmN0aW9uIChzdG9wUmVwZWF0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmxvdyRzdGF0ZTMgPSBmbG93LnN0YXRlLAogICAgICAgICAgICAgICAgICAgICAgc2VjcmV0ID0gX2Zsb3ckc3RhdGUzLnNlY3JldCwKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlcyA9IF9mbG93JHN0YXRlMy51dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgc3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoID0gX2Zsb3ckc3RhdGUzWyIiLmNvbmNhdChjb2luLCAiU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoIildOwoKICAgICAgICAgICAgICAgICAgaWYgKHN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZiAoIXNjcmlwdFZhbHVlcykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIlRoZXJlIGlzIG5vIFwidXR4b1NjcmlwdFZhbHVlc1wiIGluIHN0YXRlLiBObyB3YXkgdG8gY29udGludWUgc3dhcC4uLiIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICByZXR1cm4gZmxvdy5idGNTd2FwLndpdGhkcmF3KHsKICAgICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IHNjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgICBzZWNyZXQ6IHNlY3JldCwKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbkFkZHJlc3M6IGZsb3cuc3dhcC5kZXN0aW5hdGlvbkJ1eUFkZHJlc3MKICAgICAgICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCd3aXRoZHJhdyBoYXNoJywgaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZShfZGVmaW5lUHJvcGVydHkoe30sICIiLmNvbmNhdChjb2luLCAiU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoIiksIGhhc2gpLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgIGZsb3cuZmluaXNoU3RlcChfZGVmaW5lUHJvcGVydHkoe30sICJpcyIuY29uY2F0KGNvaW4sICJXaXRoZHJhd24iKSwgdHJ1ZSksIHsKICAgICAgICAgICAgICAgICAgc3RlcDogIndpdGhkcmF3LXV0eG8iCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyMi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMjIsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiB3aXRoZHJhd0Zyb21Td2FwKF94MzApIHsKICAgICAgICByZXR1cm4gX3dpdGhkcmF3RnJvbVN3YXAuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHdpdGhkcmF3RnJvbVN3YXA7CiAgICB9KCkKICB9XSk7CgogIHJldHVybiBVVFhPQmxvY2tjaGFpbjsKfShTd2FwSW50ZXJmYWNlKTsKCmV4cG9ydCBkZWZhdWx0IFVUWE9CbG9ja2NoYWluOw=="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.swaps/UTXOBlockchain.ts"],"names":["debug","SwapInterface","constants","util","BigNumber","UTXOBlockchain","options","undefined","fetchBalance","Error","fetchUnspents","broadcastTx","fetchTxInfo","console","warn","estimateFeeValue","_swapName","swapName","COINS","btc","checkWithdraw","feeValue","account","networks","skipFetchConfidence","skipCheckCanBeReplaces","skipLockTime","skipRecipientPublickKey","processUnspent","unspent","txid","vout","sendTransaction","app","main","mainName","name","mainParams","params","test","testName","testParams","env","bitcoin","network","isMainNet","inSatoshis","size","speed","address","method","txSize","estimatedFeeRaw","estimatedFee","toNumber","dividedBy","dp","ROUND_UP","unspents","expectedConfidenceLevel","feesToConfidence","fees","multipliedBy","getTxFee","currentFastestFee","isLessThan","fetchConfidence","senderAddress","txConfirms","confirmations","confirmationsToConfidence","confs","confidenceFromConfirmations","isGreaterThanOrEqualTo","confFromFee","error","message","Promise","all","map","confidences","filter","utxo","index","resolve","filtered","data","inputIndex","script","txRaw","secret","scriptData","payments","p2sh","redeem","output","hashType","Transaction","SIGHASH_ALL","privKey","ECPair","fromWIF","services","auth","accounts","getPrivateKey","signatureHash","hashForSignature","redeemScriptSig","input","compile","signature","encode","sign","getPublicKeyBuffer","Buffer","from","replace","setInputScript","hashName","hashOpcodeName","toUpperCase","hashOpcode","opcodes","secretHash","ownerPublicKey","recipientPublicKey","lockTime","OP_SIZE","OP_EQUALVERIFY","OP_EQUAL","OP_IF","OP_ELSE","number","OP_CHECKLOCKTIMEVERIFY","OP_DROP","OP_ENDIF","OP_CHECKSIG","scriptAddress","log","fetchFullUnspentInfo","info","unspentsFullInfo","notReplacedUnspents","notReplacedInputs","inputs","sequenceNumber","toString","length","expected","createScript","waitConfirm","isWhiteList","expectedConfidence","confidence","fetchUnspentsFullInfo","canBeReplaced","checkCanBeReplaces","filterConfirmedUnspents","confirmedUnspents","helpers","waitDelay","expectedValue","value","integerValue","totalUnspent","reduce","summ","satoshis","filterConfidentUnspents","confidentUnspents","totalConfidentUnspent","isGreaterThan","handleTransactionHash","scriptValues","amount","reject","scriptBalance","ownerAddress","getAddress","fundValue","tx","TransactionBuilder","feeValueBN","skipValue","forEach","addInput","addOutput","__INPUTS","buildIncomplete","getId","toHex","then","result","err","isRefund","destinationAddress","destAddress","hasWithdraw","toLowerCase","txId","alreadyWithdrawed","setLockTime","_","_signTransaction","txHex","getWithdrawRawTransaction","flow","utxoClass","coin","onTransactionHash","txID","state","scriptCreatingTransactionHash","utxoScriptCreatingTransactionHash","utxoScriptValues","setState","swap","room","once","sendMessage","event","sellAmount","isBalanceEnough","fundScriptRepeat","fundScript","waitUnlockUTXO","repeatAsyncUntilResult","stopRepeat","isStoppedSwap","checkScriptBalance","getBalance","balance","isEnoughMoney","times","div","finishStep","step","getRefundRawTransaction","checkTX","txSuccess","res","text","errorMessage","txInfo","withdraw","swapWithdrawTransactionHash","btcSwap","destinationBuyAddress","hash"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAAA,OAAOA,KAAP,MAAkB,OAAlB;AACA,SAAkBC,aAAlB,EAAiCC,SAAjC,EAA4CC,IAA5C,QAAwD,UAAxD;AACA,OAAOC,SAAP,MAAsB,cAAtB;;IAIMC,c;;;;;AAwBJ;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACE,0BAAYC,OAAZ,EAAqB;AAAA;;AAAA;;AACnB;;AADmB,gEA/BD,IA+BC;;AAAA,mEA9BIC,SA8BJ;;AAAA,oEA7BKA,SA6BL;;AAAA,kEA5BGA,SA4BH;;AAAA,oEA3BKA,SA2BL;;AAAA,+DA1BF,GA0BE;;AAAA,kEAzBGA,SAyBH;;AAAA,uEAxBQA,SAwBR;;AAAA,8DAtBHA,SAsBG;;AAAA,+DArBLA,SAqBK;;AAAA,8DApBNA,SAoBM;;AAAA,0EAlBU,KAkBV;;AAAA,6EAjBa,KAiBb;;AAAA,mEAhBG,KAgBH;;AAAA,8EAfc,KAed;;AAAA,qEAbMA,SAaN;;AAAA;;AAAA,0DAVNA,SAUM;;AAGnB,QAAI,OAAOD,OAAO,CAACE,YAAf,KAAgC,UAApC,EAAgD;AAC9C,YAAM,IAAIC,KAAJ,CAAU,kCAAV,CAAN;AACD;;AACD,QAAI,OAAOH,OAAO,CAACI,aAAf,KAAiC,UAArC,EAAiD;AAC/C,YAAM,IAAID,KAAJ,CAAU,mCAAV,CAAN;AACD;;AACD,QAAI,OAAOH,OAAO,CAACK,WAAf,KAA+B,UAAnC,EAA+C;AAC7C,YAAM,IAAIF,KAAJ,CAAU,iCAAV,CAAN;AACD;;AACD,QAAI,OAAOH,OAAO,CAACM,WAAf,KAA+B,UAAnC,EAA+C;AAC7C;AACAC,MAAAA,OAAO,CAACC,IAAR;AACD;;AACD,QAAI,OAAOR,OAAO,CAACS,gBAAf,KAAoC,UAAxC,EAAoD;AAClD;AACAF,MAAAA,OAAO,CAACC,IAAR;AACD;;AAED,UAAKE,SAAL,GAAsBV,OAAO,CAACW,QAAR,IAAoBf,SAAS,CAACgB,KAAV,CAAgBC,GAA1D;AACA,UAAKX,YAAL,GAAsBF,OAAO,CAACE,YAA9B;AACA,UAAKE,aAAL,GAAsBJ,OAAO,CAACI,aAA9B;AACA,UAAKC,WAAL,GAAsBL,OAAO,CAACK,WAA9B;AACA,UAAKS,aAAL,GAAsBd,OAAO,CAACc,aAA9B;AACA,UAAKC,QAAL,GAAsBf,OAAO,CAACe,QAAR,IAAoB,GAA1C;;AACA,UAAKT,WAAL,GAAsBN,OAAO,CAACM,WAAR,IAAwB,YAAM,CAAE,CAAtD;;AACA,UAAKG,gBAAL,GAAwBT,OAAO,CAACS,gBAAR,IAA6B;AAAA,aAAM,CAAN;AAAA,KAArD;;AAEA,UAAKO,OAAL,GAAsBhB,OAAO,CAACgB,OAAR,SAAtB;AACA,UAAKC,QAAL,GAAsBjB,OAAO,CAACiB,QAA9B;AAEA,UAAKC,mBAAL,GAA2BlB,OAAO,CAACkB,mBAAR,IAA+B,KAA1D;AACA,UAAKC,sBAAL,GAA8BnB,OAAO,CAACmB,sBAAR,IAAkC,KAAhE;AACA,UAAKC,YAAL,GAAoBpB,OAAO,CAACoB,YAAR,IAAwB,KAA5C;AACA,UAAKC,uBAAL,GAA+BrB,OAAO,CAACqB,uBAAR,IAAmC,KAAlE;;AAEA,UAAKC,cAAL,GAAsBtB,OAAO,CAACsB,cAAR,IACpB,UAACC,OAAD,EAAa;AAAA,UACHC,IADG,GACYD,OADZ,CACHC,IADG;AAAA,UACGC,IADH,GACYF,OADZ,CACGE,IADH;AAEX,aAAO;AAAED,QAAAA,IAAI,EAAJA,IAAF;AAAQC,QAAAA,IAAI,EAAJA;AAAR,OAAP;AACD,KAJH;;AAMA,UAAKC,eAAL,GAAuB1B,OAAO,CAAC0B,eAA/B;AA5CmB;AA6CpB;;;;WAED,mBAAUC,GAAV,EAAe;AACb,oFAAgBA,GAAhB;;AAEA,WAAKA,GAAL,GAAWA,GAAX;AAEA;;AALa,2BAeT,KAAKV,QAfI;AAAA,+CAOXW,IAPW;AAAA,UAQHC,QARG,uBAQTC,IARS;AAAA,UASDC,UATC,uBASTC,MATS;AAAA,+CAWXC,IAXW;AAAA,UAYHC,QAZG,uBAYTJ,IAZS;AAAA,UAaDK,UAbC,uBAaTH,MAbS;AAiBb,UAAIH,QAAQ,IAAIE,UAAhB,EAA4B,KAAKJ,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBpB,QAArB,CAA8BY,QAA9B,IAA0CE,UAA1C;AAC5B,UAAIG,QAAQ,IAAIC,UAAhB,EAA4B,KAAKR,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBpB,QAArB,CAA8BiB,QAA9B,IAA0CC,UAA1C;AAE5B,WAAKG,OAAL,GACE,KAAKX,GAAL,CAASY,SAAT,KACI,KAAKZ,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBpB,QAArB,CAA8BY,QAA9B,CADJ,GAEI,KAAKF,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBpB,QAArB,CAA8BiB,QAA9B,CAHN;AAKD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;+EACE;AAAA;;AAAA;AAAA;AAAA;AAAA;AACEM,gBAAAA,UADF,QACEA,UADF,EAEEC,IAFF,QAEEA,IAFF,oBAGEC,KAHF,EAGEA,KAHF,2BAGU,MAHV,eAIEC,OAJF,QAIEA,OAJF;AAAA;AAAA,uBAagC,KAAKlC,gBAAL,CAAsB;AAClD+B,kBAAAA,UAAU,EAAE,IADsC;AAElDG,kBAAAA,OAAO,EAAPA,OAFkD;AAGlDD,kBAAAA,KAAK,EAALA,KAHkD;AAIlDE,kBAAAA,MAAM,EAAE,MAJ0C;AAKlDC,kBAAAA,MAAM,EAAEJ;AAL0C,iBAAtB,CAbhC;;AAAA;AAaQK,gBAAAA,eAbR;AAqBQC,gBAAAA,YArBR,GAqBuB,IAAIjD,SAAJ,CAAcgD,eAAd,CArBvB;AAsBE,qBAAK/B,QAAL,GAAgBgC,YAAY,CAACC,QAAb,EAAhB;AAtBF,iDAwBSR,UAAU,GACbO,YADa,GAEbA,YAAY,CAACE,SAAb,CAAuB,GAAvB,EAA4BC,EAA5B,CAA+B,CAA/B,EAAkCpD,SAAS,CAACqD,QAA5C,CA1BN;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AA6BA;AACF;AACA;AACA;AACA;AACA;AACA;;;;;8FACE,kBAA8BC,QAA9B;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAwCC,gBAAAA,uBAAxC,8DAAkE,IAAlE;;AAEQC,gBAAAA,gBAFR;AAAA,uFAE2B,kBAAOC,IAAP,EAAad,IAAb,EAAmBE,OAAnB;AAAA;AAAA;AAAA;AAAA;AAAA;AACvBY,4BAAAA,IAAI,GAAG,IAAIzD,SAAJ,CAAcyD,IAAd,EAAoBC,YAApB,CAAiC,GAAjC,EAAsCR,QAAtC,EAAP;AADuB;AAAA,mCAES,MAAI,CAACS,QAAL,CAAc;AAAEjB,8BAAAA,UAAU,EAAE,IAAd;AAAoBC,8BAAAA,IAAI,EAAJA,IAApB;AAA0BC,8BAAAA,KAAK,EAAE,MAAjC;AAAyCC,8BAAAA,OAAO,EAAPA;AAAzC,6BAAd,CAFT;;AAAA;AAEjBe,4BAAAA,iBAFiB;AAAA,8DAIhB,IAAI5D,SAAJ,CAAcyD,IAAd,EAAoBI,UAApB,CAA+BD,iBAA/B,IACH,IAAI5D,SAAJ,CAAcyD,IAAd,EAAoBN,SAApB,CAA8BS,iBAA9B,EAAiDV,QAAjD,EADG,GAEH,CANmB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAF3B;;AAAA,kCAEQM,gBAFR;AAAA;AAAA;AAAA;AAWE;;;AACMM,gBAAAA,eAZR;AAAA,uFAY0B,kBAAOrC,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iCAGlB,MAAI,CAACL,mBAHa;AAAA;AAAA;AAAA;;AAAA,8DAGe,CAHf;;AAAA;AAMpBqC,4BAAAA,IANoB,GAUlBhC,OAVkB,CAMpBgC,IANoB,EAOpBd,IAPoB,GAUlBlB,OAVkB,CAOpBkB,IAPoB,EAQpBoB,aARoB,GAUlBtC,OAVkB,CAQpBsC,aARoB,EASLC,UATK,GAUlBvC,OAVkB,CASpBwC,aAToB;;AAYhBC,4BAAAA,yBAZgB,GAYY,SAA5BA,yBAA4B,CAAAC,KAAK;AAAA,qCAAIA,KAAK,GAAG,CAAR,GAAY,CAAZ,GAAgB,CAApB;AAAA,6BAZjB;;AAahBC,4BAAAA,2BAbgB,GAacF,yBAAyB,CAACF,UAAD,CAbvC;;AAAA,iCAelB,IAAIhE,SAAJ,CAAcoE,2BAAd,EAA2CC,sBAA3C,CAAkEd,uBAAlE,CAfkB;AAAA;AAAA;AAAA;;AAAA,8DAgBba,2BAhBa;;AAAA;AAAA;;AAAA,kCAoBhBJ,UAAU,GAAG,CApBG;AAAA;AAAA;AAAA;;AAAA,8DAqBX,CArBW;;AAAA;AAAA,iCAwBhBP,IAxBgB;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAyBQD,gBAAgB,CAACC,IAAD,EAAOd,IAAP,EAAaoB,aAAb,CAzBxB;;AAAA;AAyBZO,4BAAAA,WAzBY;AAAA,8DA0BXA,WA1BW;;AAAA;AAAA,kCA6Bd,IAAIjE,KAAJ,kCAAoC2D,UAApC,qBAAyDP,IAAzD,qBAAwEd,IAAxE,8BAAgGoB,aAAhG,QA7Bc;;AAAA;AAAA;AAAA;AAgCpBtD,4BAAAA,OAAO,CAAC8D,KAAR,iEAA8E,aAAIC,OAAlF;AAhCoB,8DAkCbJ,2BAlCa;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAZ1B;;AAAA,kCAYQN,eAZR;AAAA;AAAA;AAAA;;AAAA;AAAA,uBAkDsCW,OAAO,CAACC,GAAR,CAAYpB,QAAQ,CAACqB,GAAT,CAAab,eAAb,CAAZ,CAlDtC;;AAAA;AAkDQc,gBAAAA,WAlDR;AAAA,kDAoDStB,QAAQ,CAACuB,MAAT,CAAgB,UAACC,IAAD,EAAOC,KAAP,EAAiB;AACtCnF,kBAAAA,KAAK,CAAC,iBAAD,CAAL,sBAAuCmF,KAAvC,SAAkDH,WAAW,CAACG,KAAD,CAA7D;AACA,yBAAO,IAAI/E,SAAJ,CAAc4E,WAAW,CAACG,KAAD,CAAzB,EAAkCV,sBAAlC,CAAyDd,uBAAzD,CAAP;AACD,iBAHM,CApDT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AA0DA;AACF;AACA;AACA;AACA;;;;;8FACE,kBAA8BD,QAA9B;AAAA;AAAA;AAAA;AAAA;AAAA,kDACS,IAAImB,OAAJ;AAAA,uFAAY,kBAAOO,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AACXC,4BAAAA,QADW,GACA3B,QAAQ,CAACuB,MAAT,CAAgB,UAACpD,OAAD,EAAa;AAAA,kCAE1CwC,aAF0C,GAGxCxC,OAHwC,CAE1CwC,aAF0C;;AAK5C,kCAAIA,aAAa,GAAG,CAApB,EAAuB;AACrB,uCAAO,IAAP;AACD;AACF,6BARgB,CADA;AAUjBe,4BAAAA,OAAO,CAACC,QAAD,CAAP;;AAViB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAZ;;AAAA;AAAA;AAAA;AAAA,oBADT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AAcA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACE,0BAAiBC,IAAjB,EAAuC;AAAA,UAAhBC,UAAgB,uEAAH,CAAG;AACrCvF,MAAAA,KAAK,CAAC,iBAAD,CAAL,CAAyB,sBAAzB,EAAiDuF,UAAjD;AADqC,UAGnCC,MAHmC,GAMjCF,IANiC,CAGnCE,MAHmC;AAAA,UAInCC,KAJmC,GAMjCH,IANiC,CAInCG,KAJmC;AAAA,UAKnCC,MALmC,GAMjCJ,IANiC,CAKnCI,MALmC;AAQrC,UAAMC,UAAU,GAAG,KAAK1D,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBiD,QAArB,CAA8BC,IAA9B,CAAmC;AACpDC,QAAAA,MAAM,EAAE;AACNC,UAAAA,MAAM,EAAEP,MADF;AAEN5C,UAAAA,OAAO,EAAE,KAAKA;AAFR,SAD4C;AAKpDA,QAAAA,OAAO,EAAE,KAAKA;AALsC,OAAnC,CAAnB;AAQA,UAAMoD,QAAQ,GAAQ,KAAK/D,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBsD,WAArB,CAAiCC,WAAvD;AACA,UAAMC,OAAO,GAAG,KAAKlE,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqByD,MAArB,CAA4BC,OAA5B,CACd,KAAKpE,GAAL,CAASqE,QAAT,CAAkBC,IAAlB,CAAuBC,QAAvB,CAAgC,KAAKlF,OAArC,EAA8CmF,aAA9C,EADc,EAEd,KAAK7D,OAFS,CAAhB;AAKA,UAAM8D,aAAa,GAAGjB,KAAK,CAACkB,gBAAN,CAAuBpB,UAAvB,EAAmCI,UAAU,CAACG,MAAX,CAAkBC,MAArD,EAA6DC,QAA7D,CAAtB;AAEA,UAAMY,eAAe,GAAG,KAAK3E,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBiD,QAArB,CAA8BC,IAA9B,CAAmC;AACzDjD,QAAAA,OAAO,EAAE,KAAKA,OAD2C;AAEzDkD,QAAAA,MAAM,EAAE;AACNlD,UAAAA,OAAO,EAAE,KAAKA,OADR;AAENmD,UAAAA,MAAM,EAAEJ,UAAU,CAACG,MAAX,CAAkBC,MAFpB;AAGNc,UAAAA,KAAK,EAAE,KAAK5E,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqB6C,MAArB,CAA4BsB,OAA5B,CAAoC,CACzC,KAAK7E,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqB6C,MAArB,CAA4BuB,SAA5B,CAAsCC,MAAtC,CAA6Cb,OAAO,CAACc,IAAR,CAAaP,aAAb,CAA7C,EAA0EV,QAA1E,CADyC,EAEzC,KAAK/D,GAAL,CAASqE,QAAT,CAAkBC,IAAlB,CAAuBC,QAAvB,CAAgC,KAAKlF,OAArC,EAA8C4F,kBAA9C,EAFyC,EAGzCC,MAAM,CAACC,IAAP,CAAY1B,MAAM,CAAC2B,OAAP,CAAe,KAAf,EAAsB,EAAtB,CAAZ,EAAuC,KAAvC,CAHyC,CAApC;AAHD;AAFiD,OAAnC,EAWrBR,KAXH;AAaApB,MAAAA,KAAK,CAAC6B,cAAN,CAAqB/B,UAArB,EAAiCqB,eAAjC;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACE,sBAAatB,IAAb,EAA2C;AAAA,UAAxBiC,QAAwB,uEAAb,WAAa;AACzC,UAAMC,cAAc,gBAASD,QAAQ,CAACE,WAAT,EAAT,CAApB;AACA,UAAMC,UAAU,GAAG,KAAKzF,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6BH,cAA7B,CAAnB;AAFyC,UAIjCI,UAJiC,GAI4BtC,IAJ5B,CAIjCsC,UAJiC;AAAA,UAIrBC,cAJqB,GAI4BvC,IAJ5B,CAIrBuC,cAJqB;AAAA,UAILC,kBAJK,GAI4BxC,IAJ5B,CAILwC,kBAJK;AAAA,UAIeC,QAJf,GAI4BzC,IAJ5B,CAIeyC,QAJf;AAMzC,UAAMvC,MAAM,GAAG,KAAKvD,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqB6C,MAArB,CAA4BsB,OAA5B,CAAoC,CAEjD,KAAK7E,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6BK,OAFoB,EAGjDb,MAAM,CAACC,IAAP,CAAY,IAAZ,EAAkB,KAAlB,CAHiD,EAIjD,KAAKnF,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6BM,cAJoB,EAMjDP,UANiD,EAOjDP,MAAM,CAACC,IAAP,CAAYQ,UAAZ,EAAwB,KAAxB,CAPiD,EAQjD,KAAK3F,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6BM,cARoB,EAUjDd,MAAM,CAACC,IAAP,CAAYU,kBAAZ,EAAgC,KAAhC,CAViD,EAWjD,KAAK7F,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6BO,QAXoB,EAYjD,KAAKjG,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6BQ,KAZoB,EAcjDhB,MAAM,CAACC,IAAP,CAAYU,kBAAZ,EAAgC,KAAhC,CAdiD,EAgBjD,KAAK7F,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6BS,OAhBoB,EAkBjD,KAAKnG,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqB6C,MAArB,CAA4B6C,MAA5B,CAAmCrB,MAAnC,CAA0Ce,QAA1C,CAlBiD,EAmBjD,KAAK9F,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6BW,sBAnBoB,EAoBjD,KAAKrG,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6BY,OApBoB,EAqBjDpB,MAAM,CAACC,IAAP,CAAYS,cAAZ,EAA4B,KAA5B,CArBiD,EAuBjD,KAAK5F,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6Ba,QAvBoB,EAyBjD,KAAKvG,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBgF,OAArB,CAA6Bc,WAzBoB,CAApC,CAAf;AA4BA,UAAM9C,UAAU,GAAG,KAAK1D,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqBiD,QAArB,CAA8BC,IAA9B,CAAmC;AACpDC,QAAAA,MAAM,EAAE;AACNC,UAAAA,MAAM,EAAEP,MADF;AAEN5C,UAAAA,OAAO,EAAE,KAAKA;AAFR,SAD4C;AAKpDA,QAAAA,OAAO,EAAE,KAAKA;AALsC,OAAnC,CAAnB;AAOA,UAAM8F,aAAa,GAAG/C,UAAU,CAAC1C,OAAjC;AAEA,aAAO;AACLyF,QAAAA,aAAa,EAAbA,aADK;AAELlD,QAAAA,MAAM,EAANA;AAFK,OAAP;AAID;;;WAED,+BAAsBkD,aAAtB,EAAqD;AAAA;;AACnD7H,MAAAA,OAAO,CAAC8H,GAAR,CAAY,uBAAZ,EAAqCD,aAArC;AACA,aAAO,IAAI7D,OAAJ;AAAA,6EAAY,kBAAOO,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yBACW,MAAI,CAAC1E,aAAL,CAAmBgI,aAAnB,CADX;;AAAA;AACXhF,kBAAAA,QADW;;AAEXkF,kBAAAA,oBAFW;AAAA,yFAEY,kBAAO/G,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAC3BhB,8BAAAA,OAAO,CAAC8H,GAAR,CAAY,SAAZ,EAAuB9G,OAAvB;AAD2B;AAAA;AAAA,qCAGN,MAAI,CAACjB,WAAL,CAAiBiB,OAAO,CAACC,IAAzB,CAHM;;AAAA;AAGnB+G,8BAAAA,IAHmB;AAAA,gGAKpBhH,OALoB,GAMpBgH,IANoB;;AAAA;AAAA;AAAA;AASzBhI,8BAAAA,OAAO,CAAC8H,GAAR,CAAY,aAAZ;AATyB,gEAUlB,KAVkB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAFZ;;AAAA,oCAEXC,oBAFW;AAAA;AAAA;AAAA;;AAAA;AAAA,yBAgBc/D,OAAO,CAACC,GAAR,CAAYpB,QAAQ,CAACqB,GAAT,CAAa6D,oBAAb,CAAZ,CAhBd;;AAAA;AAgBXE,kBAAAA,gBAhBW;AAiBjB1D,kBAAAA,OAAO,CAAC0D,gBAAgB,CAAC7D,MAAjB,CAAwB,UAACpD,OAAD;AAAA,2BAAaA,OAAO,KAAK,KAAzB;AAAA,mBAAxB,CAAD,CAAP;;AAjBiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAZ;;AAAA;AAAA;AAAA;AAAA,UAAP;AAmBD;;;WAED,4BAAmB6B,QAAnB,EAA6B;AAC3B,UAAI,KAAKjC,sBAAT,EAAiC,OAAO,KAAP;AACjC,UAAMsH,mBAAmB,GAAGrF,QAAQ,CAACuB,MAAT,CAAgB,UAACpD,OAAD,EAAa;AACvD,YAAMmH,iBAAiB,GAAGnH,OAAO,CAACoH,MAAR,CAAehE,MAAf,CAAsB,UAAC4B,KAAD,EAAW;AACzD,iBAAOA,KAAK,CAACqC,cAAN,CAAqBC,QAArB,CAA8B,EAA9B,gBAAP;AACD,SAFyB,CAA1B;AAGA,eAAOH,iBAAiB,CAACI,MAAlB,KAA6BvH,OAAO,CAACoH,MAAR,CAAeG,MAAnD;AACD,OAL2B,CAA5B;AAMA,aAAO,EAAEL,mBAAmB,CAACK,MAApB,KAA+B1F,QAAQ,CAAC0F,MAA1C,CAAP;AACD;AACD;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;kFACE,kBAAkB9D,IAAlB,EAAwB+D,QAAxB,EAAkC9B,QAAlC;AAAA;;AAAA;AAAA;AAAA;AAAA;AACUO,gBAAAA,kBADV,GAC2CxC,IAD3C,CACUwC,kBADV,EAC8BC,QAD9B,GAC2CzC,IAD3C,CAC8ByC,QAD9B;AAAA,qCAEoC,KAAKuB,YAAL,CAAkBhE,IAAlB,EAAwBiC,QAAxB,CAFpC,EAEUmB,aAFV,sBAEUA,aAFV,EAEyBlD,MAFzB,sBAEyBA,MAFzB;AAKI+D,gBAAAA,WALJ,GAOMF,QAPN,CAKIE,WALJ,EAMIC,WANJ,GAOMH,QAPN,CAMIG,WANJ;;AAAA,qBASMA,WATN;AAAA;AAAA;AAAA;;AAUI3I,gBAAAA,OAAO,CAAC8H,GAAR,CAAY,wCAAZ;AAVJ;;AAAA;AAcQc,gBAAAA,kBAdR,GAc8BJ,QAAQ,CAACK,UAAT,KAAwBnJ,SAAzB,GAAsC8I,QAAQ,CAACK,UAA/C,GAA4D,IAdzF;AAeE7I,gBAAAA,OAAO,CAAC8H,GAAR,CAAY,QAAZ,EAAsBD,aAAtB;AAfF;AAAA,uBAgBgC,KAAKiB,qBAAL,CAA2BjB,aAA3B,CAhBhC;;AAAA;AAgBQhF,gBAAAA,QAhBR;AAkBE7C,gBAAAA,OAAO,CAAC8H,GAAR,CAAY,QAAZ,EAAsBD,aAAtB;AACA7H,gBAAAA,OAAO,CAAC8H,GAAR,CAAY,UAAZ,EAAwBjF,QAAxB;;AAnBF,oBAoBOA,QAAQ,CAAC0F,MApBhB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAuBE;AACMQ,gBAAAA,aAxBR,GAwBwB,KAAKC,kBAAL,CAAwBnG,QAAxB,CAxBxB;;AAyBE,oBAAIkG,aAAJ,EAAmB;AACjB/I,kBAAAA,OAAO,CAACC,IAAR,0BAA+B4H,aAA/B;AACD;;AA3BH,sBA4BMa,WAAW,IAAIK,aA5BrB;AAAA;AAAA;AAAA;;AAAA,oBA8BSlG,QAAQ,CAAC0F,MA9BlB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA,uBA+B2C,KAAKU,uBAAL,CAA6BpG,QAA7B,CA/B3C;;AAAA;AA+BUqG,gBAAAA,iBA/BV;;AAAA,sBAgCQrG,QAAQ,CAAC0F,MAAT,KAAoBW,iBAAiB,CAACX,MAhC9C;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA,uBAiCUjJ,IAAI,CAAC6J,OAAL,CAAaC,SAAb,CAAuB,EAAvB,CAjCV;;AAAA;AAAA,qBAkCQL,aAlCR;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;;AAAA;AAsCQM,gBAAAA,aAtCR,GAsCwBb,QAAQ,CAACc,KAAT,CAAerG,YAAf,CAA4B,GAA5B,EAAiCsG,YAAjC,EAtCxB;AAuCQC,gBAAAA,YAvCR,GAuCwB3G,QAAQ,CAAC4G,MAAT,CAAgB,UAACC,IAAD;AAAA,sBAASC,QAAT,SAASA,QAAT;AAAA,yBAAwBD,IAAI,GAAGC,QAA/B;AAAA,iBAAhB,EAAyD,CAAzD,CAvCxB;AAAA;AAAA,uBAyCkC,KAAKC,uBAAL,CAA6B/G,QAA7B,EAAuC+F,kBAAvC,CAzClC;;AAAA;AAyCQiB,gBAAAA,iBAzCR;AA2CQC,gBAAAA,qBA3CR,GA2CgCD,iBAAiB,CAACJ,MAAlB,CAAyB,UAACC,IAAD;AAAA,sBAASC,QAAT,SAASA,QAAT;AAAA,yBAAwBD,IAAI,GAAGC,QAA/B;AAAA,iBAAzB,EAAkE,CAAlE,CA3ChC;;AAAA,qBA6CMN,aAAa,CAACU,aAAd,CAA4BP,YAA5B,CA7CN;AAAA;AAAA;AAAA;;AAAA,mFA8CqCH,aAAa,CAAC5G,QAAd,EA9CrC,oBA8CuE+G,YA9CvE,wBA8CiG3B,aA9CjG;;AAAA;AAAA,sBAgDM,CAAC,KAAKhH,YAAN,IAAsB2H,QAAQ,CAACtB,QAAT,GAAoBA,QAhDhD;AAAA;AAAA;AAAA;;AAAA,sFAiDwCsB,QAAQ,CAACtB,QAjDjD,oBAiDmEA,QAjDnE,wBAiDyFW,aAjDzF;;AAAA;AAAA,sBAmDM,CAAC,KAAK/G,uBAAN,IAAiC0H,QAAQ,CAACvB,kBAAT,KAAgCA,kBAnDvE;AAAA;AAAA;AAAA;;AAAA,iGAoDmDuB,QAAQ,CAACvB,kBApD5D,oBAoDwFA,kBApDxF;;AAAA;AAAA,qBAsDMoC,aAAa,CAACU,aAAd,CAA4BD,qBAA5B,CAtDN;AAAA;AAAA;AAAA;;AAAA,mFAuDqCT,aAAa,CAACf,QAAd,EAvDrC,oCAuDuFM,kBAvDvF,oBAuDmHkB,qBAvDnH,wBAuDsJjC,aAvDtJ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AA2DA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACE,oBAAWpD,IAAX,EAAiBuF,qBAAjB,EAAmDtD,QAAnD,EAAsE;AAAA;;AAAA,UAC5DuD,YAD4D,GACnCxF,IADmC,CAC5DwF,YAD4D;AAAA,UAC9CC,MAD8C,GACnCzF,IADmC,CAC9CyF,MAD8C;AAGpElK,MAAAA,OAAO,CAAC8H,GAAR,CAAY,YAAZ,EAA0BrD,IAA1B;AACA,aAAO,IAAIT,OAAJ;AAAA,6EAAY,mBAAOO,OAAP,EAAgB4F,MAAhB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wCAEW,MAAI,CAAC1B,YAAL,CAAkBwB,YAAlB,EAAgCvD,QAAhC,CAFX,EAEPmB,aAFO,uBAEPA,aAFO;AAIf7H,kBAAAA,OAAO,CAAC8H,GAAR,CAAY,eAAZ,EAA6BD,aAA7B;AAJe;AAAA,yBAKa,MAAI,CAAClI,YAAL,CAAkBkI,aAAlB,CALb;;AAAA;AAKTuC,kBAAAA,aALS;;AAAA,uBAMX,IAAI7K,SAAJ,CAAc6K,aAAd,EAA6BL,aAA7B,CAA2C,CAA3C,CANW;AAAA;AAAA;AAAA;;AAOb;AACAI,kBAAAA,MAAM,CAAC,uBAAD,CAAN;AARa;;AAAA;AAYTE,kBAAAA,YAZS,GAYM,MAAI,CAACjJ,GAAL,CAASqE,QAAT,CAAkBC,IAAlB,CAAuBC,QAAvB,CAAgC,MAAI,CAAClF,OAArC,EAA8C6J,UAA9C,EAZN;AAcTC,kBAAAA,SAdS,GAcOL,MAAM,CAACjH,YAAP,CAAoB,GAApB,EAAyBsG,YAAzB,GAAwC9G,QAAxC,EAdP;AAeT+H,kBAAAA,EAfS,GAeO,IAAI,MAAI,CAACpJ,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqB2I,kBAAzB,CAA4C,MAAI,CAAC1I,OAAjD,CAfP;AAAA;AAAA,yBAgBa,MAAI,CAAClC,aAAL,CAAmBwK,YAAnB,CAhBb;;AAAA;AAgBTxH,kBAAAA,QAhBS;AAAA;AAAA,yBAiBa,MAAI,CAACK,QAAL,CAAc;AAAEjB,oBAAAA,UAAU,EAAE,IAAd;AAAoBG,oBAAAA,OAAO,EAAEiI;AAA7B,mBAAd,CAjBb;;AAAA;AAiBTK,kBAAAA,UAjBS;AAkBTlK,kBAAAA,QAlBS,GAkBOkK,UAAU,CAACnB,YAAX,GAA0B9G,QAA1B,EAlBP;AAmBT+G,kBAAAA,YAnBS,GAmBO3G,QAAQ,CAAC4G,MAAT,CAAgB,UAACC,IAAD;AAAA,wBAASC,QAAT,UAASA,QAAT;AAAA,2BAAwBD,IAAI,GAAGC,QAA/B;AAAA,mBAAhB,EAAyD,CAAzD,CAnBP;AAoBTgB,kBAAAA,SApBS,GAoBOnB,YAAY,GAAGe,SAAf,GAA2B/J,QApBlC;;AAAA,wBAsBXgJ,YAAY,GAAGhJ,QAAQ,GAAG+J,SAtBf;AAAA;AAAA;AAAA;;AAAA,wBAuBP,IAAI3K,KAAJ,gCAAkC4J,YAAlC,gBAAoDhJ,QAApD,gBAAkE+J,SAAlE,EAvBO;;AAAA;AA0Bf1H,kBAAAA,QAAQ,CAAC+H,OAAT,CAAiB,UAAC5J,OAAD,EAAa;AAAA,gDACL,MAAI,CAACD,cAAL,CAAoBC,OAApB,CADK;AAAA,wBACpBC,IADoB,yBACpBA,IADoB;AAAA,wBACdC,IADc,yBACdA,IADc;;AAE5BsJ,oBAAAA,EAAE,CAACK,QAAH,CAAY5J,IAAZ,EAAkBC,IAAlB,EAAwB,UAAxB;AACD,mBAHD;AAIAsJ,kBAAAA,EAAE,CAACM,SAAH,CAAajD,aAAb,EAA4B0C,SAA5B;AACAC,kBAAAA,EAAE,CAACM,SAAH,CAAa,MAAI,CAAC1J,GAAL,CAASqE,QAAT,CAAkBC,IAAlB,CAAuBC,QAAvB,CAAgC,MAAI,CAAClF,OAArC,EAA8C6J,UAA9C,EAAb,EAAyEK,SAAzE;AAEMrF,kBAAAA,OAjCS,GAiCC,MAAI,CAAClE,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqByD,MAArB,CAA4BC,OAA5B,CACd,MAAI,CAACpE,GAAL,CAASqE,QAAT,CAAkBC,IAAlB,CAAuBC,QAAvB,CAAgC,MAAI,CAAClF,OAArC,EAA8CmF,aAA9C,EADc,EAEd,MAAI,CAAC7D,OAFS,CAjCD;;AAsCfyI,kBAAAA,EAAE,CAACO,QAAH,CAAYH,OAAZ,CAAoB,UAAC5E,KAAD,EAAQ1B,KAAR,EAAkB;AACpCkG,oBAAAA,EAAE,CAACpE,IAAH,CAAQ9B,KAAR,EAAegB,OAAf;AACD,mBAFD;;AAIMV,kBAAAA,KA1CS,GA0CD4F,EAAE,CAACQ,eAAH,EA1CC;;AA4Cf,sBAAI,OAAOhB,qBAAP,KAAiC,UAArC,EAAiD;AAC/CA,oBAAAA,qBAAqB,CAACpF,KAAK,CAACqG,KAAN,EAAD,CAArB;AACD;;AAED,kBAAA,MAAI,CAACnL,WAAL,CAAiB8E,KAAK,CAACsG,KAAN,EAAjB,EAAgCC,IAAhC,CAAqC,UAACC,MAAD,EAAY;AAC/C7G,oBAAAA,OAAO,CAAC6G,MAAD,CAAP;AACD,mBAFD,WAEU,UAACC,GAAD,EAAS;AACjBlB,oBAAAA,MAAM,CAACkB,GAAD,CAAN;AACD,mBAJD;;AAhDe;AAAA;;AAAA;AAAA;AAAA;AAuDflB,kBAAAA,MAAM,eAAN;;AAvDe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAZ;;AAAA;AAAA;AAAA;AAAA,UAAP;AA0DD;AAED;AACF;AACA;AACA;AACA;;;;;iFACE,mBAAiB1F,IAAjB,EAAuBiC,QAAvB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,sBAGM,OAAOjC,IAAP,KAAgB,QAHtB;AAAA;AAAA;AAAA;;AAIIrC,gBAAAA,OAAO,GAAGqC,IAAV;AAJJ;AAAA;;AAAA;AAAA,sBAMW,QAAOA,IAAP,MAAgB,QAN3B;AAAA;AAAA;AAAA;;AAAA,sCAO8B,KAAKgE,YAAL,CAAkBhE,IAAlB,EAAwBiC,QAAxB,CAP9B,EAOYmB,aAPZ,uBAOYA,aAPZ;AASIzF,gBAAAA,OAAO,GAAGyF,aAAV;AATJ;AAAA;;AAAA;AAAA,sBAYU,IAAIjI,KAAJ,CAAU,iBAAV,CAZV;;AAAA;AAAA;AAAA,uBAe8B,KAAKC,aAAL,CAAmBuC,OAAnB,CAf9B;;AAAA;AAeQS,gBAAAA,QAfR;AAgBQ2G,gBAAAA,YAhBR,GAgBwB3G,QAAQ,IAAIA,QAAQ,CAAC0F,MAArB,IAA+B1F,QAAQ,CAAC4G,MAAT,CAAgB,UAACC,IAAD;AAAA,sBAASC,QAAT,UAASA,QAAT;AAAA,yBAAwBD,IAAI,GAAGC,QAA/B;AAAA,iBAAhB,EAAyD,CAAzD,CAA/B,IAA8F,CAhBtH;AAAA,mDAkBSH,YAlBT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AAqBA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;;;;;gGACE,mBAAgC/E,IAAhC,EAA2C6G,QAA3C,EAA8D5E,QAA9D;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;AACUuD,gBAAAA,YADV,GACuDxF,IADvD,CACUwF,YADV,EACwBpF,MADxB,GACuDJ,IADvD,CACwBI,MADxB,EACgC0G,kBADhC,GACuD9G,IADvD,CACgC8G,kBADhC;AAEQC,gBAAAA,WAFR,GAEuBD,kBAAD,GAAuBA,kBAAvB,GAA4C,KAAKnK,GAAL,CAASqE,QAAT,CAAkBC,IAAlB,CAAuBC,QAAvB,CAAgC,KAAKlF,OAArC,EAA8C6J,UAA9C,EAFlE;AAAA,sCAIoC,KAAK7B,YAAL,CAAkBwB,YAAlB,EAAgCvD,QAAhC,CAJpC,EAIU/B,MAJV,uBAIUA,MAJV,EAIkBkD,aAJlB,uBAIkBA,aAJlB;AAMQ2C,gBAAAA,EANR,GAMwB,IAAI,KAAKpJ,GAAL,CAASS,GAAT,CAAaC,OAAb,CAAqB2I,kBAAzB,CAA4C,KAAK1I,OAAjD,CANxB;AAAA;AAAA,uBAO8B,KAAKlC,aAAL,CAAmBgI,aAAnB,CAP9B;;AAAA;AAOQhF,gBAAAA,QAPR;AAAA;AAAA,uBAS8B,KAAKK,QAAL,CAAc;AAAEjB,kBAAAA,UAAU,EAAE,IAAd;AAAoBG,kBAAAA,OAAO,EAAEyF;AAA7B,iBAAd,CAT9B;;AAAA;AASQ6C,gBAAAA,UATR;AAUQlK,gBAAAA,QAVR,GAUwBkK,UAAU,CAACnB,YAAX,GAA0B9G,QAA1B,EAVxB;AAWQ+G,gBAAAA,YAXR,GAWwB3G,QAAQ,CAAC4G,MAAT,CAAgB,UAACC,IAAD;AAAA,sBAASC,QAAT,UAASA,QAAT;AAAA,yBAAwBD,IAAI,GAAGC,QAA/B;AAAA,iBAAhB,EAAyD,CAAzD,CAXxB;AAaE;;AAbF,sBAcM,OAAO,KAAKpJ,aAAZ,KAA8B,UAdpC;AAAA;AAAA;AAAA;;AAeIP,gBAAAA,OAAO,CAAC8H,GAAR,CAAY,oBAAZ;AAfJ;AAAA,uBAgB8B,KAAKvH,aAAL,CAAmBsH,aAAnB,CAhB9B;;AAAA;AAgBU4D,gBAAAA,WAhBV;;AAAA,sBAiBQA,WAAW,IACVA,WAAW,CAACrJ,OAAZ,CAAoBsJ,WAApB,MAAqCF,WAAW,CAACE,WAAZ,EAlB9C;AAAA;AAAA;AAAA;;AAAA,mDAqBa;AACLC,kBAAAA,IAAI,EAAEF,WAAW,CAACxK,IADb;AAEL2K,kBAAAA,iBAAiB,EAAE;AAFd,iBArBb;;AAAA;AAAA,qBA4BM,IAAIrM,SAAJ,CAAciK,YAAd,EAA4BpG,UAA5B,CAAuC5C,QAAvC,CA5BN;AAAA;AAAA;AAAA;;AAAA,sBA6BU,IAAIZ,KAAJ,gCAAkC4J,YAAlC,gBAAoDhJ,QAApD,EA7BV;;AAAA;AAgCE,oBAAI8K,QAAJ,EAAc;AACZd,kBAAAA,EAAE,CAACqB,WAAH,CAAe5B,YAAY,CAAC/C,QAA5B;AACD;;AAEDrE,gBAAAA,QAAQ,CAAC+H,OAAT,CAAiB,UAAC5J,OAAD,EAAa;AAAA,8CACL,MAAI,CAACD,cAAL,CAAoBC,OAApB,CADK;AAAA,sBACpBC,IADoB,yBACpBA,IADoB;AAAA,sBACdC,IADc,yBACdA,IADc;;AAE5BsJ,kBAAAA,EAAE,CAACK,QAAH,CAAY5J,IAAZ,EAAkBC,IAAlB,EAAwB,UAAxB;AACD,iBAHD;AAIAsJ,gBAAAA,EAAE,CAACM,SAAH,CAAaU,WAAb,EAA0BhC,YAAY,GAAGhJ,QAAzC;AAEMoE,gBAAAA,KA1CR,GA0CgB4F,EAAE,CAACQ,eAAH,EA1ChB;;AA4CER,gBAAAA,EAAE,CAACO,QAAH,CAAY7G,GAAZ,CAAgB,UAAC4H,CAAD,EAAIxH,KAAJ;AAAA,yBACd,MAAI,CAACyH,gBAAL,CAAsB;AACpBpH,oBAAAA,MAAM,EAANA,MADoB;AAEpBE,oBAAAA,MAAM,EAANA,MAFoB;AAGpBD,oBAAAA,KAAK,EAALA;AAHoB,mBAAtB,EAIGN,KAJH,CADc;AAAA,iBAAhB;;AAQM0H,gBAAAA,KApDR,GAoDgBpH,KAAK,CAACsG,KAAN,EApDhB;AAqDQS,gBAAAA,IArDR,GAqDe/G,KAAK,CAACqG,KAAN,EArDf;AAAA,mDAuDS;AACLe,kBAAAA,KAAK,EAALA,KADK;AAELL,kBAAAA,IAAI,EAAJA;AAFK,iBAvDT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AA8DA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;;;;;gGACE,mBAAgClH,IAAhC,EAAsC6G,QAAtC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBACsB,KAAKW,yBAAL,CAA+BxH,IAA/B,EAAqC6G,QAArC,CADtB;;AAAA;AACQ1G,gBAAAA,KADR;AAAA,mDAGSA,KAAK,CAACoH,KAHf;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AAMA;AACF;AACA;AACA;AACA;AACA;AACA;;;;WACE,iCAAwBvH,IAAxB,EAA8B;AAC5B,aAAO,KAAKwH,yBAAL,CAA+BxH,IAA/B,EAAqC,IAArC,CAAP;AACD;;;;qFAED;AAAA;;AAAA;AAAA;AAAA;AAAA;AACEyH,gBAAAA,IADF,UACEA,IADF;AAKQC,gBAAAA,SALR,GAKoB,IALpB;AAMQC,gBAAAA,IANR,GAMe,KAAKjM,SAAL,CAAeuL,WAAf,EANf;;AAQQW,gBAAAA,iBARR,GAQ4B,SAApBA,iBAAoB,CAACC,IAAD,EAAU;AAAA,oCAI9BJ,IAAI,CAACK,KAJyB;AAAA,sBAEGC,6BAFH,eAEhCC,iCAFgC;AAAA,sBAGdxC,YAHc,eAGhCyC,gBAHgC;;AAMlC,sBAAIF,6BAAJ,EAAmC;AACjC;AACD;;AAEDN,kBAAAA,IAAI,CAACS,QAAL,CAAc;AACZF,oBAAAA,iCAAiC,EAAEH;AADvB,mBAAd;AAIAJ,kBAAAA,IAAI,CAACU,IAAL,CAAUC,IAAV,CAAeC,IAAf,wBAA2C,YAAM;AAC/CZ,oBAAAA,IAAI,CAACU,IAAL,CAAUC,IAAV,CAAeE,WAAf,CAA2B;AACzBC,sBAAAA,KAAK,sBADoB;AAEzBvI,sBAAAA,IAAI,EAAE;AACJwF,wBAAAA,YAAY,EAAZA,YADI;AAEJwC,wBAAAA,iCAAiC,EAAEH;AAF/B;AAFmB,qBAA3B;AAOD,mBARD;AAUAJ,kBAAAA,IAAI,CAACU,IAAL,CAAUC,IAAV,CAAeE,WAAf,CAA2B;AACzBC,oBAAAA,KAAK,sBADoB;AAEzBvI,oBAAAA,IAAI,EAAE;AACJwF,sBAAAA,YAAY,EAAZA,YADI;AAEJwC,sBAAAA,iCAAiC,EAAEH;AAF/B;AAFmB,mBAA3B;AAOD,iBAvCH;;AA2CMW,gBAAAA,UA3CN,GAiDMf,IAjDN,CA0CIU,IA1CJ,CA2CMK,UA3CN,iBAiDMf,IAjDN,CA6CIK,KA7CJ,EA8CMW,eA9CN,gBA8CMA,eA9CN,EA+CwBjD,YA/CxB,gBA+CMyC,gBA/CN;;AAAA,qBAmDMQ,eAnDN;AAAA;AAAA;AAAA;;AAoDUC,gBAAAA,gBApDV;AAAA,wFAoD6B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mCAEfhB,SAAS,CAACiB,UAAV,CAAqB;AACzBnD,8BAAAA,YAAY,EAAZA,YADyB;AAEzBC,8BAAAA,MAAM,EAAE+C;AAFiB,6BAArB,CAFe;;AAAA;AAAA,+DAMd,IANc;;AAAA;AAAA;AAAA;;AAAA,kCAQjB,kBAAQ,uBARS;AAAA;AAAA;AAAA;;AASnBjN,4BAAAA,OAAO,CAACC,IAAR,CAAa,uBAAb;AATmB,+DAUZ,IAVY;;AAAA;AAAA,kCAYf,kBAAQ,UAZO;AAAA;AAAA;AAAA;;AAajB;AACAD,4BAAAA,OAAO,CAACC,IAAR,CAAa,iEAAb;AACAiM,4BAAAA,IAAI,CAACU,IAAL,CAAUC,IAAV,CAAeE,WAAf,CAA2B;AACzBC,8BAAAA,KAAK,EAAE,kBADkB;AAEzBvI,8BAAAA,IAAI,EAAE;AAFmB,6BAA3B;AAIAyH,4BAAAA,IAAI,CAACS,QAAL,CAAc;AACZU,8BAAAA,cAAc,EAAE;AADJ,6BAAd;AAnBiB;AAAA,mCAsBX/N,IAAI,CAAC6J,OAAL,CAAaC,SAAb,CAAuB,EAAvB,CAtBW;;AAAA;AAAA,+DAuBV,KAvBU;;AAAA;AAyBjBpJ,4BAAAA,OAAO,CAAC8H,GAAR,CAAY,kBAAZ;;AAzBiB;AAAA,+DA6BhB,IA7BgB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBApD7B;;AAAA,kCAoDUqF,gBApDV;AAAA;AAAA;AAAA;;AAAA;AAAA,uBAoFU7N,IAAI,CAAC6J,OAAL,CAAamE,sBAAb;AAAA,wFAAoC,mBAAOC,UAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAChCC,4BAAAA,aADgC,GACdtB,IAAI,CAACK,KADS,CAChCiB,aADgC;;AAAA,gCAGnCA,aAHmC;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAIzBL,gBAAgB,EAJS;;AAAA;AAAA;;AAAA;AAMtCI,4BAAAA,UAAU;;AAN4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAApC;;AAAA;AAAA;AAAA;AAAA,oBApFV;;AAAA;AA+FQE,gBAAAA,kBA/FR;AAAA,wFA+F6B;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,oDACCtB,SAAS,CAAC1D,YAAV,CAAuBwB,YAAvB,CADD,EACjBpC,aADiB,yBACjBA,aADiB;AAAA;AAAA,mCAEFsE,SAAS,CAACtM,aAAV,CAAwBgI,aAAxB,CAFE;;AAAA;AAEnBhF,4BAAAA,QAFmB;;AAAA,kCAIrBA,QAAQ,CAAC0F,MAAT,KAAoB,CAJC;AAAA;AAAA;AAAA;;AAAA,+DAKhB,KALgB;;AAAA;AAQnB+D,4BAAAA,IARmB,GAQZzJ,QAAQ,CAAC,CAAD,CAAR,CAAY5B,IARA;AAAA;AAAA,mCAUHkL,SAAS,CAACuB,UAAV,CAAqBzD,YAArB,CAVG;;AAAA;AAUnB0D,4BAAAA,OAVmB;AAYnBC,4BAAAA,aAZmB,GAYH,IAAIrO,SAAJ,CAAcoO,OAAd,EAAuB/J,sBAAvB,CAA8CqJ,UAAU,CAACY,KAAX,CAAiB,GAAjB,CAA9C,CAZG;;AAczB,gCAAID,aAAJ,EAAmB;AACjB1B,8BAAAA,IAAI,CAACS,QAAL,CAAc;AACZvC,gCAAAA,aAAa,EAAE,IAAI7K,SAAJ,CAAcoO,OAAd,EAAuBG,GAAvB,CAA2B,GAA3B,EAAgCnL,EAAhC,CAAmC,CAAnC;AADH,+BAAd;AAIA0J,8BAAAA,iBAAiB,CAACC,IAAD,CAAjB;AACD;;AApBwB,+DAsBlBsB,aAtBkB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBA/F7B;;AAAA,kCA+FQH,kBA/FR;AAAA;AAAA;AAAA;;AAAA;AAAA,uBAwHQnO,IAAI,CAAC6J,OAAL,CAAamE,sBAAb;AAAA,wFAAoC,mBAAOC,UAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAChCC,4BAAAA,aADgC,GACdtB,IAAI,CAACK,KADS,CAChCiB,aADgC;;AAAA,gCAGnCA,aAHmC;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAIzBC,kBAAkB,EAJO;;AAAA;AAAA;;AAAA;AAMtCF,4BAAAA,UAAU;;AAN4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAApC;;AAAA;AAAA;AAAA;AAAA,oBAxHR;;AAAA;AAkIUC,gBAAAA,aAlIV,GAkI4BtB,IAAI,CAACK,KAlIjC,CAkIUiB,aAlIV;;AAoIE,oBAAI,CAACA,aAAL,EAAoB;AAClBtB,kBAAAA,IAAI,CAAC6B,UAAL,uEACQ3B,IADR,oBAC8B,IAD9B,2DAEsB,IAFtB,sBAGG;AAAE4B,oBAAAA,IAAI;AAAN,mBAHH;AAID;;AAzIH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AA4IA;AACF;AACA;AACA;AACA;AACA;AACA;;;;;8FACE,mBAA8BvJ,IAA9B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBACsB,KAAKwJ,uBAAL,CAA6BxJ,IAA7B,CADtB;;AAAA;AACQG,gBAAAA,KADR;AAAA,mDAGSA,KAAK,CAACoH,KAHf;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AAMA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACE,kBAASvH,IAAT,EAA8E;AAAA;;AAAA,UAA/D6G,QAA+D,uEAA3C,KAA2C;AAAA,UAApC5E,QAAoC;AAC5E,aAAO,IAAI1C,OAAJ;AAAA,8EAAY,mBAAOO,OAAP,EAAgB4F,MAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEfnK,kBAAAA,OAAO,CAAC8H,GAAR,CAAY,UAAZ;AAFe;AAAA,yBAGK,MAAI,CAACmE,yBAAL,CAA+BxH,IAA/B,EAAqC6G,QAArC,EAA+C5E,QAA/C,CAHL;;AAAA;AAGT9B,kBAAAA,KAHS;;AAAA,uBAKXA,KAAK,CAACgH,iBALK;AAAA;AAAA;AAAA;;AAMbrH,kBAAAA,OAAO,CAACK,KAAK,CAAC+G,IAAP,CAAP;AANa;;AAAA;AAUfxM,kBAAAA,KAAK,CAAC,iBAAD,CAAL,CAAyB,iBAAzB,EAA4CyF,KAAK,CAACoH,KAAlD;AAEAhM,kBAAAA,OAAO,CAAC8H,GAAR,CAAY,WAAZ;AAZe;AAAA,yBAaM,MAAI,CAAChI,WAAL,CAAiB8E,KAAK,CAACoH,KAAvB,CAbN;;AAAA;AAaTZ,kBAAAA,MAbS;AAefpL,kBAAAA,OAAO,CAAC8H,GAAR,CAAY,iBAAZ,EAA+BsD,MAA/B,EAfe,CAiBf;;AAjBe;AAAA,yBAkBT9L,IAAI,CAAC6J,OAAL,CAAaC,SAAb,CAAuB,EAAvB,CAlBS;;AAAA;AAAA;AAAA,yBAoBS,MAAI,CAAC8E,OAAL,CAAatJ,KAAK,CAAC+G,IAAnB,CApBT;;AAAA;AAoBTwC,kBAAAA,SApBS;;AAsBf,sBAAIA,SAAJ,EAAe;AACb5J,oBAAAA,OAAO,CAACK,KAAK,CAAC+G,IAAP,CAAP;AACD,mBAFD,MAEO;AACL3L,oBAAAA,OAAO,CAACC,IAAR,CAAa,wBAAb,EAAuC,wBAAvC;AACAkK,oBAAAA,MAAM,CAAC,iCAAiCvF,KAAK,CAAC+G,IAAxC,CAAN;AACD;;AA3Bc;AAAA;;AAAA;AAAA;AAAA;AA8Bf3L,kBAAAA,OAAO,CAACC,IAAR,CAAa,wBAAb,EAAuC,cAAM8D,OAA7C;;AAIA,sBAAI,cAAMqK,GAAN,IAAa,YAAY1M,IAAZ,CAAiB,cAAM0M,GAAN,CAAUC,IAA3B,CAAjB,EAAmD;AACjDC,oBAAAA,YAAY,GAAG,cAAf;AACD,mBAFD,MAEO,IAAI,sBAAsB5M,IAAtB,CAA2B,cAAMqC,OAAjC,CAAJ,EAA+C;AACpD,wBAAI,yBAAyBrC,IAAzB,CAA8B,cAAMqC,OAApC,CAAJ,EAAkD;AAChDuK,sBAAAA,YAAY,GAAG,kBAAf;AACD,qBAFD,MAEO;AACLA,sBAAAA,YAAY,GAAG,eAAf;AACD;AACF,mBANM,MAMA;AACLA,oBAAAA,YAAY,gBAAZ;AACD;;AAEDnE,kBAAAA,MAAM,CAACmE,YAAD,CAAN;;AA9Ce;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAZ;;AAAA;AAAA;AAAA;AAAA,UAAP;AAiDD;AAED;AACF;AACA;AACA;AACA;;;;;8EACE,mBAAchC,IAAd;AAAA;AAAA;AAAA;AAAA;AAAA;AACEtM,gBAAAA,OAAO,CAAC8H,GAAR,CAAY,UAAZ;AADF;AAAA,uBAEuB,KAAK/H,WAAL,CAAiBuM,IAAjB,CAFvB;;AAAA;AAEQiC,gBAAAA,MAFR;AAGEvO,gBAAAA,OAAO,CAAC8H,GAAR,CAAY,QAAZ,EAAsByG,MAAtB;;AAHF,sBAIMA,MAAM,IACLA,MAAM,CAACjL,aADR,IAECiL,MAAM,CAACtN,IAFR,IAGEsN,MAAM,CAACtN,IAAP,CAAYyK,WAAZ,MAA6BY,IAAI,CAACZ,WAAL,EAPrC;AAAA;AAAA;AAAA;;AAAA,mDASW,IATX;;AAAA;AAAA,mDAWS,KAXT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;AAaA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACE,gBAAOjH,IAAP,EAAkBiC,QAAlB,EAAqC;AACnC,aAAO,KAAK8H,QAAL,CAAc/J,IAAd,EAAoB,IAApB,EAA0BiC,QAA1B,CAAP;AACD;;;;uFAGD;AAAA;AAAA;AAAA;AAAA;AAAA;AACEwF,gBAAAA,IADF,UACEA,IADF;AAKQC,gBAAAA,SALR,GAKoB,IALpB;AAMQC,gBAAAA,IANR,GAMe,KAAKjM,SAAL,CAAeuL,WAAf,EANf;AAAA;AAAA,uBAQQpM,IAAI,CAAC6J,OAAL,CAAamE,sBAAb,CAAoC,UAACC,UAAD,EAAgB;AAAA,qCAKpDrB,IAAI,CAACK,KAL+C;AAAA,sBAEtD1H,MAFsD,gBAEtDA,MAFsD;AAAA,sBAGpCoF,YAHoC,gBAGtDyC,gBAHsD;AAAA,sBAId+B,2BAJc,0BAIlDrC,IAJkD;;AAOxD,sBAAIqC,2BAAJ,EAAiC;AAC/B,2BAAO,IAAP;AACD;;AAED,sBAAI,CAACxE,YAAL,EAAmB;AACjBjK,oBAAAA,OAAO,CAAC8D,KAAR;AACA,2BAAO,IAAP;AACD;;AAED,yBAAOoI,IAAI,CAACwC,OAAL,CAAaF,QAAb,CAAsB;AAC3BvE,oBAAAA,YAAY,EAAZA,YAD2B;AAE3BpF,oBAAAA,MAAM,EAANA,MAF2B;AAG3B0G,oBAAAA,kBAAkB,EAAEW,IAAI,CAACU,IAAL,CAAU+B;AAHH,mBAAtB,EAKJxD,IALI,CAKC,UAACyD,IAAD,EAAU;AACd5O,oBAAAA,OAAO,CAAC8H,GAAR,CAAY,eAAZ,EAA6B8G,IAA7B;AACA1C,oBAAAA,IAAI,CAACS,QAAL,+BACMP,IADN,kCAC0CwC,IAD1C,GAEG,IAFH;AAGA,2BAAO,IAAP;AACD,mBAXI,WAYE,UAAC9K,KAAD;AAAA,2BAAW,IAAX;AAAA,mBAZF,CAAP;AAaD,iBA7BK,CARR;;AAAA;AAuCEoI,gBAAAA,IAAI,CAAC6B,UAAL,iCACQ3B,IADR,gBAC0B,IAD1B,GAEG;AAAE4B,kBAAAA,IAAI;AAAN,iBAFH;;AAvCF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;;;;EAj3B2B5O,a;;AA+5B7B,eAAeI,cAAf","sourcesContent":["import debug from 'debug'\r\nimport SwapApp, { SwapInterface, constants, util } from 'swap.app'\r\nimport BigNumber from 'bignumber.js'\r\nimport { Flow } from 'swap.swap'\r\n\r\n\r\nclass UTXOBlockchain extends SwapInterface {\r\n\r\n  _swapName: string = null\r\n  fetchBalance: Function = undefined\r\n  fetchUnspents: Function = undefined\r\n  broadcastTx: Function = undefined\r\n  checkWithdraw: Function = undefined\r\n  feeValue: number = 546\r\n  fetchTxInfo: Function = undefined\r\n  estimateFeeValue: Function = undefined\r\n\r\n  account: string = undefined\r\n  networks: any = undefined\r\n  network: any = undefined\r\n\r\n  skipFetchConfidence: boolean = false\r\n  skipCheckCanBeReplaces: boolean = false\r\n  skipLockTime: boolean = false\r\n  skipRecipientPublickKey: boolean = false\r\n\r\n  processUnspent: Function = undefined\r\n  sendTransaction: Function\r\n\r\n  app: SwapApp = undefined\r\n  /**\r\n   *\r\n   * @param options\r\n   * @param options.fetchBalance\r\n   * @param options.fetchUnspents\r\n   * @param options.broadcastTx\r\n   * @param options.fetchTxInfo {(tx_hash) => Promise({ confidence, fees })}\r\n   * @param options.estimateFeeValue { ({ inSatoshis, speed, address, txSize }) => Promise(fee_value) }\r\n   */\r\n  constructor(options) {\r\n    super()\r\n\r\n    if (typeof options.fetchBalance !== 'function') {\r\n      throw new Error('BtcSwap: \"fetchBalance\" required')\r\n    }\r\n    if (typeof options.fetchUnspents !== 'function') {\r\n      throw new Error('BtcSwap: \"fetchUnspents\" required')\r\n    }\r\n    if (typeof options.broadcastTx !== 'function') {\r\n      throw new Error('BtcSwap: \"broadcastTx\" required')\r\n    }\r\n    if (typeof options.fetchTxInfo !== 'function') {\r\n      // tx_hash => { confidence, fees }\r\n      console.warn(`BtcSwap: \"fetchTxInfo\" is not a function. You will not be able to use tx-confidence feature`)\r\n    }\r\n    if (typeof options.estimateFeeValue !== 'function') {\r\n      // ({ speed } = {}) => feeRate\r\n      console.warn(`BtcSwap: \"estimateFeeValue\" is not a function. You will not be able use automatic mempool-based fee`)\r\n    }\r\n\r\n    this._swapName      = options.swapName || constants.COINS.btc\r\n    this.fetchBalance   = options.fetchBalance\r\n    this.fetchUnspents  = options.fetchUnspents\r\n    this.broadcastTx    = options.broadcastTx\r\n    this.checkWithdraw  = options.checkWithdraw\r\n    this.feeValue       = options.feeValue || 546\r\n    this.fetchTxInfo    = options.fetchTxInfo || (() => {})\r\n    this.estimateFeeValue = options.estimateFeeValue || (() => 0)\r\n\r\n    this.account        = options.account || `btc`\r\n    this.networks       = options.networks\r\n\r\n    this.skipFetchConfidence = options.skipFetchConfidence || false\r\n    this.skipCheckCanBeReplaces = options.skipCheckCanBeReplaces || false\r\n    this.skipLockTime = options.skipLockTime || false\r\n    this.skipRecipientPublickKey = options.skipRecipientPublickKey || false\r\n\r\n    this.processUnspent = options.processUnspent || (\r\n      (unspent) => {\r\n        const { txid, vout } = unspent\r\n        return { txid, vout }\r\n      }\r\n    )\r\n    this.sendTransaction = options.sendTransaction\r\n  }\r\n\r\n  _initSwap(app) {\r\n    super._initSwap(app)\r\n\r\n    this.app = app\r\n\r\n    /* init networks if need */\r\n    const {\r\n      main: {\r\n        name: mainName,\r\n        params: mainParams,\r\n      },\r\n      test: {\r\n        name: testName,\r\n        params: testParams,\r\n      },\r\n    } = this.networks\r\n\r\n    if (mainName && mainParams) this.app.env.bitcoin.networks[mainName] = mainParams\r\n    if (testName && testParams) this.app.env.bitcoin.networks[testName] = testParams\r\n\r\n    this.network = (\r\n      this.app.isMainNet()\r\n        ? this.app.env.bitcoin.networks[mainName]\r\n        : this.app.env.bitcoin.networks[testName]\r\n    )\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} options\r\n   * @param {boolean} options.inSatoshis\r\n   * @param {Number} options.size\r\n   * @param {String} options.speed\r\n   * @param {String} options.address\r\n   * @returns {BigNumber}\r\n   * @public\r\n   */\r\n  async getTxFee({\r\n    inSatoshis,\r\n    size,\r\n    speed = 'fast',\r\n    address,\r\n  }: {\r\n    inSatoshis: boolean,\r\n    size?: number,\r\n    speed?: 'slow' | 'medium' | 'fast'\r\n    address: string,\r\n  }) {\r\n\r\n\r\n    const estimatedFeeRaw = await this.estimateFeeValue({\r\n      inSatoshis: true,\r\n      address,\r\n      speed,\r\n      method: 'swap',\r\n      txSize: size,\r\n    })\r\n\r\n    const estimatedFee = new BigNumber(estimatedFeeRaw)\r\n    this.feeValue = estimatedFee.toNumber()\r\n\r\n    return inSatoshis\r\n      ? estimatedFee\r\n      : estimatedFee.dividedBy(1e8).dp(0, BigNumber.ROUND_UP)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {array} unspents\r\n   * @param {Number} expectedConfidenceLevel\r\n   * @returns {array}\r\n   * @private\r\n   */\r\n  async filterConfidentUnspents(unspents, expectedConfidenceLevel = 0.95) {\r\n\r\n    const feesToConfidence = async (fees, size, address) => {\r\n      fees = new BigNumber(fees).multipliedBy(1e8).toNumber()\r\n      const currentFastestFee = await this.getTxFee({ inSatoshis: true, size, speed: 'fast', address })\r\n\r\n      return new BigNumber(fees).isLessThan(currentFastestFee)\r\n        ? new BigNumber(fees).dividedBy(currentFastestFee).toNumber()\r\n        : 1\r\n    }\r\n\r\n    /* @ToDo -   */\r\n    const fetchConfidence = async (unspent): Promise<number> => {\r\n\r\n\r\n      if (this.skipFetchConfidence) return 1\r\n\r\n      const {\r\n        fees,\r\n        size,\r\n        senderAddress,\r\n        confirmations: txConfirms,\r\n      } = unspent\r\n\r\n      const confirmationsToConfidence = confs => confs > 0 ? 1 : 0\r\n      const confidenceFromConfirmations = confirmationsToConfidence(txConfirms)\r\n\r\n      if (new BigNumber(confidenceFromConfirmations).isGreaterThanOrEqualTo(expectedConfidenceLevel)) {\r\n        return confidenceFromConfirmations\r\n      }\r\n\r\n      try {\r\n        if (txConfirms > 0) {\r\n          return 1\r\n        }\r\n\r\n        if (fees) {\r\n          const confFromFee = await feesToConfidence(fees, size, senderAddress)\r\n          return confFromFee\r\n        }\r\n\r\n        throw new Error(`txinfo={confirmations: ${txConfirms}, fees: ${fees}, size: ${size}, senderAddress: ${senderAddress} }`)\r\n\r\n      } catch (err) {\r\n        console.error(`BtcSwap: Error fetching confidence: using confirmations > 0:`, err.message)\r\n\r\n        return confidenceFromConfirmations\r\n      }\r\n    }\r\n\r\n    const confidences: number[] = await Promise.all(unspents.map(fetchConfidence))\r\n\r\n    return unspents.filter((utxo, index) => {\r\n      debug('swap.core:swaps')(`confidence[${index}]:`, confidences[index])\r\n      return new BigNumber(confidences[index]).isGreaterThanOrEqualTo(expectedConfidenceLevel)\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {Array[object]} unspents\r\n   * @return {Array[object]}\r\n   */\r\n  async filterConfirmedUnspents(unspents): Promise<any[]> {\r\n    return new Promise(async (resolve) => {\r\n      const filtered = unspents.filter((unspent) => {\r\n        const {\r\n          confirmations,\r\n        } = unspent\r\n\r\n        if (confirmations > 0) {\r\n          return true\r\n        }\r\n      })\r\n      resolve(filtered)\r\n    })\r\n  }\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.script\r\n   * @param {*} data.txRaw\r\n   * @param {string} data.secret\r\n   * @param {number} inputIndex\r\n   * @private\r\n   */\r\n  _signTransaction(data, inputIndex = 0) {\r\n    debug('swap.core:swaps')('signing script input', inputIndex)\r\n    const {\r\n      script,\r\n      txRaw,\r\n      secret,\r\n    } = data\r\n\r\n    const scriptData = this.app.env.bitcoin.payments.p2sh({\r\n      redeem: {\r\n        output: script,\r\n        network: this.network,\r\n      },\r\n      network: this.network,\r\n    })\r\n\r\n    const hashType      = this.app.env.bitcoin.Transaction.SIGHASH_ALL\r\n    const privKey = this.app.env.bitcoin.ECPair.fromWIF(\r\n      this.app.services.auth.accounts[this.account].getPrivateKey(),\r\n      this.network\r\n    )\r\n\r\n    const signatureHash = txRaw.hashForSignature(inputIndex, scriptData.redeem.output, hashType)\r\n\r\n    const redeemScriptSig = this.app.env.bitcoin.payments.p2sh({ \r\n      network: this.network, \r\n      redeem: { \r\n        network: this.network, \r\n        output: scriptData.redeem.output, \r\n        input: this.app.env.bitcoin.script.compile([ \r\n          this.app.env.bitcoin.script.signature.encode(privKey.sign(signatureHash), hashType),\r\n          this.app.services.auth.accounts[this.account].getPublicKeyBuffer(),\r\n          Buffer.from(secret.replace(/^0x/, ''), 'hex'),\r\n        ]) \r\n      } \r\n    }).input \r\n\r\n    txRaw.setInputScript(inputIndex, redeemScriptSig)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @param {string} data.ownerPublicKey\r\n   * @param {string} data.recipientPublicKey\r\n   * @param {number} data.lockTime\r\n   * @returns {{scriptAddress: *, script: (*|{ignored})}}\r\n   */\r\n  createScript(data, hashName = 'ripemd160') {\r\n    const hashOpcodeName = `OP_${hashName.toUpperCase()}`\r\n    const hashOpcode = this.app.env.bitcoin.opcodes[hashOpcodeName]\r\n\r\n    const { secretHash, ownerPublicKey, recipientPublicKey, lockTime } = data\r\n\r\n    const script = this.app.env.bitcoin.script.compile([\r\n\r\n      this.app.env.bitcoin.opcodes.OP_SIZE,\r\n      Buffer.from('20' ,'hex'),\r\n      this.app.env.bitcoin.opcodes.OP_EQUALVERIFY,\r\n\r\n      hashOpcode,\r\n      Buffer.from(secretHash, 'hex'),\r\n      this.app.env.bitcoin.opcodes.OP_EQUALVERIFY,\r\n\r\n      Buffer.from(recipientPublicKey, 'hex'),\r\n      this.app.env.bitcoin.opcodes.OP_EQUAL,\r\n      this.app.env.bitcoin.opcodes.OP_IF,\r\n\r\n      Buffer.from(recipientPublicKey, 'hex'),\r\n\r\n      this.app.env.bitcoin.opcodes.OP_ELSE,\r\n\r\n      this.app.env.bitcoin.script.number.encode(lockTime),\r\n      this.app.env.bitcoin.opcodes.OP_CHECKLOCKTIMEVERIFY,\r\n      this.app.env.bitcoin.opcodes.OP_DROP,\r\n      Buffer.from(ownerPublicKey, 'hex'),\r\n\r\n      this.app.env.bitcoin.opcodes.OP_ENDIF,\r\n\r\n      this.app.env.bitcoin.opcodes.OP_CHECKSIG,\r\n    ])\r\n\r\n    const scriptData = this.app.env.bitcoin.payments.p2sh({\r\n      redeem: {\r\n        output: script,\r\n        network: this.network,\r\n      },\r\n      network: this.network,\r\n    })\r\n    const scriptAddress = scriptData.address\r\n\r\n    return {\r\n      scriptAddress,\r\n      script,\r\n    }\r\n  }\r\n\r\n  fetchUnspentsFullInfo(scriptAddress): Promise<any[]> {\r\n    console.log('fetchUnspentsFullInfo', scriptAddress)\r\n    return new Promise(async (resolve) => {\r\n      const unspents      = await this.fetchUnspents(scriptAddress)\r\n      const fetchFullUnspentInfo = async (unspent) => {\r\n        console.log('unspent', unspent)\r\n        try {\r\n          const info = await this.fetchTxInfo(unspent.txid)\r\n          return {\r\n            ...unspent,\r\n            ...info,\r\n          }\r\n        } catch (fetchTxInfoError) {\r\n          console.log('fetchTxInfo', fetchTxInfoError)\r\n          return false\r\n        }\r\n      }\r\n\r\n      const unspentsFullInfo = await Promise.all(unspents.map(fetchFullUnspentInfo))\r\n      resolve(unspentsFullInfo.filter((unspent) => unspent !== false ))\r\n    })\r\n  }\r\n\r\n  checkCanBeReplaces(unspents) {\r\n    if (this.skipCheckCanBeReplaces) return false\r\n    const notReplacedUnspents = unspents.filter((unspent) => {\r\n      const notReplacedInputs = unspent.inputs.filter((input) => {\r\n        return input.sequenceNumber.toString(16) === `ffffffff`\r\n      })\r\n      return notReplacedInputs.length === unspent.inputs.length\r\n    })\r\n    return !(notReplacedUnspents.length === unspents.length)\r\n  }\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.recipientPublicKey\r\n   * @param {number} data.lockTime\r\n   * @param {object} expected\r\n   * @param {number} expected.value\r\n   * @param {number} expected.lockTime\r\n   * @param {string} expected.recipientPublicKey\r\n   * @returns {Promise.<string>}\r\n   */\r\n  async checkScript(data, expected, hashName) {\r\n    const { recipientPublicKey, lockTime } = data\r\n    const { scriptAddress, script } = this.createScript(data, hashName)\r\n\r\n    const {\r\n      waitConfirm,\r\n      isWhiteList\r\n    } = expected\r\n\r\n    if (isWhiteList) {\r\n      console.log('is white listed - skip wait btc script')\r\n      return\r\n    }\r\n\r\n    const expectedConfidence = (expected.confidence !== undefined) ? expected.confidence : 0.95\r\n    console.log('script', scriptAddress)\r\n    const unspents: any[] = await this.fetchUnspentsFullInfo(scriptAddress)\r\n\r\n    console.log('script', scriptAddress)\r\n    console.log('unspents', unspents)\r\n    if (!unspents.length) return `No unspents. Wait`\r\n\r\n    \r\n    // Check - transaction can be replaced?\r\n    const canBeReplaced = this.checkCanBeReplaces(unspents)\r\n    if (canBeReplaced) {\r\n      console.warn(`Fund to script ${scriptAddress} can be replaced be fee. Wait confirm`)\r\n    }\r\n    if (waitConfirm || canBeReplaced) {\r\n      // Wait confirm only - for big amount of swap\r\n      if (!unspents.length) return `No unspents`\r\n      const confirmedUnspents: any[] = await this.filterConfirmedUnspents(unspents)\r\n      if (unspents.length === confirmedUnspents.length) return\r\n      await util.helpers.waitDelay(30)\r\n      if (canBeReplaced) return `Can be replace by fee. Wait confirm`\r\n      return `Wait confirm tx`\r\n    }\r\n\r\n    const expectedValue = expected.value.multipliedBy(1e8).integerValue()\r\n    const totalUnspent  = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n\r\n    const confidentUnspents = await this.filterConfidentUnspents(unspents, expectedConfidence)\r\n\r\n    const totalConfidentUnspent = confidentUnspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n\r\n    if (expectedValue.isGreaterThan(totalUnspent)) {\r\n      return `Expected script value: ${expectedValue.toNumber()}, got: ${totalUnspent}, address: ${scriptAddress}`\r\n    }\r\n    if (!this.skipLockTime && expected.lockTime > lockTime) {\r\n      return `Expected script lockTime: ${expected.lockTime}, got: ${lockTime}, address: ${scriptAddress}`\r\n    }\r\n    if (!this.skipRecipientPublickKey && expected.recipientPublicKey !== recipientPublicKey) {\r\n      return `Expected script recipient publicKey: ${expected.recipientPublicKey}, got: ${recipientPublicKey}`\r\n    }\r\n    if (expectedValue.isGreaterThan(totalConfidentUnspent)) {\r\n      return `Expected script value: ${expectedValue.toString()} with confidence above ${expectedConfidence}, got: ${totalConfidentUnspent}, address: ${scriptAddress}`\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {BigNumber} data.amount\r\n   * @param {function} handleTransactionHash\r\n   * @param {string} hashName\r\n   * @returns {Promise}\r\n   */\r\n  fundScript(data, handleTransactionHash?: Function, hashName?: string) {\r\n    const { scriptValues, amount } = data\r\n\r\n    console.log('fundScript', data)\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        const { scriptAddress } = this.createScript(scriptValues, hashName)\r\n\r\n        console.log('scriptAddress', scriptAddress)\r\n        const scriptBalance = await this.fetchBalance(scriptAddress)\r\n        if (new BigNumber(scriptBalance).isGreaterThan(0)) {\r\n          // Script already funded - skip double payments\r\n          reject('Script funded already')\r\n          return\r\n        }\r\n\r\n        const ownerAddress = this.app.services.auth.accounts[this.account].getAddress()\r\n\r\n        const fundValue     = amount.multipliedBy(1e8).integerValue().toNumber()\r\n        const tx            = new this.app.env.bitcoin.TransactionBuilder(this.network)\r\n        const unspents      = await this.fetchUnspents(ownerAddress)\r\n        const feeValueBN    = await this.getTxFee({ inSatoshis: true, address: ownerAddress })\r\n        const feeValue      = feeValueBN.integerValue().toNumber()\r\n        const totalUnspent  = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n        const skipValue     = totalUnspent - fundValue - feeValue\r\n\r\n        if (totalUnspent < feeValue + fundValue) {\r\n          throw new Error(`Total less than fee: ${totalUnspent} < ${feeValue} + ${fundValue}`)\r\n        }\r\n\r\n        unspents.forEach((unspent) => {\r\n          const { txid, vout } = this.processUnspent(unspent)\r\n          tx.addInput(txid, vout, 0xffffffff)\r\n        })\r\n        tx.addOutput(scriptAddress, fundValue)\r\n        tx.addOutput(this.app.services.auth.accounts[this.account].getAddress(), skipValue)\r\n\r\n        const privKey = this.app.env.bitcoin.ECPair.fromWIF(\r\n          this.app.services.auth.accounts[this.account].getPrivateKey(),\r\n          this.network\r\n        )\r\n\r\n        tx.__INPUTS.forEach((input, index) => {\r\n          tx.sign(index, privKey)\r\n        })\r\n\r\n        const txRaw = tx.buildIncomplete()\r\n\r\n        if (typeof handleTransactionHash === 'function') {\r\n          handleTransactionHash(txRaw.getId())\r\n        }\r\n\r\n        this.broadcastTx(txRaw.toHex()).then((result) => {\r\n          resolve(result)\r\n        }).catch ((err) => {\r\n          reject(err)\r\n        })\r\n      }\r\n      catch (err) {\r\n        reject(err)\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object|string} data - scriptValues or wallet address\r\n   * @returns {Promise.<void>}\r\n   */\r\n  async getBalance(data, hashName?: string): Promise<number> {\r\n    let address\r\n\r\n    if (typeof data === 'string') {\r\n      address = data\r\n    }\r\n    else if (typeof data === 'object') {\r\n      const { scriptAddress } = this.createScript(data, hashName)\r\n\r\n      address = scriptAddress\r\n    }\r\n    else {\r\n      throw new Error('Wrong data type')\r\n    }\r\n\r\n    const unspents      = await this.fetchUnspents(address)\r\n    const totalUnspent  = unspents && unspents.length && unspents.reduce((summ, { satoshis }) => summ + satoshis, 0) || 0\r\n\r\n    return totalUnspent\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @param {boolean} isRefund\r\n   * @returns {Promise}\r\n   */\r\n  async getWithdrawRawTransaction(data: any, isRefund: boolean, hashName?: string) {\r\n    const { scriptValues, secret, destinationAddress } = data\r\n    const destAddress = (destinationAddress) ? destinationAddress : this.app.services.auth.accounts[this.account].getAddress()\r\n\r\n    const { script, scriptAddress } = this.createScript(scriptValues, hashName)\r\n\r\n    const tx            = new this.app.env.bitcoin.TransactionBuilder(this.network)\r\n    const unspents      = await this.fetchUnspents(scriptAddress)\r\n\r\n    const feeValueBN    = await this.getTxFee({ inSatoshis: true, address: scriptAddress })\r\n    const feeValue      = feeValueBN.integerValue().toNumber()\r\n    const totalUnspent  = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n\r\n    /* Check - may be withdrawed */\r\n    if (typeof this.checkWithdraw === 'function') {\r\n      console.log('try check withdraw')\r\n      const hasWithdraw = await this.checkWithdraw(scriptAddress)\r\n      if (hasWithdraw\r\n        && hasWithdraw.address.toLowerCase() == destAddress.toLowerCase()\r\n      ) {\r\n        // already withdrawed\r\n        return {\r\n          txId: hasWithdraw.txid,\r\n          alreadyWithdrawed: true\r\n        }\r\n      }\r\n    }\r\n\r\n    if (new BigNumber(totalUnspent).isLessThan(feeValue)) {\r\n      throw new Error(`Total less than fee: ${totalUnspent} < ${feeValue}`)\r\n    }\r\n\r\n    if (isRefund) {\r\n      tx.setLockTime(scriptValues.lockTime)\r\n    }\r\n\r\n    unspents.forEach((unspent) => {\r\n      const { txid, vout } = this.processUnspent(unspent)\r\n      tx.addInput(txid, vout, 0xfffffffe)\r\n    })\r\n    tx.addOutput(destAddress, totalUnspent - feeValue)\r\n\r\n    const txRaw = tx.buildIncomplete()\r\n\r\n    tx.__INPUTS.map((_, index) =>\r\n      this._signTransaction({\r\n        script,\r\n        secret,\r\n        txRaw,\r\n      }, index)\r\n    )\r\n\r\n    const txHex = txRaw.toHex()\r\n    const txId = txRaw.getId()\r\n\r\n    return {\r\n      txHex,\r\n      txId,\r\n    }\r\n    return txRaw\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @param {boolean} isRefund\r\n   * @returns {Promise}\r\n   */\r\n  async getWithdrawHexTransaction(data, isRefund) {\r\n    const txRaw = await this.getWithdrawRawTransaction(data, isRefund)\r\n\r\n    return txRaw.txHex\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @returns {Promise}\r\n   */\r\n  getRefundRawTransaction(data) {\r\n    return this.getWithdrawRawTransaction(data, true)\r\n  }\r\n\r\n  async fundSwapScript({\r\n    flow,\r\n  }: {\r\n    flow: any, // Flow, @todo - add all fields\r\n  }) {\r\n    const utxoClass = this\r\n    const coin = this._swapName.toLowerCase()\r\n\r\n    const onTransactionHash = (txID) => {\r\n      const {\r\n        utxoScriptCreatingTransactionHash: scriptCreatingTransactionHash,\r\n        utxoScriptValues: scriptValues,\r\n      } = flow.state\r\n\r\n      if (scriptCreatingTransactionHash) {\r\n        return\r\n      }\r\n\r\n      flow.setState({\r\n        utxoScriptCreatingTransactionHash: txID,\r\n      })\r\n\r\n      flow.swap.room.once(`request utxo script`, () => {\r\n        flow.swap.room.sendMessage({\r\n          event: `create utxo script`,\r\n          data: {\r\n            scriptValues,\r\n            utxoScriptCreatingTransactionHash: txID,\r\n          }\r\n        })\r\n      })\r\n\r\n      flow.swap.room.sendMessage({\r\n        event: `create utxo script`,\r\n        data: {\r\n          scriptValues,\r\n          utxoScriptCreatingTransactionHash: txID,\r\n        }\r\n      })\r\n    }\r\n\r\n    const {\r\n      swap: {\r\n        sellAmount,\r\n      },\r\n      state: {\r\n        isBalanceEnough,\r\n        utxoScriptValues: scriptValues,\r\n      },\r\n    } = flow\r\n\r\n    if (isBalanceEnough) {\r\n      const fundScriptRepeat = async () => {\r\n        try {\r\n          await utxoClass.fundScript({\r\n            scriptValues,\r\n            amount: sellAmount,\r\n          })\r\n          return true\r\n        } catch (err) {\r\n          if (err === 'Script funded already') {\r\n            console.warn('Script already funded')\r\n            return true\r\n          } else {\r\n            if (err === 'Conflict') {\r\n              // @ToDo - its can be not btc, other UTXO, but, with btc its frequent error\r\n              console.warn('UTXO(BTC) locked. Has not confirmed tx in mempool. Wait confirm')\r\n              flow.swap.room.sendMessage({\r\n                event: 'wait utxo unlock',\r\n                data: {},\r\n              })\r\n              flow.setState({\r\n                waitUnlockUTXO: true,\r\n              })\r\n              await util.helpers.waitDelay(30)\r\n              return false\r\n            } else {\r\n              console.log('Fail fund script', err)\r\n            }\r\n          }\r\n        }\r\n        return true\r\n      }\r\n\r\n      await util.helpers.repeatAsyncUntilResult(async (stopRepeat) => {\r\n        const { isStoppedSwap } = flow.state\r\n\r\n        if (!isStoppedSwap) {\r\n          return await fundScriptRepeat()\r\n        } else {\r\n          stopRepeat()\r\n        }\r\n      })\r\n    }\r\n\r\n    const checkScriptBalance = async () => {\r\n      const { scriptAddress } = utxoClass.createScript(scriptValues)\r\n      const unspents = await utxoClass.fetchUnspents(scriptAddress)\r\n\r\n      if (unspents.length === 0) {\r\n        return false\r\n      }\r\n\r\n      const txID = unspents[0].txid\r\n\r\n      const balance = await utxoClass.getBalance(scriptValues)\r\n\r\n      const isEnoughMoney = new BigNumber(balance).isGreaterThanOrEqualTo(sellAmount.times(1e8))\r\n\r\n      if (isEnoughMoney) {\r\n        flow.setState({\r\n          scriptBalance: new BigNumber(balance).div(1e8).dp(8),\r\n        })\r\n\r\n        onTransactionHash(txID)\r\n      }\r\n\r\n      return isEnoughMoney\r\n    }\r\n\r\n    await util.helpers.repeatAsyncUntilResult(async (stopRepeat) => {\r\n      const { isStoppedSwap } = flow.state\r\n\r\n      if (!isStoppedSwap) {\r\n        return await checkScriptBalance()\r\n      } else {\r\n        stopRepeat()\r\n      }\r\n    })\r\n\r\n    const { isStoppedSwap } = flow.state\r\n\r\n    if (!isStoppedSwap) {\r\n      flow.finishStep({\r\n        [`is${coin}ScriptFunded}`]: true,\r\n        isUTXOScriptFunded: true,\r\n      }, { step: `lock-utxo` })\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @returns {Promise}\r\n   */\r\n  async getRefundHexTransaction(data) {\r\n    const txRaw = await this.getRefundRawTransaction(data)\r\n\r\n    return txRaw.txHex\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @param {function} handleTransactionHash\r\n   * @param {boolean} isRefund\r\n   * @param {string} hashName\r\n   * @returns {Promise}\r\n   */\r\n  withdraw(data, isRefund: boolean = false, hashName?: string): Promise<string> {\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        console.log('withdraw')\r\n        const txRaw = await this.getWithdrawRawTransaction(data, isRefund, hashName)\r\n\r\n        if (txRaw.alreadyWithdrawed) {\r\n          resolve(txRaw.txId)\r\n          return\r\n        }\r\n\r\n        debug('swap.core:swaps')('raw tx withdraw', txRaw.txHex)\r\n\r\n        console.log('broadcast')\r\n        const result = await this.broadcastTx(txRaw.txHex)\r\n\r\n        console.log('broadcast ready', result)\r\n\r\n        // Wait some delay until transaction can be rejected or broadcast failed\r\n        await util.helpers.waitDelay(10)\r\n\r\n        const txSuccess = await this.checkTX(txRaw.txId)\r\n\r\n        if (txSuccess) {\r\n          resolve(txRaw.txId)\r\n        } else {\r\n          console.warn('BtcSwap: cant withdraw', 'Generated TX not found')\r\n          reject('TX not found. Try it later. ' + txRaw.txId)\r\n        }\r\n      }\r\n      catch (error) {\r\n        console.warn('BtcSwap: cant withdraw', error.message)\r\n\r\n        let errorMessage\r\n\r\n        if (error.res && /non-final/.test(error.res.text)) {\r\n          errorMessage = 'Try it later'\r\n        } else if (/Total less than fee/.test(error.message)) {\r\n          if (/Total less than fee: 0/.test(error.message)) {\r\n            errorMessage = 'Address is empty'\r\n          } else {\r\n            errorMessage = 'Less than fee'\r\n          }\r\n        } else {\r\n          errorMessage = error\r\n        }\r\n\r\n        reject(errorMessage)\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param {string} txID\r\n   * @returns {Promise}\r\n   */\r\n  async checkTX(txID) {\r\n    console.log('check tx')\r\n    const txInfo = await this.fetchTxInfo(txID)\r\n    console.log('txInfo', txInfo)\r\n    if (txInfo\r\n      && txInfo.senderAddress\r\n      && txInfo.txid\r\n      && (txInfo.txid.toLowerCase() == txID.toLowerCase())\r\n    ) {\r\n      return true\r\n    }\r\n    return false\r\n  }\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @param {function} handleTransactionHash\r\n   * @param {string} hashName\r\n   * @returns {Promise}\r\n   */\r\n  refund(data: any, hashName?: string) {\r\n    return this.withdraw(data, true, hashName)\r\n  }\r\n\r\n\r\n  async withdrawFromSwap({\r\n    flow,\r\n  }: {\r\n    flow: any,\r\n  }) {\r\n    const utxoClass = this\r\n    const coin = this._swapName.toLowerCase()\r\n\r\n    await util.helpers.repeatAsyncUntilResult((stopRepeat) => {\r\n      const {\r\n        secret,\r\n        utxoScriptValues: scriptValues,\r\n        [`${coin}SwapWithdrawTransactionHash`]: swapWithdrawTransactionHash,\r\n      } = flow.state\r\n\r\n      if (swapWithdrawTransactionHash) {\r\n        return true\r\n      }\r\n\r\n      if (!scriptValues) {\r\n        console.error(`There is no \"utxoScriptValues\" in state. No way to continue swap...`)\r\n        return null\r\n      }\r\n\r\n      return flow.btcSwap.withdraw({\r\n        scriptValues,\r\n        secret,\r\n        destinationAddress: flow.swap.destinationBuyAddress,\r\n      })\r\n        .then((hash) => {\r\n          console.log('withdraw hash', hash)\r\n          flow.setState({\r\n            [`${coin}SwapWithdrawTransactionHash`]: hash,\r\n          }, true)\r\n          return true\r\n        })\r\n        .catch((error) => null)\r\n    })\r\n\r\n    flow.finishStep({\r\n      [`is${coin}Withdrawn`]: true,\r\n    }, { step: `withdraw-utxo` })\r\n  }\r\n}\r\n\r\n\r\nexport default UTXOBlockchain\r\n"]}]}